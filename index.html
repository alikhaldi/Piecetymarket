<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Piecety - March√© des Pi√®ces Auto en Alg√©rie</title>
    <meta name="description" content="Achetez et vendez des pi√®ces automobiles en Alg√©rie avec Piecety, le march√© fiable pour les pi√®ces neuves et d'occasion.">
    <meta name="keywords" content="pi√®ces auto, Alg√©rie, march√© automobile, Piecety, Hassi R'Mel">

    <meta property="og:title" content="Piecety - March√© des Pi√®ces Auto en Alg√©rie">
    <meta property="og:description" content="Trouvez des pi√®ces auto neuves et d'occasion en Alg√©rie sur Piecety.">
    <meta property="og:image" content="./icons/car-512.png">
    <meta property="og:url" content="https://alikhaldi.github.io/Piecetymarket/">
    
    <meta name="twitter:card" content="summary_large_image">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöó</text></svg>">
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <link rel="stylesheet" href="style.css" />
</head>
<body class="flex flex-col min-h-screen text-gray-800 dark:text-gray-200">

<div id="message-box" class="fixed top-5 right-5 z-[1000] p-4 rounded-lg shadow-lg transition-all duration-500 ease-in-out opacity-0 translate-x-full max-w-sm break-words"></div>

<header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50" role="banner">
    <div class="container mx-auto p-4 flex items-center justify-between">
        <a href="#" id="home-link" class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400 logo transition-transform hover:scale-105 flex items-center">
            <svg class="h-8 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.92,7.62A1,1,0,0,0,21,7H18.32a3,3,0,0,0-5.64,0H3a1,1,0,0,0-1,1V17a1,1,0,0,0,1,1H4.2a3,3,0,0,0,5.6,0H16.2a3,3,0,0,0,5.6,0H23a1,1,0,0,0,1-1V8.62A1,1,0,0,0,21.92,7.62ZM6,15a1,1,0,1,1,1-1A1,1,0,0,1,6,15Zm12,0a1,1,0,1,1,1-1A1,1,0,0,1,18,15Z"></path></svg>
            Piecety
        </a>

        <div class="flex-1 mx-4 sm:mx-8">
            <div class="relative">
                <input id="search-input" type="text" placeholder="Rechercher une pi√®ce..." class="w-full p-3 pl-10 rounded-full border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 shadow-inner" aria-label="Rechercher une pi√®ce" />
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <nav class="hidden md:flex items-center space-x-4" role="navigation" aria-label="Main navigation">
             <div class="relative group">
                <button id="lang-dropdown-btn" aria-haspopup="true" aria-expanded="false" class="flex items-center space-x-1 p-3 font-medium text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-200">
                    <span id="current-lang" class="lang-text">FR</span>
                    <i class="fas fa-chevron-down text-xs"></i>
                </button>
                <div id="lang-dropdown" class="absolute right-0 mt-2 w-28 bg-white dark:bg-gray-700 rounded-lg shadow-lg py-1 hidden transition-all duration-300 z-10" role="menu" aria-label="Select Language">
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-600 dark:hover:text-blue-300 lang-btn" data-lang="fr" role="menuitem">Fran√ßais</button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-600 dark:hover:text-blue-300 lang-btn" data-lang="en" role="menuitem">English</button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-600 dark:hover:text-blue-300 lang-btn" data-lang="ar" role="menuitem">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
                </div>
            </div>

            <button id="dark-mode-toggle" class="p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none" aria-label="Toggle Dark Mode">
                <i class="fas fa-moon text-xl"></i>
            </button>
            <a href="#" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 font-medium transition-colors duration-200" data-i18n-key="sell" id="sell-link">Vendre</a>
            
            <button id="cart-btn" class="relative p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none" aria-label="Shopping Cart">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
            </button>
            
            <div id="auth-links" class="flex items-center space-x-4"></div>
        </nav>

        <button id="mobile-menu-btn" class="md:hidden p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none" aria-label="Menu" aria-expanded="false" aria-controls="mobile-menu">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>
</header>

<div id="mobile-menu" class="fixed inset-0 bg-white dark:bg-gray-900 z-40 hidden flex-col p-6 space-y-6 md:hidden" role="dialog" aria-modal="true" aria-labelledby="mobile-menu-label">
    <div class="flex justify-between items-center">
        <h2 id="mobile-menu-label" class="text-2xl font-bold text-blue-600 dark:text-blue-400" data-i18n-key="menu">Menu</h2>
        <button id="mobile-menu-close-btn" class="p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400" aria-label="Fermer menu">
            <i class="fas fa-times text-2xl"></i>
        </button>
    </div>
    <div id="mobile-nav-links" class="flex flex-col space-y-4"></div>
    <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300" data-i18n-key="language">Langue</h3>
        <div class="flex space-x-4 mt-2">
            <button class="p-2 border dark:border-gray-600 rounded-md text-sm font-medium lang-btn" data-lang="fr">Fran√ßais</button>
            <button class="p-2 border dark:border-gray-600 rounded-md text-sm font-medium lang-btn" data-lang="en">English</button>
            <button class="p-2 border dark:border-gray-600 rounded-md text-sm font-medium lang-btn" data-lang="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
        </div>
    </div>
</div>

<div id="mobile-filters-modal" class="fixed top-0 right-0 h-full w-full max-w-md bg-white dark:bg-gray-900 z-[60] shadow-xl p-6 transform translate-x-full md:hidden">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold" data-i18n-key="filters_title">Filtrer les annonces</h2>
        <button id="mobile-filters-close-btn" class="p-2" aria-label="Close filters">
            <i class="fas fa-times text-2xl"></i>
        </button>
    </div>
    <div id="mobile-filters-content" class="h-[calc(100%-100px)] overflow-y-auto"></div>
    <div class="absolute bottom-0 left-0 w-full p-4 bg-white dark:bg-gray-900 border-t dark:border-gray-700">
        <button id="mobile-apply-filters-btn" class="w-full px-6 py-3 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md" data-i18n-key="apply_filters">Appliquer les filtres</button>
    </div>
</div>


<main id="app-container" class="flex-1 container mx-auto p-4 md:p-8" role="main" aria-live="polite"></main>

<footer class="bg-gray-800 dark:bg-gray-900 text-white p-6 md:p-8 mt-auto text-center">
    <div class="flex justify-center space-x-6 mb-4">
        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-facebook-f text-xl"></i></a>
        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-instagram text-xl"></i></a>
        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-twitter text-xl"></i></a>
    </div>
    <p class="text-sm font-light">
        &copy; <span id="current-year"></span> Piecety - March√© des Pi√®ces Auto en Alg√©rie.<br>
        <span class="text-xs" data-i18n-key="footer_location_text">Fi√®rement au service de Hassi R'Mel et de toute l'Alg√©rie.</span>
    </p>
    <p class="text-xs mt-2 text-gray-400"><a href="#" class="hover:underline">Contact Us</a> | <a href="#" class="hover:underline">Terms of Service</a></p>
</footer>

<div id="post-product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 invisible opacity-0" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] flex flex-col">
        <div class="overflow-y-auto p-6 relative">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-600 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 focus:outline-none" aria-label="Fermer le formulaire">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h3 id="modal-title" class="text-2xl font-bold mb-6 text-center" data-i18n-key="submit_ad">Soumettre une annonce rapide</h3>
            <form id="post-product-form" class="space-y-4" novalidate>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="product-title" class="block font-medium mb-1" data-i18n-key="ad_title_label">Titre de la pi√®ce <span class="text-red-500">*</span></label>
                        <input type="text" id="product-title" name="title" required placeholder="Ex: Disque de frein avant" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="title-error" />
                        <p id="title-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="assertive">Veuillez entrer un titre valide.</p>
                    </div>
                    <div>
                        <label for="product-brand" class="block font-medium mb-1" data-i18n-key="brand_label">Marque <span class="text-red-500">*</span></label>
                        <select id="product-brand" name="brand" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="brand-error">
                            <option value="" data-i18n-key="select_brand">S√©lectionnez une marque</option>
                        </select>
                        <p id="brand-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="assertive">Veuillez s√©lectionner une marque.</p>
                    </div>
                    <div>
                        <label for="product-model" class="block font-medium mb-1" data-i18n-key="model_label">Mod√®le</label>
                        <select id="product-model" name="model" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <option value="" data-i18n-key="select_model">S√©lectionnez un mod√®le</option>
                        </select>
                    </div>
                    <div>
                        <label for="product-year" class="block font-medium mb-1" data-i18n-key="year_label">Ann√©e</label>
                        <select id="product-year" name="year" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" data-i18n-key="select_year">S√©lectionnez une ann√©e</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="product-wilaya" class="block font-medium mb-1" data-i18n-key="wilaya_label">Wilaya <span class="text-red-500">*</span></label>
                        <select id="product-wilaya" name="wilaya" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="wilaya-error">
                            <option value="" data-i18n-key="select_wilaya">S√©lectionnez une wilaya</option>
                        </select>
                        <p id="wilaya-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="assertive">Veuillez s√©lectionner une wilaya.</p>
                    </div>
                    <div>
                        <label for="product-commune" class="block font-medium mb-1" data-i18n-key="commune_label">Commune</label>
                        <select id="product-commune" name="commune" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <option value="" data-i18n-key="select_commune">S√©lectionnez une commune</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="product-category" class="block font-medium mb-1" data-i18n-key="category_label">Cat√©gorie <span class="text-red-500">*</span></label>
                        <select id="product-category" name="category" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="category-error">
                             <option value="" data-i18n-key="select_category">S√©lectionnez une cat√©gorie</option>
                        </select>
                        <p id="category-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="assertive">Veuillez s√©lectionner une cat√©gorie.</p>
                    </div>
                    <div>
                        <label for="product-condition" class="block font-medium mb-1" data-i18n-key="condition_label">√âtat</label>
                        <select id="product-condition" name="condition" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="new" data-i18n-key="new">Neuf</option>
                            <option value="used" data-i18n-key="used">Occasion</option>
                        </select>
                    </div>
                    <div>
                        <label for="product-price" class="block font-medium mb-1" data-i18n-key="price_label">Prix (DA) <span class="text-red-500">*</span></label>
                        <input type="number" id="product-price" name="price" min="0" required placeholder="Ex: 15000" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="price-error" />
                        <p id="price-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="assertive">Veuillez entrer un prix valide.</p>
                    </div>
                </div>
                <div>
                    <label for="product-description" class="block font-medium mb-1" data-i18n-key="description_label">Description</label>
                    <textarea id="product-description" name="description" rows="3" placeholder="Informations suppl√©mentaires..." class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" id="submit-ad-btn" class="mt-4 px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md flex items-center justify-center disabled:bg-blue-400 disabled:cursor-not-allowed">
                        <span class="btn-text" data-i18n-key="submit_ad_btn_text">Soumettre</span>
                        <svg class="animate-spin ml-3 h-5 w-5 text-white hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="auth-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 invisible opacity-0" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-sm w-full p-6 relative">
        <button id="auth-modal-close-btn" class="absolute top-4 right-4 text-gray-600 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 focus:outline-none" aria-label="Fermer le formulaire de connexion">
            <i class="fas fa-times text-2xl"></i>
        </button>
        <h3 id="auth-modal-title" class="text-2xl font-bold mb-6 text-center" data-i18n-key="connect">Se connecter</h3>
        <div class="space-y-4">
            <p class="text-center text-gray-600 dark:text-gray-400" data-i18n-key="login_text">Connectez-vous pour acc√©der √† toutes les fonctionnalit√©s.</p>
            <button id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-gray-700 dark:text-gray-200 font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200 shadow-sm">
                <i class="fab fa-google text-xl mr-2"></i>
                <span data-i18n-key="google_login">Se connecter avec Google</span>
            </button>
        </div>
    </div>
</div>

<template id="home-view-template">
    <section class="text-center py-12 md:py-20 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg mb-8 md:mb-12">
        <h1 class="text-3xl md:text-5xl font-extrabold mb-4" data-i18n-key="hero_title">Trouvez la bonne pi√®ce pour votre voiture</h1>
        <p class="text-lg md:text-xl font-light mb-8 max-w-3xl mx-auto" data-i18n-key="hero_subtitle">Le march√© alg√©rien des pi√®ces automobiles le plus fiable.</p>
    </section>

    <section class="mb-8 md:mb-12" aria-labelledby="categories-title-heading">
        <div id="breadcrumb-nav" class="mb-4 text-sm text-gray-500 dark:text-gray-400"></div>
        <h2 id="categories-title-heading" class="text-2xl md:text-3xl font-bold mb-6 text-center"></h2>
        <div id="dynamic-grid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4 md:gap-6"></div>
    </section>

    <div class="flex flex-col md:flex-row gap-8">
        <aside id="filters-sidebar" class="w-full md:w-1/4 lg:w-1/5 md:block hidden">
             <div id="filters-content" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 space-y-6"></div>
        </aside>

        <section class="w-full md:w-3/4 lg:w-4/5">
             <div class="flex justify-between items-center mb-6">
                <button id="show-filters-btn" class="md:hidden w-full px-6 py-3 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-md font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200 shadow-md" data-i18n-key="show_filters">
                    Afficher les filtres
                </button>
            </div>
            <div id="listings-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </section>
    </div>
</template>

<template id="filters-template">
    <h2 class="text-2xl font-bold mb-4" data-i18n-key="filters_title">Filtrer les annonces</h2>
    <div>
        <label for="brand-filter" class="block text-sm font-medium" data-i18n-key="brand_label">Marque</label>
        <select id="brand-filter" class="filter mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="all_brands">Toutes les marques</option>
        </select>
    </div>
    <div id="model-filter-container" class="hidden">
        <label for="model-filter" class="block text-sm font-medium" data-i18n-key="model_label">Mod√®le</label>
        <select id="model-filter" class="filter mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="all_models">Tous les mod√®les</option>
        </select>
    </div>
    <div>
        <label for="year-filter" class="block text-sm font-medium" data-i18n-key="year_label">Ann√©e</label>
        <select id="year-filter" class="filter mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="all_years">Toutes ann√©es</option>
        </select>
    </div>
    <div>
        <label for="wilaya-filter" class="block text-sm font-medium" data-i18n-key="wilaya_label">Wilaya</label>
        <select id="wilaya-filter" class="filter mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="all_wilayas">Toutes wilayas</option>
        </select>
    </div>
    <div id="commune-filter-container" class="hidden">
        <label for="commune-filter" class="block text-sm font-medium" data-i18n-key="commune_label">Commune</label>
        <select id="commune-filter" class="filter mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="all_communes">Toutes communes</option>
        </select>
    </div>
    <div>
        <label for="category-filter" class="block text-sm font-medium" data-i18n-key="category_label">Cat√©gorie</label>
        <select id="category-filter" class="filter mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
             <option value="" data-i18n-key="all_categories">Toutes cat√©gories</option>
        </select>
    </div>
    <div>
        <label for="condition-filter" class="block text-sm font-medium" data-i18n-key="condition_label">√âtat</label>
        <select id="condition-filter" class="filter mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="any_condition">Tout</option>
            <option value="new" data-i18n-key="new">Neuf</option>
            <option value="used" data-i18n-key="used">Occasion</option>
        </select>
    </div>
    <div>
        <label for="price-range-filter" class="block text-sm font-medium" data-i18n-key="price_range">Gamme de prix</label>
        <input type="range" id="price-range-filter" min="0" max="100000" step="1000" class="filter w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
            <span>0 DA</span>
            <span id="price-range-value">50000 DA</span>
            <span>100k+ DA</span>
        </div>
    </div>

    <div class="mt-6 flex flex-col space-y-4">
        <button id="filter-reset-btn" class="w-full px-6 py-3 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-md font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors duration-200 shadow-md" data-i18n-key="reset">R√©initialiser</button>
    </div>
</template>

<template id="product-detail-view-template">
    <div id="product-detail" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 md:p-8">
        <button id="back-to-listings-btn" class="mb-4 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_listings">Retour aux annonces</span>
        </button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <img id="product-image-detail" src="" alt="" class="w-full h-80 md:h-96 object-cover rounded-lg shadow-md" />
            <div>
                <h2 id="product-title-detail" class="text-2xl md:text-3xl font-bold mb-2"></h2>
                <p id="product-price-detail" class="text-blue-600 dark:text-blue-400 font-bold text-2xl mb-4"></p>
                <div class="space-y-2 text-sm mb-6 border-t border-b dark:border-gray-700 py-4">
                    <p><strong><span data-i18n-key="brand_label">Marque</span>:</strong> <span id="product-brand-detail"></span></p>
                    <p><strong><span data-i18n-key="model_label">Mod√®le</span>:</strong> <span id="product-model-detail"></span></p>
                    <p><strong><span data-i18n-key="year_label">Ann√©e</span>:</strong> <span id="product-year-detail"></span></p>
                    <p><strong><span data-i18n-key="wilaya_label">Wilaya</span>:</strong> <span id="product-wilaya-detail"></span></p>
                    <p><strong><span data-i18n-key="commune_label">Commune</span>:</strong> <span id="product-commune-detail"></span></p>
                    <p><strong>Vendu par:</strong> <a href="#" id="seller-profile-link" class="text-blue-600 dark:text-blue-400 hover:underline"></a></p>
                </div>
                <p id="product-description-detail" class="leading-relaxed mb-6"></p>
                <div class="flex flex-col space-y-3">
                     <button id="add-to-cart-btn" class="w-full px-6 py-3 bg-green-600 text-white rounded-full font-semibold hover:bg-green-700 transition-colors duration-200 shadow-md flex items-center justify-center">
                        <i class="fas fa-cart-plus mr-2"></i>
                        <span data-i18n-key="add_to_cart">Ajouter au panier</span>
                    </button>
                    <button id="contact-seller-btn" class="w-full px-6 py-3 bg-gray-600 text-white rounded-full font-semibold hover:bg-gray-700 transition-colors duration-200 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">
                        <i class="fas fa-comments mr-2"></i>
                        <span data-i18n-key="contact_seller">Contacter le vendeur</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="cart-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <button id="back-from-cart-btn" class="mb-4 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_listings">Retour aux annonces</span>
        </button>
        <div class="flex justify-between items-center mb-6">
             <h2 class="text-2xl md:text-3xl font-bold" data-i18n-key="cart_title">Mon panier</h2>
             <button id="clear-cart-btn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md font-semibold hover:bg-red-700 transition-colors duration-200 shadow-md" data-i18n-key="clear_cart">
                Vider le panier
            </button>
        </div>
        <div id="cart-items-container" class="space-y-4"></div>
        <div id="cart-summary" class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
            <p class="text-xl font-bold flex justify-between">
                <span data-i18n-key="cart_total">Total</span>:
                <span id="cart-total-price">0 DA</span>
            </p>
            <button id="checkout-btn" class="w-full mt-4 px-6 py-3 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition-colors duration-200 shadow-md">
                <span data-i18n-key="checkout_btn">Passer √† la caisse</span>
            </button>
        </div>
    </div>
</template>

<template id="dashboard-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl md:text-3xl font-bold mb-6">Mon Tableau de Bord</h2>
        <div id="dashboard-content">
            <h3 class="text-xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Mes Annonces</h3>
            <div id="my-listings-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
    </div>
</template>

<template id="profile-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <div class="flex flex-col md:flex-row items-center md:items-start text-center md:text-left">
            <i class="fas fa-user-circle text-6xl md:text-8xl text-gray-300 md:mr-6 mb-4 md:mb-0"></i>
            <div>
                <h2 id="profile-name" class="text-2xl md:text-3xl font-bold">Nom du vendeur</h2>
                <div id="profile-rating" class="flex items-center justify-center md:justify-start text-yellow-500 mt-2">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i>
                    <span class="text-gray-600 dark:text-gray-400 ml-2 text-sm">(Avis bient√¥t disponibles)</span>
                </div>
            </div>
        </div>
        
        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Annonces de ce vendeur</h3>
            <div id="user-products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
        
        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Avis des acheteurs</h3>
            <div id="user-reviews-list" class="space-y-4">
                <p class="text-gray-500 dark:text-gray-400">La fonctionnalit√© d'avis sera bient√¥t disponible.</p>
            </div>
        </div>
    </div>
</template>

<template id="inbox-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl md:text-3xl font-bold mb-6">My Messages</h2>
        <div id="conversations-list" class="space-y-4">
            <p id="inbox-loading" class="text-center text-gray-500">Loading conversations...</p>
        </div>
    </div>
</template>

<template id="chat-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6 h-[75vh] flex flex-col">
        <div class="flex items-center border-b dark:border-gray-700 pb-4 mb-4">
            <button id="back-to-inbox-btn" class="mr-4 text-blue-600 dark:text-blue-400">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 id="chat-with-name" class="text-xl font-bold">Chat</h2>
        </div>
        
        <div id="messages-container" class="flex-1 overflow-y-auto space-y-4 p-2 flex flex-col">
            </div>

        <form id="send-message-form" class="mt-4 flex gap-4 border-t dark:border-gray-700 pt-4">
            <input type="text" id="message-input" placeholder="Type a message..." class="flex-1 p-3 rounded-full border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <button type="submit" class="bg-blue-600 text-white rounded-full w-12 h-12 flex-shrink-0 flex items-center justify-center">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</template>


<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, where, getDocs, doc, setDoc, getDoc, deleteDoc, writeBatch, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    // Global state variables
    let currentUser = null;
    let currentLang = localStorage.getItem("piecety_lang") || "fr";
    let currentView = 'home';
    let allProducts = [];
    let userCart = {};
    let productsUnsubscribe = null;

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBIptEskV2soajxRYPDfwYFYyz9pWQvZL0",
        authDomain: "piecety-app-b39c4.firebaseapp.com",
        projectId: "piecety-app-b39c4",
        storageBucket: "piecety-app-b39c4.appspot.com",
        messagingSenderId: "265795860915",
        appId: "1:265795860915:web:aa10241788cce42f6373c6"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Translations
    const translations = {
        fr: {
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "Menu", sell: "Vendre", connect: "Se connecter", language: "Langue", logout: "D√©connexion", dashboard: "Tableau de Bord",
            hero_title: "Trouvez la bonne pi√®ce pour votre voiture",
            hero_subtitle: "Le march√© alg√©rien des pi√®ces automobiles le plus fiable.",
            categories_title: "Cat√©gories de Pi√®ces",
            brands_title: "S√©lectionnez une Marque",
            years_title: "S√©lectionnez une Ann√©e",
            category_engine: "Moteur", category_brakes: "Freins", category_fuel_system: "Syst√®me de carburant",
            category_cooling: "Refroidissement", category_tires: "Pneus & Jantes", category_electrical: "√âlectrique",
            category_body: "Carrosserie", category_tools: "Outillage",
            filters_title: "Filtrer les annonces", all_brands: "Toutes les marques", all_models: "Tous les mod√®les",
            all_years: "Toutes ann√©es", all_wilayas: "Toutes wilayas", all_communes: "Toutes communes",
            condition: "√âtat", any_condition: "Tout", new: "Neuf", used: "Occasion",
            apply_filters: "Appliquer les filtres", reset: "R√©initialiser",
            search_placeholder: "Rechercher une pi√®ce...",
            footer_location_text: "Fi√®rement au service de Hassi R'Mel et de toute l'Alg√©rie.",
            submit_ad: "Soumettre une annonce rapide", ad_title_label: "Titre de la pi√®ce", brand_label: "Marque",
            select_brand: "S√©lectionnez une marque", model_label: "Mod√®le", select_model: "S√©lectionnez un mod√®le",
            year_label: "Ann√©e", select_year: "S√©lectionnez une ann√©e", wilaya_label: "Wilaya",
            select_wilaya: "S√©lectionnez une wilaya", commune_label: "Commune", select_commune: "S√©lectionnez une commune",
            condition_label: "√âtat", price_label: "Prix (DA)", description_label: "Description",
            image_label: "Image", submit_ad_btn_text: "Soumettre", loading_text: "Envoi...",
            login_text: "Connectez-vous pour acc√©der √† toutes les fonctionnalit√©s.", google_login: "Se connecter avec Google",
            back_to_listings: "Retour aux annonces", add_to_cart: "Ajouter au panier",
            cart_title: "Mon panier", cart_total: "Total", checkout_btn: "Passer √† la caisse",
            no_listings: "Aucune annonce trouv√©e.",
            your_cart_is_empty: "Votre panier est vide.",
            remove: "Supprimer", quantity: "Quantit√©", item_total: "Total de l'article",
            login_required: "Veuillez vous connecter pour utiliser cette fonctionnalit√©.", dashboard_link_mobile: "Mon Tableau de Bord",
            show_filters: "Afficher les filtres", price_range: "Gamme de prix", all_categories: "Toutes cat√©gories",
            category_label: "Cat√©gorie", select_category: "S√©lectionnez une cat√©gorie", contact_seller: "Contacter le vendeur",
            clear_cart: "Vider le panier", favorite_added: "Ajout√© aux favoris", favorite_removed: "Retir√© des favoris",
            ad_posted: "Votre annonce a √©t√© publi√©e avec succ√®s !", ad_post_failed: "√âchec de la publication de l'annonce.",
            item_added_to_cart: "Article ajout√© au panier!", delete_ad_confirm: "√ätes-vous s√ªr de vouloir supprimer cette annonce ?",
        },
        en: {
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "Menu", sell: "Sell", connect: "Log In", language: "Language", logout: "Logout", dashboard: "Dashboard",
            hero_title: "Find the right car part for your vehicle",
            hero_subtitle: "The most trusted Algerian car parts marketplace.",
            categories_title: "Parts Categories",
            brands_title: "Select a Brand",
            years_title: "Select a Year",
            category_engine: "Engine", category_brakes: "Brakes", category_fuel_system: "Fuel System",
            category_cooling: "Cooling", category_tires: "Tires & Rims", category_electrical: "Electrical",
            category_body: "Body", category_tools: "Tools",
            filters_title: "Filter Listings", all_brands: "All brands", all_models: "All models",
            all_years: "All years", all_wilayas: "All wilayas", all_communes: "All communes",
            condition: "Condition", any_condition: "Any", new: "New", used: "Used",
            apply_filters: "Apply Filters", reset: "Reset",
            search_placeholder: "Search for a part...",
            footer_location_text: "Proudly serving Hassi R'Mel and all of Algeria.",
            submit_ad: "Submit a quick ad", ad_title_label: "Part Title", brand_label: "Brand",
            select_brand: "Select a brand", model_label: "Model", select_model: "Select a model",
            year_label: "Year", select_year: "Select a year", wilaya_label: "Wilaya",
            select_wilaya: "Select a wilaya", commune_label: "Commune", select_commune: "Select a commune",
            condition_label: "Condition", price_label: "Price (DA)", description_label: "Description",
            image_label: "Image", submit_ad_btn_text: "Submit", loading_text: "Submitting...",
            login_text: "Log in to access all features.", google_login: "Sign in with Google",
            back_to_listings: "Back to listings", add_to_cart: "Add to cart",
            cart_title: "My Cart", cart_total: "Total", checkout_btn: "Proceed to Checkout",
            no_listings: "No listings found.",
            your_cart_is_empty: "Your cart is empty.",
            remove: "Remove", quantity: "Quantity", item_total: "Item Total",
            login_required: "Please log in to use this feature.", dashboard_link_mobile: "My Dashboard",
            show_filters: "Show Filters", price_range: "Price Range", all_categories: "All Categories",
            category_label: "Category", select_category: "Select a category", contact_seller: "Contact Seller",
            clear_cart: "Clear Cart", favorite_added: "Added to favorites", favorite_removed: "Removed from favorites",
            ad_posted: "Your ad has been posted successfully!", ad_post_failed: "Failed to post ad.",
            item_added_to_cart: "Item added to cart!", delete_ad_confirm: "Are you sure you want to delete this ad?",
        },
        ar: {
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "ÿßŸÑŸÇÿßÿ¶ŸÖÿ©", sell: "ÿ®Ÿäÿπ", connect: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ", language: "ÿßŸÑŸÑÿ∫ÿ©", logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨", dashboard: "ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ",
            hero_title: "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÇÿ∑ÿπÿ© ÿßŸÑÿ∫Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ© ŸÑÿ≥Ÿäÿßÿ±ÿ™ŸÉ",
            hero_subtitle: "ÿ£ŸÉÿ´ÿ± ÿ£ÿ≥ŸàÿßŸÇ ŸÇÿ∑ÿπ ÿ∫Ÿäÿßÿ± ÿßŸÑÿ≥Ÿäÿßÿ±ÿßÿ™ ÿ´ŸÇÿ© ŸÅŸä ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±.",
            categories_title: "ŸÅÿ¶ÿßÿ™ ÿßŸÑŸÇÿ∑ÿπ",
            brands_title: "ÿßÿÆÿ™ÿ± ŸÖÿßÿ±ŸÉÿ©",
            years_title: "ÿßÿÆÿ™ÿ± ÿ≥ŸÜÿ©",
            category_engine: "ŸÖÿ≠ÿ±ŸÉ", category_brakes: "ŸÖŸÉÿßÿ®ÿ≠", category_fuel_system: "ŸÜÿ∏ÿßŸÖ ÿßŸÑŸàŸÇŸàÿØ",
            category_cooling: "ÿßŸÑÿ™ÿ®ÿ±ŸäÿØ", category_tires: "ÿßŸÑÿ•ÿ∑ÿßÿ±ÿßÿ™ ŸàÿßŸÑÿπÿ¨ŸÑÿßÿ™", category_electrical: "ŸÉŸáÿ±ÿ®ÿßÿ¶Ÿä",
            category_body: "ŸáŸäŸÉŸÑ", category_tools: "ÿ£ÿØŸàÿßÿ™",
            filters_title: "ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™", all_brands: "ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿßÿ±ŸÉÿßÿ™", all_models: "ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿØŸäŸÑÿßÿ™",
            all_years: "ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ŸÜŸàÿßÿ™", all_wilayas: "ÿ¨ŸÖŸäÿπ ÿßŸÑŸàŸÑÿßŸäÿßÿ™", all_communes: "ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸÑÿØŸäÿßÿ™",
            condition: "ÿßŸÑÿ≠ÿßŸÑÿ©", any_condition: "ÿßŸÑŸÉŸÑ", new: "ÿ¨ÿØŸäÿØ", used: "ŸÖÿ≥ÿ™ÿπŸÖŸÑ",
            apply_filters: "ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅŸÑÿßÿ™ÿ±", reset: "ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ",
            search_placeholder: "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÇÿ∑ÿπÿ©...",
            footer_location_text: "ÿ®ŸÉŸÑ ŸÅÿÆÿ± ŸÅŸä ÿÆÿØŸÖÿ© ÿ≠ÿßÿ≥Ÿä ÿßŸÑÿ±ŸÖŸÑ Ÿà ŸÉŸÑ ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±.",
            submit_ad: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿπŸÑÿßŸÜ ÿ≥ÿ±Ÿäÿπ", ad_title_label: "ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÇÿ∑ÿπÿ©", brand_label: "ÿßŸÑŸÖÿßÿ±ŸÉÿ©",
            select_brand: "ÿßÿÆÿ™ÿ± ŸÖÿßÿ±ŸÉÿ©", model_label: "ÿßŸÑŸÖŸàÿØŸäŸÑ", select_model: "ÿßÿÆÿ™ÿ± ŸÖŸàÿØŸäŸÑ",
            year_label: "ÿßŸÑÿ≥ŸÜÿ©", select_year: "ÿßÿÆÿ™ÿ± ÿ≥ŸÜÿ©", wilaya_label: "ÿßŸÑŸàŸÑÿßŸäÿ©",
            select_wilaya: "ÿßÿÆÿ™ÿ± ŸàŸÑÿßŸäÿ©", commune_label: "ÿßŸÑÿ®ŸÑÿØŸäÿ©", select_commune: "ÿßÿÆÿ™ÿ± ÿ®ŸÑÿØŸäÿ©",
            condition_label: "ÿßŸÑÿ≠ÿßŸÑÿ©", price_label: "ÿßŸÑÿ≥ÿπÿ± (ÿØÿ¨)", description_label: "ÿßŸÑŸàÿµŸÅ",
            image_label: "ÿßŸÑÿµŸàÿ±ÿ©", submit_ad_btn_text: "ÿ•ÿ±ÿ≥ÿßŸÑ", loading_text: "ÿ¨ÿßÿ± ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...",
            login_text: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸäÿ≤ÿßÿ™.", google_login: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Google",
            back_to_listings: "ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™", add_to_cart: "ÿ£ÿ∂ŸÅ ÿ•ŸÑŸâ ÿßŸÑÿ≥ŸÑÿ©",
            cart_title: "ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ", cart_total: "ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä", checkout_btn: "ÿßŸÑÿØŸÅÿπ",
            no_listings: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ•ÿπŸÑÿßŸÜÿßÿ™.",
            your_cart_is_empty: "ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ ŸÅÿßÿ±ÿ∫ÿ©.",
            remove: "ÿ≠ÿ∞ŸÅ", quantity: "ÿßŸÑŸÉŸÖŸäÿ©", item_total: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ŸÑÿπÿ©",
            login_required: "Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ©.", dashboard_link_mobile: "ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ",
            show_filters: "ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÅŸÑÿßÿ™ÿ±", price_range: "ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ≥ÿπÿ±", all_categories: "ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ¶ÿßÿ™",
            category_label: "ÿßŸÑŸÅÿ¶ÿ©", select_category: "ÿßÿÆÿ™ÿ± ŸÅÿ¶ÿ©", contact_seller: "ÿßÿ™ÿµŸÑ ÿ®ÿßŸÑÿ®ÿßÿ¶ÿπ",
            clear_cart: "ÿ•ŸÅÿ±ÿßÿ∫ ÿßŸÑÿ≥ŸÑÿ©", favorite_added: "ÿ£ÿ∂ŸäŸÅÿ™ ÿ•ŸÑŸâ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©", favorite_removed: "ÿ£ÿ≤ŸäŸÑÿ™ ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©",
            ad_posted: "ÿ™ŸÖ ŸÜÿ¥ÿ± ÿ•ÿπŸÑÿßŸÜŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!", ad_post_failed: "ŸÅÿ¥ŸÑ ŸÜÿ¥ÿ± ÿßŸÑÿ•ÿπŸÑÿßŸÜ.",
            item_added_to_cart: "ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ•ŸÑŸâ ÿßŸÑÿ≥ŸÑÿ©!", delete_ad_confirm: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿπŸÑÿßŸÜÿü",
        }
    };

    // Data for dynamic dropdowns
    const categories = {
        "engine": { fr: "Moteur", en: "Engine", ar: "ŸÖÿ≠ÿ±ŸÉ", icon: "fa-cogs" },
        "brakes": { fr: "Freins", en: "Brakes", ar: "ŸÖŸÉÿßÿ®ÿ≠", icon: "fa-car" },
        "fuel_system": { fr: "Syst√®me de carburant", en: "Fuel System", ar: "ŸÜÿ∏ÿßŸÖ ÿßŸÑŸàŸÇŸàÿØ", icon: "fa-gas-pump" },
        "cooling": { fr: "Refroidissement", en: "Cooling", ar: "ÿßŸÑÿ™ÿ®ÿ±ŸäÿØ", icon: "fa-fan" },
        "tires": { fr: "Pneus & Jantes", en: "Tires & Rims", ar: "ÿßŸÑÿ•ÿ∑ÿßÿ±ÿßÿ™ ŸàÿßŸÑÿπÿ¨ŸÑÿßÿ™", icon: "fa-circle" },
        "electrical": { fr: "√âlectrique", en: "Electrical", ar: "ŸÉŸáÿ±ÿ®ÿßÿ¶Ÿä", icon: "fa-bolt" },
        "body": { fr: "Carrosserie", en: "Body", ar: "ŸáŸäŸÉŸÑ", icon: "fa-car-side" },
        "tools": { fr: "Outillage", en: "Tools", ar: "ÿ£ÿØŸàÿßÿ™", icon: "fa-wrench" },
    };
    const wilayas = {
        "Adrar": ["Adrar", "Charouine", "Tamest", "Reggane", "Aoulef", "Fenoughil", "Timimoun", "Talmine", "Bordj Badji Mokhtar", "In Salah"], 
        "Chlef": ["Chlef", "T√©n√®s", "Ouled Far√®s", "El Marsa", "Abou El Hassan", "Oued Fodda", "Beni Haoua", "El Karimia", "Taougrite", "Harchoun"], 
        "Laghouat": ["A√Øn Madhi", "Aflou", "El Ghicha", "El Houaita", "El Assafia", "Ksar El Hirane", "Laghouat", "Taougrite", "Sidi Makhlouf", "Ouled Far√®s", "Hassi R'Mel"], 
        "Oum El Bouaghi": ["A√Øn Be√Øda", "A√Øn Fekroun", "A√Øn Babouche", "A√Øn M'lila", "Dhala√¢", "F'kirina", "Oum El Bouaghi", "Sidi R'ghiss", "Souk Naamane", "El Fedjoudj"], 
        "Batna": ["A√Øn Touta", "Arris", "Barika", "Batna", "El Madher", "Menaa", "Merouana", "Ras El Aioun", "Timgad", "Ouled Si Slimane"], 
        "B√©ja√Øa": ["A√Øn El Kebira", "Akbou", "B√©ja√Øa", "El Kseur", "Sidi A√Øch", "Tichy", "Toudja", "Aokas", "Ighil Ali", "Darguina"], 
        "Biskra": ["Biskra", "El Kantara", "Sidi Okba", "Ourlal", "Zeribet El Oued", "Tolga", "Sidi Khaled", "Djemorah", "M'chouneche", "El Outaya"], 
        "B√©char": ["B√©char", "Abadla", "Beni Ounif", "Lahmar", "Tabelbala", "Kenadsa", "Igli", "Taghit", "Mechra√¢ Houari Boumediene", "Ouled Khoudir"], 
        "Blida": ["Blida", "Boufarik", "Chebli", "Oued El Alleug", "Larba√¢", "Meftah", "Souma√¢", "Bougara", "Mouzaia", "Chr√©a"], 
        "Bouira": ["Bouira", "Lakhdaria", "Sour El Ghozlane", "Ahnif", "Bir Ghbalou", "Ha√Øzer", "M'chedallah", "El Hachimia", "Sidi A√Øssa", "Taghzout"], 
        "Tamanrasset": ["Tamanrasset", "Abalessa", "Idles", "In Amguel", "Tazrouk", "Tin Zaouatine", "In Guezzam", "Djanet", "Bordj Omar Driss", "Illizi"], 
        "T√©bessa": ["T√©bessa", "Bir El Ater", "Cheria", "El Aouinet", "El Kouif", "El Ma Labiod", "Morsott", "Ouenza", "Bir Mokkadem", "Hammamet"], 
        "Tlemcen": ["Tlemcen", "Ghazaouet", "Maghnia", "Remchi", "Sebdou", "Sidi Djillali", "Hennaya", "Nedroma", "Marsa Ben M'Hidi", "Beni Snous"], 
        "Tiaret": ["Tiaret", "A√Øn Deheb", "Frenda", "Ksar Chellala", "Mahdia", "Rahouia", "Sougueur", "Dahmouni", "Sidi Ali Mellal", "Medroussa"], 
        "Tizi Ouzou": ["Tizi Ouzou", "A√Øn El Hammam", "Azazga", "Bouzegu√®ne", "Dra√¢ Ben Khedda", "Ouacif", "Larba√¢ Nath Irathen", "Tigzirt", "Tizi Gheniff", "Ma√¢tkas"], 
        "Alger": ["Alger", "Bab El Oued", "Baraki", "Bir Mourad Ra√Øs", "Birkhadem", "Bologhine", "Bordj El Kiffan", "Hussein Dey", "Hydra", "Dar El Be√Øda"], 
        "Djelfa": ["Djelfa", "A√Øn Oussera", "Messaad", "Hassi Bahbah", "Had Sahary", "Guettara", "El Idrissia", "Dar Chioukh", "Zaccar", "Faidh El Botma"], 
        "Jijel": ["Jijel", "Taher", "El Milia", "Chekfa", "Ziamamansouria", "Texenna", "Djemaa Beni Habibi", "Sidi Maarouf", "Settara", "Kaous"], 
        "S√©tif": ["S√©tif", "A√Øn Oulmane", "El Eulma", "Bousselam", "Beni Ouartilane", "Bouga√¢", "Salah Bey", "Hammamlou", "Guenzet", "Maouaklane"], 
        "Sa√Øda": ["Sa√Øda", "A√Øn El Hadjar", "Sidi Boubkeur", "Youb", "El Hassasna", "Tircine", "Maamora", "Ouled Brahim", "A√Øn Sekhouna", "Moulay Larbi"], 
        "Skikda": ["Skikda", "A√Øn Bouziane", "Azzaba", "El Harrouch", "Collo", "Filfila", "Ramdane Djamel", "Salah Bouchaour", "Zerdaza", "Beni Oulbane"], 
        "Sidi Bel Abb√®s": ["Sidi Bel Abb√®s", "Sfisef", "Telagh", "Ras El Ma", "Tessala", "A√Øn El Berd", "Boukhanafis", "Ben Badis", "Sidi Chaib", "Moulay Slissen"], 
        "Annaba": ["Annaba", "El Hadjar", "Berrahal", "El Bouni", "Sera√Ødi", "Cheta√Øbi", "Oued El Aneb", "A√Øn El Berda", "Tr√©zel", "Sidi Amar"], 
        "Guelma": ["Guelma", "H√©liopolis", "Oued Zenati", "Bouchegouf", "Ain Reggada", "Tamlouka", "Dkhila", "Bou Hachana", "Belkheir", "Bordj Sabath"], 
        "Constantine": ["Constantine", "El Khroub", "Hamma Bouziane", "A√Øn Smara", "Didouche Mourad", "Zighoud Youcef", "Messaoud Boudjriou", "Beni Hamidane", "Ibn Ziad", "Oued El Hadjar"], 
        "M√©d√©a": ["M√©d√©a", "Berrouaghia", "Chahbounia", "Tablat", "A√Øn Boucif", "Beni Slimane", "El Azizia", "Si Mahdjoub", "Ouzera", "Ksar Boukhari"], 
        "Mostaganem": ["Mostaganem", "Hassi Mameche", "A√Øn T√©del√®s", "Sidi Ali", "Bouguirat", "Achaacha", "Khadra", "Oued El Kheir", "Mazagran", "Foran"], 
        "M'Sila": ["M'Sila", "Bou Sa√¢da", "A√Øn El Melh", "Sidi A√Øssa", "Magra", "M'Cif", "Hammam Dhala√¢", "Ouled Derradj", "Ben Srour", "Ouanougha"], 
        "Mascara": ["Mascara", "Ghriss", "Tighennif", "Sig", "Bou Hanifia", "Oued Taria", "Hachem", "Mohammadia", "El Bordj", "A√Øn Fares"], 
        "Ouargla": ["Ouargla", "Hassi Messaoud", "Rouissat", "N'Goussa", "Sidi Khouiled", "Blidet Amor", "El Borma", "Tebesbest", "Zaouia El Abidia", "Hassi Ben Abdallah"], 
        "Oran": ["Oran", "Arzew", "Bir El Djir", "Es Senia", "Boutl√©lis", "Hassi Bounif", "Oued Tl√©lat", "Sidi Chami", "Gdyel", "A√Øn El Turk"], 
        "El Bayadh": ["El Bayadh", "Bougtob", "Chellala", "Bre√Øna", "Rogassa", "Brezina", "Boussemghoun", "El Kheiter", "Kra√Ør", "Ghassoul"], 
        "Illizi": ["Illizi", "Djanet", "Bordj El Houasse", "Tamanrasset", "In Salah", "Abalessa", "Tazrouk", "Idles", "In Amguel", "Tin Zaouatine"], 
        "Bordj Bou Arr√©ridj": ["Bordj Bou Arr√©ridj", "Ras El Oued", "Mansoura", "Tassameurt", "El Achir", "Medjana", "Bordj Ghedir", "Hammam El Biban", "L'Hassaneia", "Ghassira"], 
        "Boumerd√®s": ["Boumerd√®s", "Dellys", "Boudouaou", "Isser", "B√©ni Amrane", "Naciria", "Corso", "Zemmouri", "R√©gha√Øa", "Tidjelabine"], 
        "El Tarf": ["El Tarf", "Ben M'Hidi", "Besbes", "Drea", "El Kala", "Bougous", "Raml Souk", "Sidi Khelil", "Oued Zitoun", "A√Øn Kerma"], 
        "Tindouf": ["Tindouf", "Oum El Assel"], "Tissemsilt": ["Tissemsilt", "Bordj Bounaama", "Lardjem", "Th√©niet El Had", "Ammi Moussa", "Sidi Boutouchent", "Layoune", "Lazharia", "Bougara", "Bordj Emir Khaled"], 
        "El Oued": ["El Oued", "Guemar", "Hassi Khalifa", "Robbah", "Debila", "Bayadha", "Magrane", "Nakhla", "Kouinine", "El Ogla"], 
        "Khenchela": ["Khenchela", "A√Øn Touila", "Bab El Ain", "Kais", "Yabous", "Chechar", "M'Sara", "Ouled Rechache", "Taouzianat", "Remila"], 
        "Souk Ahras": ["Souk Ahras", "Heddada", "M'daourouch", "Mechrouha", "Ouled Driss", "Taoura", "Zaarouria", "Ouillen", "Sidi Fredj", "Tiffech"], 
        "Tipaza": ["Tipaza", "Cherchell", "Kol√©a", "Fouka", "Hadjout", "Sidi Rached", "Menaceur", "Bou Isma√Øl", "Khemis Miliana", "A√Øn Tagourait"], 
        "Mila": ["Mila", "Bouhatem", "Ferdjioua", "Grarem Gouga", "Tadjenanet", "Sidi Merouane", "Oued Endja", "Teleghma", "Chigara", "Rouached"], 
        "A√Øn Defla": ["A√Øn Defla", "Khemis Miliana", "El Attaf", "A√Øn Torki", "Djelida", "Rouina", "Hammam Righa", "Miliana", "Boumedfaa", "A√Øn Soltane"], 
        "Na√¢ma": ["Na√¢ma", "M√©cheria", "A√Øn Sefra", "Moghrar", "Tiout", "Sfissifa", "Makman Ben Amer", "Asla", "Kasdir", "El Biod"], 
        "A√Øn T√©mouchent": ["A√Øn T√©mouchent", "Hammam Bou Hadjar", "El Malah", "B√©ni Saf", "Aghlal", "Chaabat El Ham", "Oued Berkeche", "Aoubellil", "Bouzedjar", "Tamesna"], 
        "Gharda√Øa": ["Gharda√Øa", "El Guerrara", "Berriane", "Dhayet Bendhahoua", "Metlili", "Zelfana", "Bounoura", "El Atteuf", "Guerrara", "Dra' El Mizan"], 
        "Relizane": ["Relizane", "Oued Rhiou", "Zemmoura", "Sidi M'Hamed Ben Ali", "El H'madna", "Ammi Moussa", "Mazouna", "Mendes", "Ain Tarek", "Oued El Djemaa"], 
        "El M'ghair": ["El M'ghair", "Sidi Amrane", "Djamaa", "Oum Toub", "M'Rara", "Oued Allenda", "Sidi Khelil", "Oued R'hiou", "Sidi Yahia", "Bouchakroun"], 
        "El Meniaa": ["El Meniaa", "Hassi Gara", "Mansourah", "Dhiafat", "El Guerrara", "Tadjmout", "El Hachane", "El Oued", "Chabet El Ami", "Ouled Gacem"]
    };
    const car_data = {
        "Toyota": ["Yaris", "Corolla", "Camry", "Land Cruiser", "Hilux"], "Peugeot": ["208", "308", "301", "2008", "3008", "508"], "Volkswagen": ["Golf", "Polo", "Passat", "Tiguan", "Touareg", "Jetta"], "Renault": ["Clio", "Megane", "Captur", "Duster", "Symbol"], "Hyundai": ["i10", "i20", "Accent", "Tucson", "Santa Fe"], "Nissan": ["Micra", "Sentra", "Qashqai", "X-Trail", "Juke"], "Fiat": ["Panda", "500", "Tipo", "Punto"], "Citro√´n": ["C3", "C4", "Berlingo", "C-Elys√©e"], "Kia": ["Picanto", "Rio", "Sportage", "Sorento"], "Mercedes-Benz": ["A-Class", "C-Class", "E-Class", "GLA", "GLC"]
    };
     const brand_icons = {
        "Toyota": "icons/toyota.png",
        "Peugeot": "icons/peugeot.png",
        "Volkswagen": "icons/volkswagen.png",
        "Renault": "icons/renault.png",
        "Hyundai": "icons/hyundai.png",
        "Nissan": "icons/nissan.png",
        "Fiat": "icons/fiat.png",
        "Citro√´n": "icons/citroen.png",
        "Kia": "icons/kia.png",
        "Mercedes-Benz": "icons/mercedes.png"
    };
    const currentYear = new Date().getFullYear();
    const years = Array.from({length: currentYear - 1979}, (_, i) => (currentYear - i).toString());

    // DOM Elements
    const DOMElements = {
        html: document.documentElement,
        body: document.body,
        appContainer: document.getElementById("app-container"),
        messageBox: document.getElementById("message-box"),
        langDropdownBtn: document.getElementById("lang-dropdown-btn"),
        langDropdown: document.getElementById("lang-dropdown"),
        currentLangSpan: document.getElementById("current-lang"),
        langBtns: document.querySelectorAll(".lang-btn"),
        searchInput: document.getElementById("search-input"),
        postProductModal: document.getElementById("post-product-modal"),
        modalCloseBtn: document.getElementById("modal-close-btn"),
        postProductForm: document.getElementById("post-product-form"),
        mobileMenuBtn: document.getElementById("mobile-menu-btn"),
        mobileMenu: document.getElementById("mobile-menu"),
        mobileMenuCloseBtn: document.getElementById("mobile-menu-close-btn"),
        mobileNavLinks: document.getElementById("mobile-nav-links"),
        mobileFiltersModal: document.getElementById("mobile-filters-modal"),
        mobileFiltersContent: document.getElementById("mobile-filters-content"),
        mobileFiltersCloseBtn: document.getElementById("mobile-filters-close-btn"),
        mobileApplyFiltersBtn: document.getElementById("mobile-apply-filters-btn"),
        authModal: document.getElementById("auth-modal"),
        authModalCloseBtn: document.getElementById("auth-modal-close-btn"),
        googleLoginBtn: document.getElementById("google-login-btn"),
        cartBtn: document.getElementById("cart-btn"),
        cartCountSpan: document.getElementById("cart-count"),
        authLinksContainer: document.getElementById("auth-links"),
        homeLink: document.getElementById("home-link"),
        sellLink: document.getElementById("sell-link"),
        darkModeToggle: document.getElementById('dark-mode-toggle'),
        postProductBrandSelect: document.getElementById('product-brand'),
        postProductModelSelect: document.getElementById('product-model'),
        postProductYearSelect: document.getElementById('product-year'),
        postProductWilayaSelect: document.getElementById('product-wilaya'),
        postProductCommuneSelect: document.getElementById('product-commune'),
        postProductCategorySelect: document.getElementById('product-category'),
    };
    
    // UTILITY FUNCTIONS
    const showMessage = (msgKey, duration = 3500, type = "info") => {
        const msg = translations[currentLang][msgKey] || msgKey;
        const { messageBox } = DOMElements;
        if (!messageBox) return;
        messageBox.textContent = msg;
        messageBox.className = `fixed top-5 right-5 z-[1000] p-4 rounded-lg shadow-lg transition-all duration-500 ease-in-out max-w-sm break-words`;
        
        let colors = '';
        if (type === 'success') {
            colors = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        } else if (type === 'error') {
            colors = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        } else {
            colors = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
        }
        messageBox.classList.add(...colors.split(' '));

        requestAnimationFrame(() => {
            messageBox.classList.remove('opacity-0', 'translate-x-full');
            messageBox.classList.add('opacity-100', 'translate-x-0');
        });

        setTimeout(() => {
            messageBox.classList.remove('opacity-100', 'translate-x-0');
            messageBox.classList.add('opacity-0', 'translate-x-full');
        }, duration);
    };

    const toggleModal = (modalElement, show) => {
        if (show) {
            modalElement.classList.remove('invisible', 'opacity-0');
            modalElement.classList.add('visible', 'opacity-100');
        } else {
            modalElement.classList.remove('visible', 'opacity-100');
            modalElement.classList.add('invisible', 'opacity-0');
        }
    };
    
    const updateCartDisplay = () => {
       const { cartCountSpan } = DOMElements;
       const mobileCartCount = document.getElementById('mobile-cart-count');
       const cartItemCount = Object.values(userCart).reduce((sum, item) => sum + item.quantity, 0);

       const updateCount = (el) => {
           if (el) {
               if (cartItemCount > 0) {
                   el.textContent = cartItemCount;
                   el.classList.remove('hidden');
               } else {
                   el.classList.add('hidden');
               }
           }
       };
       updateCount(cartCountSpan);
       updateCount(mobileCartCount);
    };

    const debounce = (func, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    };

    // APP LOGIC
    const setDarkMode = (isDark) => {
        DOMElements.html.classList.toggle('dark', isDark);
        localStorage.setItem('piecety_dark_mode', isDark);
        const icon = DOMElements.darkModeToggle.querySelector('i');
        if (icon) icon.className = isDark ? 'fas fa-sun text-xl' : 'fas fa-moon text-xl';
    };

    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem("piecety_lang", lang);
        translatePage(lang);
        if (currentView === 'home') {
            renderHomePage(); 
        }
        updateAuthUI(currentUser);
    };

    const updateTitle = (view, data = null) => {
        let title = "Piecety";
        if (view === 'product-detail' && data) title = `Piecety - ${data.title}`;
        else if (view === 'cart') title = "Piecety - Mon Panier";
        else if (view === 'dashboard') title = "Piecety - Mon Tableau de Bord";
        else if (view === 'profile' && data) title = `Piecety - Profil de ${data.userName}`;
        document.title = title;
    };

    const translatePage = (lang) => {
        const { currentLangSpan, body, searchInput } = DOMElements;
        if (currentLangSpan) currentLangSpan.textContent = translations[lang][lang + "_short"];
        if (body) {
            if (lang === "ar") {
                body.setAttribute("dir", "rtl");
                body.classList.add("rtl");
            } else {
                body.setAttribute("dir", "ltr");
                body.classList.remove("rtl");
            }
        }
        searchInput.placeholder = translations[lang].search_placeholder;
        document.querySelectorAll("[data-i18n-key]").forEach(el => {
            const key = el.getAttribute("data-i18n-key");
            if (translations[lang] && translations[lang][key]) {
                 if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    // This handles placeholders, but we do searchInput separately for simplicity
                } else {
                    el.innerHTML = translations[lang][key];
                }
            }
        });
    };

    const populateSelect = (selectEl, options, defaultLabelKey, lang, valueAsKey = false) => {
        if (!selectEl) return;
        const currentValue = selectEl.value;
        selectEl.innerHTML = "";
        const defaultText = translations[lang][defaultLabelKey] || defaultLabelKey;
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = defaultText;
        selectEl.appendChild(defaultOption);
        
        const optionData = Array.isArray(options) ? options : Object.keys(options).sort();
        
        optionData.forEach(opt => {
            const option = document.createElement('option');
            if (valueAsKey) {
                option.value = opt;
                option.textContent = options[opt][lang] || options[opt]['fr'];
            } else {
                option.value = opt;
                option.textContent = opt;
            }
            selectEl.appendChild(option);
        });
        selectEl.value = currentValue;
    };
    
    const applyAndRenderFilters = () => {
        const params = {};
        const filtersContainer = document.getElementById('filters-content') || document;
        
        filtersContainer.querySelectorAll('.filter').forEach(el => {
            const key = el.id.replace('-filter', '');
            if(el.value) {
                if (el.type === 'range' && el.value === el.max) return;
                params[key] = el.value;
            }
        });
        params.search = DOMElements.searchInput.value;

        // Update URL state without a full page reload
        const newUrl = new URL(window.location);
        newUrl.search = ''; // Clear existing params
        Object.keys(params).forEach(key => {
            if (params[key]) {
                newUrl.searchParams.set(key, params[key]);
            }
        });
        window.history.replaceState({path: newUrl.href}, '', newUrl.href);

        // Re-filter and display products
        const filtered = filterProducts(allProducts);
        displayProducts(filtered, document.getElementById('listings-section'));
    };


    const applyFiltersFromURL = (container = document) => {
        const params = new URLSearchParams(window.location.search);
        params.forEach((value, key) => {
            const el = container.querySelector(`#${key}-filter`);
            if (el) {
                el.value = value;
                if (key === 'brand' || key === 'wilaya') {
                     el.dispatchEvent(new Event('change'));
                     setTimeout(() => {
                        const childKey = key === 'brand' ? 'model' : 'commune';
                        const childVal = params.get(childKey);
                        if (childVal) {
                            const childEl = container.querySelector(`#${childKey}-filter`);
                            if (childEl) childEl.value = childVal;
                        }
                     }, 100);
                }
            }
        });
        DOMElements.searchInput.value = params.get('search') || '';
    };

    // VIEW RENDERING
    const renderView = (viewName, data = null) => {
        if (productsUnsubscribe) {
            productsUnsubscribe();
            productsUnsubscribe = null;
        }
        DOMElements.appContainer.innerHTML = '';
        updateTitle(viewName, data);

        const route = viewName.split('/')[0];

        switch (route) {
            case 'home':
                DOMElements.appContainer.appendChild(document.getElementById('home-view-template').content.cloneNode(true));
                renderHomePage();
                break;
            case 'product':
                DOMElements.appContainer.appendChild(document.getElementById('product-detail-view-template').content.cloneNode(true));
                renderProductPage(data);
                break;
            case 'cart':
                DOMElements.appContainer.appendChild(document.getElementById('cart-view-template').content.cloneNode(true));
                renderCartPage();
                break;
            case 'dashboard':
                DOMElements.appContainer.appendChild(document.getElementById('dashboard-view-template').content.cloneNode(true));
                renderDashboardPage();
                break;
            case 'profile':
                DOMElements.appContainer.appendChild(document.getElementById('profile-view-template').content.cloneNode(true));
                renderProfilePage(data);
                break;
            case 'inbox':
                DOMElements.appContainer.appendChild(document.getElementById('inbox-view-template').content.cloneNode(true));
                renderInboxPage();
                break;
            case 'chat':
                DOMElements.appContainer.appendChild(document.getElementById('chat-view-template').content.cloneNode(true));
                renderChatPage(data);
                break;
            default:
                renderView('home');
                break;
        }
        currentView = viewName;
        window.scrollTo(0, 0);
        translatePage(currentLang);
    };

    const renderHomePage = () => {
        const params = new URLSearchParams(window.location.search);
        const category = params.get('category');
        const brand = params.get('brand');

        updateBreadcrumb();

        if (brand) {
            renderYearCategories();
        } else if (category) {
            renderBrandCategories();
        } else {
            renderPartCategories();
        }
        
        const setupFilters = (container) => {
            container.innerHTML = document.getElementById('filters-template').content.cloneNode(true).innerHTML;
            setupFilterListeners(container);
            applyFiltersFromURL(container);
        };

        const filtersContent = document.getElementById('filters-content');
        if (filtersContent) setupFilters(filtersContent);
        
        if (DOMElements.mobileFiltersContent) setupFilters(DOMElements.mobileFiltersContent);

        document.getElementById('show-filters-btn')?.addEventListener('click', () => {
            DOMElements.mobileFiltersModal.classList.remove('translate-x-full');
        });
        
        renderListings();
    };
    
    const updateBreadcrumb = () => {
        const breadcrumbNav = document.getElementById('breadcrumb-nav');
        if (!breadcrumbNav) return;

        const params = new URLSearchParams(window.location.search);
        const category = params.get('category');
        const brand = params.get('brand');

        let html = `<a href="#" class="hover:underline home-crumb">Home</a>`;
        if (category) {
            const categoryName = categories[category] ? categories[category][currentLang] : category;
            html += ` <span class="mx-2">/</span> <a href="#" class="hover:underline category-crumb" data-category="${category}">${categoryName}</a>`;
        }
        if (brand) {
            html += ` <span class="mx-2">/</span> <span class="font-semibold">${brand}</span>`;
        }
        breadcrumbNav.innerHTML = html;

        breadcrumbNav.querySelector('.home-crumb')?.addEventListener('click', (e) => {
            e.preventDefault();
            window.history.pushState({}, '', window.location.pathname);
            renderView('home');
        });
        breadcrumbNav.querySelector('.category-crumb')?.addEventListener('click', (e) => {
            e.preventDefault();
            const newUrl = new URL(window.location);
            newUrl.searchParams.forEach((_, key) => newUrl.searchParams.delete(key));
            newUrl.searchParams.set('category', e.target.dataset.category);
            window.history.pushState({path: newUrl.href}, '', newUrl.href);
            renderHomePage();
        });
    };

    const renderPartCategories = () => {
        const grid = document.getElementById('dynamic-grid');
        const title = document.getElementById('categories-title-heading');
        if (!grid || !title) return;

        title.textContent = translations[currentLang].categories_title;
        grid.innerHTML = '';
        for (const key in categories) {
            const cat = categories[key];
            const card = document.createElement('a');
            card.href = `?category=${key}`;
            card.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 text-center category-card";
            card.innerHTML = `
                <div class="p-4 rounded-full bg-blue-50 dark:bg-gray-700 text-blue-600 dark:text-blue-400 mx-auto w-16 h-16 flex items-center justify-center mb-2 category-icon">
                    <i class="fas ${cat.icon} text-3xl"></i>
                </div>
                <h3 class="font-semibold text-sm md:text-base">${cat[currentLang]}</h3>
            `;
            card.addEventListener('click', (e) => {
                e.preventDefault();
                const newUrl = new URL(window.location);
                newUrl.searchParams.forEach((_, key) => newUrl.searchParams.delete(key));
                newUrl.searchParams.set('category', key);
                window.history.pushState({path: newUrl.href}, '', newUrl.href);
                renderHomePage();
            });
            grid.appendChild(card);
        }
    };

    const renderBrandCategories = () => {
        const grid = document.getElementById('dynamic-grid');
        const title = document.getElementById('categories-title-heading');
        if (!grid || !title) return;

        title.textContent = translations[currentLang].brands_title;
        grid.innerHTML = '';
        const params = new URLSearchParams(window.location.search);
        const category = params.get('category');

        for (const brandName in car_data) {
            const card = document.createElement('a');
            card.href = `?category=${category}&brand=${brandName}`;
            card.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 text-center category-card flex flex-col items-center justify-center";
            card.innerHTML = `
                <img src="${brand_icons[brandName] || 'icons/car-192.png'}" alt="${brandName}" class="h-16 object-contain mb-2" onerror="this.onerror=null; this.src='icons/car-192.png'">
                <h3 class="font-semibold text-sm md:text-base">${brandName}</h3>
            `;
            card.addEventListener('click', (e) => {
                e.preventDefault();
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('brand', brandName);
                window.history.pushState({path: newUrl.href}, '', newUrl.href);
                renderHomePage();
            });
            grid.appendChild(card);
        }
    };

    const renderYearCategories = () => {
        const grid = document.getElementById('dynamic-grid');
        const title = document.getElementById('categories-title-heading');
        if (!grid || !title) return;

        title.textContent = translations[currentLang].years_title;
        grid.innerHTML = '';
        
        years.forEach(year => {
            const card = document.createElement('button');
            card.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 text-center category-card font-semibold";
            card.textContent = year;
            card.addEventListener('click', () => {
                const yearFilterDesktop = document.querySelector('#filters-content #year-filter');
                const yearFilterMobile = document.querySelector('#mobile-filters-content #year-filter');
                if(yearFilterDesktop) yearFilterDesktop.value = year;
                if(yearFilterMobile) yearFilterMobile.value = year;
                
                applyAndRenderFilters();
                document.getElementById('listings-section').scrollIntoView({ behavior: 'smooth' });
            });
            grid.appendChild(card);
        });
    };

    const setupFilterListeners = (container = document) => {
        const debouncedApplyAndRender = debounce(applyAndRenderFilters, 300);

        const brandFilter = container.querySelector('#brand-filter');
        if(brandFilter) {
            brandFilter.addEventListener('change', () => {
                const modelFilterContainer = container.querySelector('#model-filter-container');
                const modelFilter = container.querySelector('#model-filter');
                const selectedBrand = brandFilter.value;
                if (selectedBrand && car_data[selectedBrand]) {
                    populateSelect(modelFilter, car_data[selectedBrand], 'all_models', currentLang);
                    modelFilterContainer.classList.remove('hidden');
                } else {
                    modelFilterContainer.classList.add('hidden');
                    if(modelFilter) modelFilter.value = '';
                }
                debouncedApplyAndRender();
            });
        }
        
        const wilayaFilter = container.querySelector('#wilaya-filter');
        if(wilayaFilter) {
            wilayaFilter.addEventListener('change', () => {
                const communeFilterContainer = container.querySelector('#commune-filter-container');
                const communeFilter = container.querySelector('#commune-filter');
                const selectedWilaya = wilayaFilter.value;
                if (selectedWilaya && wilayas[selectedWilaya]) {
                    populateSelect(communeFilter, wilayas[selectedWilaya], 'all_communes', currentLang);
                    communeFilterContainer.classList.remove('hidden');
                } else {
                    communeFilterContainer.classList.add('hidden');
                    if(communeFilter) communeFilter.value = '';
                }
                debouncedApplyAndRender();
            });
        }
        
        const priceFilter = container.querySelector('#price-range-filter');
        if (priceFilter) {
            priceFilter.addEventListener('input', () => {
                const priceValue = container.querySelector('#price-range-value');
                if(priceValue) priceValue.textContent = `${Number(priceFilter.value).toLocaleString()} DA`;
            });
            priceFilter.addEventListener('change', debouncedApplyAndRender);
        }

        container.querySelectorAll('.filter').forEach(el => {
            if (el.id !== 'brand-filter' && el.id !== 'wilaya-filter' && el.id !== 'price-range-filter') {
                el.addEventListener('change', debouncedApplyAndRender);
            }
        });
        
        const resetBtn = container.querySelector('#filter-reset-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                window.history.pushState({}, '', window.location.pathname);
                renderView('home');
            });
        }

        populateSelect(brandFilter, car_data, 'all_brands', currentLang);
        populateSelect(container.querySelector('#year-filter'), years, 'all_years', currentLang);
        populateSelect(wilayaFilter, wilayas, 'all_wilayas', currentLang);
        populateSelect(container.querySelector('#category-filter'), categories, 'all_categories', currentLang, true);
    };

    const renderListings = () => {
        const listingsSection = document.getElementById('listings-section');
        if (!listingsSection) return;
        listingsSection.innerHTML = `<div class="col-span-full text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>`;
        
        const q = query(collection(db, "products"));
        productsUnsubscribe = onSnapshot(q, (querySnapshot) => {
            allProducts = [];
            querySnapshot.forEach((doc) => {
                allProducts.push({ id: doc.id, ...doc.data() });
            });
            applyAndRenderFilters(); 
        }, (error) => {
            console.error("Error fetching products:", error);
            if(listingsSection) listingsSection.innerHTML = `<p class="col-span-full text-center text-red-500">Error loading products.</p>`;
        });
    };
    
    const filterProducts = (products) => {
        const params = new URLSearchParams(window.location.search);
        const p = (key) => params.get(key)?.toLowerCase() || '';

        return products.filter(prod => {
            if (p('category') && prod.category !== p('category')) return false;
            if (p('brand') && prod.brand.toLowerCase() !== p('brand')) return false;
            if (p('model') && prod.model?.toLowerCase() !== p('model')) return false;
            if (p('year') && prod.year?.toString() !== p('year')) return false;
            if (p('wilaya') && prod.wilaya.toLowerCase() !== p('wilaya')) return false;
            if (p('commune') && prod.commune?.toLowerCase() !== p('commune')) return false;
            if (p('condition') && prod.condition !== p('condition')) return false;
            const maxPrice = Number(params.get('price'));
            if (maxPrice && prod.price > maxPrice) return false;
            
            const searchTerm = p('search');
            if (searchTerm && !(prod.title.toLowerCase().includes(searchTerm) || (prod.description && prod.description.toLowerCase().includes(searchTerm)))) return false;
            
            return true;
        });
    };

    const displayProducts = (products, container) => {
        if (!container) return;
        container.innerHTML = '';
        if (products.length === 0) {
            container.innerHTML = `<p class="col-span-full text-center p-8 text-lg text-gray-500" data-i18n-key="no_listings">${translations[currentLang].no_listings}</p>`;
            return;
        }
        products.forEach(product => {
            const card = document.createElement('div');
            card.className = "listing-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden cursor-pointer";
            card.innerHTML = `
                <img src="${product.imageUrl || 'https://via.placeholder.com/300x200.png?text=Piecety'}" alt="${product.title}" class="w-full h-40 object-cover">
                <div class="p-4">
                    <h3 class="font-bold text-lg truncate">${product.title}</h3>
                    <p class="text-blue-600 dark:text-blue-400 font-semibold text-xl my-2">${product.price.toLocaleString()} DA</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400"><i class="fas fa-map-marker-alt mr-1"></i> ${product.wilaya}, ${product.commune || ''}</p>
                </div>
            `;
            card.addEventListener('click', () => renderView('product', product));
            container.appendChild(card);
        });
    };

    const renderProductPage = async (product) => {
        if (!product) { renderView('home'); return; }
        
        document.getElementById('product-title-detail').textContent = product.title;
        document.getElementById('product-price-detail').textContent = `${product.price.toLocaleString()} DA`;
        document.getElementById('product-image-detail').src = product.imageUrl || 'https://via.placeholder.com/600x400.png?text=Piecety';
        document.getElementById('product-image-detail').alt = product.title;
        document.getElementById('product-brand-detail').textContent = product.brand;
        document.getElementById('product-model-detail').textContent = product.model || 'N/A';
        document.getElementById('product-year-detail').textContent = product.year || 'N/A';
        document.getElementById('product-wilaya-detail').textContent = product.wilaya;
        document.getElementById('product-commune-detail').textContent = product.commune || 'N/A';
        document.getElementById('product-description-detail').textContent = product.description || 'No description available.';

        const sellerLink = document.getElementById('seller-profile-link');
        sellerLink.textContent = product.sellerName || 'Anonymous';
        sellerLink.addEventListener('click', (e) => {
            e.preventDefault();
            renderView('profile', { userId: product.sellerId, userName: product.sellerName });
        });

        document.getElementById('back-to-listings-btn').addEventListener('click', () => {
            window.history.back();
        });
        document.getElementById('add-to-cart-btn').addEventListener('click', () => addToCart(product));
        document.getElementById('contact-seller-btn').addEventListener('click', () => {
            startOrOpenChat(product.sellerId, product.sellerName);
        });
    };

    const renderCartPage = async () => {
        if (!currentUser) {
            showMessage('login_required', 3000, 'error');
            renderView('home');
            return;
        }
        const container = document.getElementById('cart-items-container');
        const summary = document.getElementById('cart-summary');
        container.innerHTML = '';

        const cartItems = Object.values(userCart);

        if (cartItems.length === 0) {
            container.innerHTML = `<p class="text-center p-8 text-lg text-gray-500" data-i18n-key="your_cart_is_empty">${translations[currentLang].your_cart_is_empty}</p>`;
            summary.classList.add('hidden');
        } else {
            summary.classList.remove('hidden');
            let totalPrice = 0;
            for (const item of cartItems) {
                const docRef = doc(db, "products", item.productId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const product = { id: docSnap.id, ...docSnap.data() };
                    totalPrice += product.price * item.quantity;
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg';
                    itemEl.innerHTML = `
                        <div class="flex items-center">
                            <img src="${product.imageUrl || 'https://via.placeholder.com/100'}" alt="${product.title}" class="w-16 h-16 object-cover rounded-md mr-4">
                            <div>
                                <h4 class="font-semibold">${product.title}</h4>
                                <p class="text-sm text-gray-500">${product.price.toLocaleString()} DA</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <input type="number" min="1" value="${item.quantity}" class="w-16 p-1 border rounded-md dark:bg-gray-600 quantity-input" data-id="${product.id}">
                            <button class="text-red-500 hover:text-red-700 remove-btn" data-id="${product.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    container.appendChild(itemEl);
                }
            }
            document.getElementById('cart-total-price').textContent = `${totalPrice.toLocaleString()} DA`;
        }

        container.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', (e) => updateCartItem(e.target.dataset.id, parseInt(e.target.value)));
        });
        container.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', (e) => removeFromCart(e.currentTarget.dataset.id));
        });
        document.getElementById('back-from-cart-btn').addEventListener('click', () => renderView('home'));
        document.getElementById('clear-cart-btn').addEventListener('click', clearCart);
    };
    
    const renderDashboardPage = async () => {
         if (!currentUser) { renderView('home'); return; }
        const grid = document.getElementById('my-listings-grid');
        grid.innerHTML = `<div class="col-span-full text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>`;

        const q = query(collection(db, "products"), where("sellerId", "==", currentUser.uid));
        const querySnapshot = await getDocs(q);
        const userProducts = [];
        querySnapshot.forEach(doc => userProducts.push({ id: doc.id, ...doc.data() }));

        grid.innerHTML = '';
        if (userProducts.length === 0) {
            grid.innerHTML = `<p class="col-span-full text-center p-8 text-lg text-gray-500">You have no active listings.</p>`;
        } else {
            userProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = "relative bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden";
                card.innerHTML = `
                    <img src="${product.imageUrl || 'https://via.placeholder.com/300x200.png?text=Piecety'}" alt="${product.title}" class="w-full h-40 object-cover">
                    <div class="p-4">
                        <h3 class="font-bold text-lg truncate">${product.title}</h3>
                        <p class="text-blue-600 dark:text-blue-400 font-semibold text-xl my-2">${product.price.toLocaleString()} DA</p>
                    </div>
                    <div class="absolute top-2 right-2 flex gap-2">
                        <button class="delete-ad-btn bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                card.querySelector('.delete-ad-btn').addEventListener('click', async () => {
                    if (confirm(translations[currentLang].delete_ad_confirm)) {
                        await deleteDoc(doc(db, "products", product.id));
                        renderDashboardPage();
                    }
                });
                grid.appendChild(card);
            });
        }
    };
    
    const renderProfilePage = async (data) => {
        if (!data || !data.userId) { renderView('home'); return; }
        document.getElementById('profile-name').textContent = data.userName || 'Seller Profile';
        
        const grid = document.getElementById('user-products-grid');
        grid.innerHTML = `<div class="col-span-full text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>`;
        
        const q = query(collection(db, "products"), where("sellerId", "==", data.userId));
        const querySnapshot = await getDocs(q);
        const userProducts = [];
        querySnapshot.forEach(doc => userProducts.push({ id: doc.id, ...doc.data() }));
        
        displayProducts(userProducts, grid);
    };

    const startOrOpenChat = async (sellerId, sellerName) => {
        if (!currentUser) {
            showMessage('login_required', 3000, 'error');
            return;
        }
        if (currentUser.uid === sellerId) {
            showMessage("You cannot message yourself.", 3000, 'error');
            return;
        }

        const chatId = [currentUser.uid, sellerId].sort().join('_');
        const chatRef = doc(db, "chats", chatId);
        
        try {
            const chatSnap = await getDoc(chatRef);
            if (!chatSnap.exists()) {
                await setDoc(chatRef, {
                    participants: [currentUser.uid, sellerId],
                    participantNames: [currentUser.displayName, sellerName],
                    lastMessage: "Chat started.",
                    lastMessageTimestamp: serverTimestamp()
                });
            }
            renderView('chat', { chatId, otherUserName: sellerName });
        } catch (error) {
            console.error("Error starting chat:", error);
            showMessage("Could not open chat.", 3000, 'error');
        }
    };

    const renderInboxPage = () => {
        if (!currentUser) {
            renderView('home');
            return;
        }
        const listContainer = document.getElementById('conversations-list');
        const q = query(
            collection(db, "chats"), 
            where("participants", "array-contains", currentUser.uid),
            orderBy("lastMessageTimestamp", "desc")
        );

        onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                listContainer.innerHTML = `<p class="text-center text-gray-500">You have no messages.</p>`;
                return;
            }
            listContainer.innerHTML = '';
            snapshot.forEach(doc => {
                const chat = doc.data();
                const otherUserIndex = chat.participants.indexOf(currentUser.uid) === 0 ? 1 : 0;
                const otherUserName = chat.participantNames[otherUserIndex];
                
                const convoEl = document.createElement('div');
                convoEl.className = 'p-4 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600';
                convoEl.innerHTML = `
                    <h4 class="font-bold">${otherUserName}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${chat.lastMessage}</p>
                `;
                convoEl.addEventListener('click', () => renderView('chat', { chatId: doc.id, otherUserName }));
                listContainer.appendChild(convoEl);
            });
        });
    };

    const renderChatPage = (chatData) => {
        if (!currentUser || !chatData) {
            renderView('home');
            return;
        }
        
        const { chatId, otherUserName } = chatData;
        document.getElementById('chat-with-name').textContent = `Chat with ${otherUserName}`;
        document.getElementById('back-to-inbox-btn').addEventListener('click', () => renderView('inbox'));

        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('send-message-form');
        const messageInput = document.getElementById('message-input');
        
        const messagesRef = collection(db, "chats", chatId, "messages");
        const q = query(messagesRef, orderBy("timestamp"));

        onSnapshot(q, (snapshot) => {
            messagesContainer.innerHTML = '';
            snapshot.forEach(doc => {
                const msg = doc.data();
                const msgEl = document.createElement('div');
                const isMe = msg.senderId === currentUser.uid;
                
                msgEl.className = `p-3 rounded-lg max-w-xs ${isMe ? 'bg-blue-500 text-white self-end' : 'bg-gray-200 dark:bg-gray-600 self-start'}`;
                msgEl.textContent = msg.text;
                messagesContainer.appendChild(msgEl);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text) {
                messageInput.value = '';
                await addDoc(messagesRef, {
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: serverTimestamp()
                });
                const chatRef = doc(db, "chats", chatId);
                await setDoc(chatRef, { 
                    lastMessage: text, 
                    lastMessageTimestamp: serverTimestamp() 
                }, { merge: true });
            }
        });
    };

    // USER ACTIONS
    const handleSignOut = () => {
        signOut(auth).catch(error => console.error("Sign out error", error));
    };
    
    const clearCart = async () => {
        if (!currentUser) return;
        const cartRef = doc(db, "carts", currentUser.uid);
        await setDoc(cartRef, {});
        userCart = {};
        updateCartDisplay();
        if(currentView === 'cart') renderCartPage();
    };

    const addToCart = async (product) => {
        if (!currentUser) { showMessage('login_required', 3000, 'error'); return; }
        const cartRef = doc(db, "carts", currentUser.uid);
        
        const currentQuantity = userCart[product.id] ? userCart[product.id].quantity : 0;
        
        userCart[product.id] = { productId: product.id, quantity: currentQuantity + 1 };
        
        await setDoc(cartRef, userCart);
        updateCartDisplay();
        showMessage('item_added_to_cart', 2000, 'success');
    };
    
    const updateCartItem = async (productId, quantity) => {
        if (!currentUser || !userCart[productId]) return;
        if (quantity <= 0) {
            removeFromCart(productId);
            return;
        }
        userCart[productId].quantity = quantity;
        const cartRef = doc(db, "carts", currentUser.uid);
        await setDoc(cartRef, userCart);
        updateCartDisplay();
        if (currentView === 'cart') renderCartPage();
    };
    
    const removeFromCart = async (productId) => {
        if (!currentUser || !userCart[productId]) return;
        delete userCart[productId];
        const cartRef = doc(db, "carts", currentUser.uid);
        await setDoc(cartRef, userCart);
        updateCartDisplay();
        if (currentView === 'cart') renderCartPage();
    };

    const validatePostForm = (form) => {
        let isValid = true;
        const requiredFields = ['title', 'brand', 'wilaya', 'category', 'price'];
        requiredFields.forEach(fieldName => {
            const input = form.elements[fieldName];
            const errorEl = document.getElementById(`${fieldName}-error`);
            if (!input.value) {
                input.classList.add('border-red-500');
                if (errorEl) errorEl.classList.remove('hidden');
                isValid = false;
            } else {
                input.classList.remove('border-red-500');
                if (errorEl) errorEl.classList.add('hidden');
            }
        });
        return isValid;
    };
    
    const updateAuthUI = (user) => {
        const { authLinksContainer, mobileNavLinks } = DOMElements;
        authLinksContainer.innerHTML = '';
        mobileNavLinks.innerHTML = '';
        
        mobileNavLinks.innerHTML += `<a href="#" id="mobile-sell-link" class="text-lg" data-i18n-key="sell">${translations[currentLang].sell}</a>`;
        mobileNavLinks.innerHTML += `<a href="#" id="mobile-cart-link" class="text-lg relative">
            <span data-i18n-key="cart_title">${translations[currentLang].cart_title}</span>
            <span id="mobile-cart-count" class="absolute top-0 ml-2 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full hidden">0</span>
        </a>`;

        document.getElementById('mobile-sell-link').addEventListener('click', (e) => {
            e.preventDefault();
            DOMElements.mobileMenu.classList.add('hidden');
            DOMElements.sellLink.click();
        });
        document.getElementById('mobile-cart-link').addEventListener('click', (e) => {
            e.preventDefault();
            DOMElements.mobileMenu.classList.add('hidden');
            DOMElements.cartBtn.click();
        });

        if (user) {
            const userMenuHTML = `
                <div class="relative" id="user-menu">
                    <button id="user-menu-btn" class="flex items-center">
                        <img src="${user.photoURL}" alt="User" class="w-8 h-8 rounded-full">
                    </button>
                    <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-lg shadow-lg py-1 hidden z-20">
                        <a href="#" id="dashboard-link" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600" data-i18n-key="dashboard">${translations[currentLang].dashboard}</a>
                        <a href="#" id="messages-link" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600">Messages</a>
                        <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600" data-i18n-key="logout">${translations[currentLang].logout}</button>
                    </div>
                </div>`;
            authLinksContainer.innerHTML = userMenuHTML;

            mobileNavLinks.innerHTML += `<a href="#" id="mobile-dashboard-link" class="text-lg" data-i18n-key="dashboard">${translations[currentLang].dashboard}</a>`;
            mobileNavLinks.innerHTML += `<a href="#" id="mobile-messages-link" class="text-lg">Messages</a>`;
            mobileNavLinks.innerHTML += `<button id="mobile-logout-btn" class="text-lg text-left" data-i18n-key="logout">${translations[currentLang].logout}</button>`;

            document.getElementById('user-menu-btn').addEventListener('click', () => {
                document.getElementById('user-menu-dropdown').classList.toggle('hidden');
            });
            document.getElementById('logout-btn').addEventListener('click', handleSignOut);
            document.getElementById('dashboard-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('user-menu-dropdown').classList.add('hidden');
                renderView('dashboard');
            });
            document.getElementById('messages-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('user-menu-dropdown').classList.add('hidden');
                renderView('inbox');
            });
            document.getElementById('mobile-logout-btn').addEventListener('click', handleSignOut);
            document.getElementById('mobile-dashboard-link').addEventListener('click', (e) => {
                e.preventDefault();
                DOMElements.mobileMenu.classList.add('hidden');
                renderView('dashboard');
            });
            document.getElementById('mobile-messages-link').addEventListener('click', (e) => {
                e.preventDefault();
                DOMElements.mobileMenu.classList.add('hidden');
                renderView('inbox');
            });

        } else {
            authLinksContainer.innerHTML = `<button id="login-btn" class="px-4 py-2 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors" data-i18n-key="connect">${translations[currentLang].connect}</button>`;
            
            mobileNavLinks.innerHTML += `<button id="mobile-login-btn" class="text-lg text-left" data-i18n-key="connect">${translations[currentLang].connect}</button>`;
            
            document.getElementById('login-btn').addEventListener('click', () => toggleModal(DOMElements.authModal, true));
            document.getElementById('mobile-login-btn').addEventListener('click', () => {
                 DOMElements.mobileMenu.classList.add('hidden');
                 toggleModal(DOMElements.authModal, true)
            });
        }
        updateCartDisplay();
    };

    // SETUP & INITIALIZATION
    const setupEventListeners = () => {
        const { darkModeToggle, langDropdownBtn, langDropdown, langBtns, sellLink, authModal, cartBtn, homeLink, mobileMenuBtn, mobileMenu, mobileMenuCloseBtn, authModalCloseBtn, googleLoginBtn, postProductModal, modalCloseBtn, searchInput, mobileFiltersModal, mobileFiltersCloseBtn, mobileApplyFiltersBtn } = DOMElements;

        darkModeToggle.addEventListener('click', () => {
            setDarkMode(!DOMElements.html.classList.contains('dark'));
        });

        langDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            langDropdown.classList.toggle('hidden');
        });

        langBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                setLanguage(btn.getAttribute('data-lang'));
                langDropdown.classList.add('hidden');
                mobileMenu.classList.add('hidden');
            });
        });

        sellLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUser) {
                toggleModal(postProductModal, true);
            } else {
                toggleModal(authModal, true);
            }
        });

        cartBtn.addEventListener('click', () => renderView('cart'));
        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            window.history.pushState({}, '', window.location.pathname);
            renderView('home');
        });

        mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
        mobileMenuCloseBtn.addEventListener('click', () => mobileMenu.classList.add('hidden'));

        authModalCloseBtn.addEventListener('click', () => toggleModal(authModal, false));
        modalCloseBtn.addEventListener('click', () => toggleModal(postProductModal, false));

        googleLoginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => console.error("Login error", error));
        });

        DOMElements.postProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validatePostForm(e.target) || !currentUser) return;
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.querySelector('.btn-text').textContent = translations[currentLang].loading_text;
            btn.querySelector('.btn-spinner').classList.remove('hidden');

            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData.entries());
            productData.price = Number(productData.price);
            productData.sellerId = currentUser.uid;
            productData.sellerName = currentUser.displayName;
            productData.createdAt = serverTimestamp();

            try {
                await addDoc(collection(db, "products"), productData);
                showMessage('ad_posted', 3000, 'success');
                e.target.reset();
                toggleModal(postProductModal, false);
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage('ad_post_failed', 3000, 'error');
            } finally {
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = translations[currentLang].submit_ad_btn_text;
                btn.querySelector('.btn-spinner').classList.add('hidden');
            }
        });

        searchInput.addEventListener('input', debounce(applyAndRenderFilters, 500));
        
        mobileFiltersCloseBtn.addEventListener('click', () => mobileFiltersModal.classList.add('translate-x-full'));
        mobileApplyFiltersBtn.addEventListener('click', () => {
            applyAndRenderFilters();
            mobileFiltersModal.classList.add('translate-x-full');
        });

        document.addEventListener('click', (e) => {
            if (!langDropdownBtn.contains(e.target)) {
                langDropdown.classList.add('hidden');
            }
            const userMenu = document.getElementById('user-menu');
            if(userMenu && !userMenu.contains(e.target)) {
                document.getElementById('user-menu-dropdown').classList.add('hidden');
            }
        });
        
        populateSelect(DOMElements.postProductBrandSelect, car_data, 'select_brand', currentLang);
        populateSelect(DOMElements.postProductYearSelect, years, 'select_year', currentLang);
        populateSelect(DOMElements.postProductWilayaSelect, wilayas, 'select_wilaya', currentLang);
        populateSelect(DOMElements.postProductCategorySelect, categories, 'select_category', currentLang, true);
        DOMElements.postProductBrandSelect.addEventListener('change', (e) => {
             const brand = e.target.value;
             if (brand && car_data[brand]) {
                populateSelect(DOMElements.postProductModelSelect, car_data[brand], 'select_model', currentLang);
                DOMElements.postProductModelSelect.disabled = false;
             } else {
                DOMElements.postProductModelSelect.disabled = true;
             }
        });
         DOMElements.postProductWilayaSelect.addEventListener('change', (e) => {
             const wilaya = e.target.value;
             if (wilaya && wilayas[wilaya]) {
                populateSelect(DOMElements.postProductCommuneSelect, wilayas[wilaya], 'select_commune', currentLang);
                DOMElements.postProductCommuneSelect.disabled = false;
             } else {
                DOMElements.postProductCommuneSelect.disabled = true;
             }
        });
    };

    const bootApp = () => {
        setDarkMode(localStorage.getItem('piecety_dark_mode') === 'true');
        document.getElementById('current-year').textContent = new Date().getFullYear();
        setupEventListeners();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service worker registered successfully.'))
            .catch(err => console.error('Service worker registration failed:', err));
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            updateAuthUI(user);
            if (user) {
                toggleModal(DOMElements.authModal, false);
                const cartRef = doc(db, "carts", user.uid);
                const cartSnap = await getDoc(cartRef);
                if (cartSnap.exists()) {
                    userCart = cartSnap.data();
                } else {
                    userCart = {};
                }
            } else {
                userCart = {};
            }
            updateCartDisplay();
        });
        
        window.addEventListener('popstate', () => {
            renderView('home'); 
        });
        renderView('home');
    };

    bootApp();
</script>
</body>
</html>
