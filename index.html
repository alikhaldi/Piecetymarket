<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Piecety - Marché des Pièces Auto en Algérie</title>
    
    <link rel="icon" type="image/svg+xml" href="https://www.svgrepo.com/show/493547/brake-disc.svg">

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.5s ease-in-out;
            opacity: 0;
            transform: translateX(100%);
            max-width: 300px;
            word-wrap: break-word;
        }
        .message-box.show {
            opacity: 1;
            transform: translateX(0);
        }
        .category-card:hover .category-icon {
            transform: scale(1.1);
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.4);
        }
        /* RTL-specific styles */
        body[dir="rtl"] .logo {
            text-align: right;
        }
        body[dir="rtl"] .flex-1.mx-4.sm\:mx-8 {
            margin-right: 0.5rem;
            margin-left: 0.5rem;
        }
        body[dir="rtl"] .fa-search {
            right: 3px;
            left: auto;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">

<div id="message-box" class="message-box bg-white text-gray-800"></div>

<header
        class="bg-white shadow-sm sticky top-0 z-50"
        role="banner"
>
    <div
            class="container mx-auto p-4 flex items-center justify-between"
    >
        <a href="#" id="home-link" class="text-3xl font-bold text-blue-600 logo cursor-pointer">
            Piecety
        </a>

        <div class="flex-1 mx-4 sm:mx-8">
            <div class="relative">
                <input
                        id="search-input"
                        type="text"
                        placeholder="Rechercher une pièce..."
                        class="w-full p-3 pl-10 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 shadow-inner"
                        aria-label="Rechercher une pièce"
                />
                <i
                        class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                ></i>
            </div>
        </div>

        <nav class="hidden md:flex items-center space-x-6" role="navigation" aria-label="Main navigation">
            <div class="relative group">
                <button
                        id="lang-dropdown-btn"
                        aria-haspopup="true"
                        aria-expanded="false"
                        class="flex items-center space-x-1 font-medium text-gray-600 hover:text-blue-600 transition-colors duration-200"
                >
                    <span id="current-lang" class="lang-text">FR</span>
                    <i class="fas fa-chevron-down text-xs"></i>
                </button>
                <div
                        id="lang-dropdown"
                        class="absolute right-0 mt-2 w-28 bg-white rounded-lg shadow-lg py-1 hidden transition-all duration-300 z-10"
                        role="menu"
                        aria-label="Select Language"
                >
                    <button
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 lang-btn"
                            data-lang="fr"
                            role="menuitem"
                    >
                        Français
                    </button>
                    <button
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 lang-btn"
                            data-lang="en"
                            role="menuitem"
                    >
                        English
                    </button>
                    <button
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 lang-btn"
                            data-lang="ar"
                            role="menuitem"
                    >
                        العربية
                    </button>
                </div>
            </div>
            <a
                    href="#"
                    class="text-gray-600 hover:text-blue-600 font-medium transition-colors duration-200"
                    data-i18n-key="sell"
                    id="sell-link"
            >Vendre</a
            >
            <button
                    id="cart-btn"
                    class="relative p-2 text-gray-600 hover:text-blue-600 focus:outline-none"
            >
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
            </button>
            <div id="auth-links" class="flex items-center space-x-4">
                <button
                        id="login-btn"
                        class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-full font-semibold transition-colors duration-200 shadow-md"
                        data-i18n-key="connect"
                >
                    Se connecter
                </button>
            </div>
        </nav>

        <button
                id="mobile-menu-btn"
                class="md:hidden p-2 text-gray-600 hover:text-blue-600 focus:outline-none"
                aria-label="Menu"
                aria-expanded="false"
                aria-controls="mobile-menu"
        >
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>
</header>

<div
        id="mobile-menu"
        class="fixed inset-0 bg-white z-40 hidden flex-col p-6 space-y-6 md:hidden"
        role="dialog"
        aria-modal="true"
        aria-labelledby="mobile-menu-label"
>
    <div class="flex justify-between items-center">
        <h2
                id="mobile-menu-label"
                class="text-2xl font-bold text-blue-600"
                data-i18n-key="menu"
        >
            Menu
        </h2>
        <button
                id="mobile-menu-close-btn"
                class="text-gray-600 hover:text-blue-600"
                aria-label="Fermer menu"
        >
            <i class="fas fa-times text-xl"></i>
        </button>
    </div>
    <a
            href="#"
            class="text-xl font-medium text-gray-800 hover:text-blue-600"
            data-i18n-key="sell"
            id="sell-link-mobile"
    >Vendre</a
    >
    <button
            id="auth-btn-mobile"
            class="text-xl font-medium text-gray-800 hover:text-blue-600 text-left"
            data-i18n-key="connect"
    >
        Se connecter
    </button>

    <div class="pt-4 border-t border-gray-200">
        <h3 class="text-lg font-semibold text-gray-600" data-i18n-key="language">
            Langue
        </h3>
        <div class="flex space-x-4 mt-2">
            <button
                    class="p-2 border rounded-md text-sm font-medium lang-btn"
                    data-lang="fr"
            >
                Français
            </button>
            <button
                    class="p-2 border rounded-md text-sm font-medium lang-btn"
                    data-lang="en"
            >
                English
            </button>
            <button
                    class="p-2 border rounded-md text-sm font-medium lang-btn"
                    data-lang="ar"
            >
                العربية
            </button>
        </div>
    </div>
</div>

<main
        id="app-container"
        class="flex-1 container mx-auto p-4 md:p-8"
        role="main"
        aria-live="polite"
>
</main>

<footer class="bg-gray-800 text-white p-6 md:p-8 mt-auto text-center">
    <p class="text-sm font-light" data-i18n-key="footer_text">
        &copy; <span id="current-year"></span> Piecety - Marché des Pièces Auto en
        Algérie. Tous droits réservés.
    </p>
</footer>

<div
        id="post-product-modal"
        class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modal-title"
>
    <div
            class="bg-white rounded-lg shadow-lg max-w-2xl w-11/12 max-h-[90vh] overflow-y-auto p-6 relative"
    >
        <button
                id="modal-close-btn"
                class="absolute top-4 right-4 text-gray-600 hover:text-red-600 focus:outline-none"
                aria-label="Fermer le formulaire"
        >
            <i class="fas fa-times text-2xl"></i>
        </button>
        <h3
                id="modal-title"
                class="text-2xl font-bold mb-6 text-center"
                data-i18n-key="submit_ad"
        >
            Soumettre une annonce rapide
        </h3>
        <form id="post-product-form" class="space-y-4" novalidate>
            <div>
                <label for="product-title" class="block font-medium mb-1" data-i18n-key="ad_title_label">
                    Titre de la pièce <span class="text-red-500">*</span>
                </label>
                <input
                        type="text"
                        id="product-title"
                        name="title"
                        required
                        placeholder="Ex: Disque de frein avant"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-describedby="title-error"
                />
                <p
                        id="title-error"
                        class="text-red-600 text-sm mt-1 hidden"
                        aria-live="assertive"
                >
                    Veuillez entrer un titre valide.
                </p>
            </div>

            <div>
                <label for="product-brand" class="block font-medium mb-1" data-i18n-key="brand_label">
                    Marque <span class="text-red-500">*</span>
                </label>
                <select
                        id="product-brand"
                        name="brand"
                        required
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-describedby="brand-error"
                >
                    <option value="" data-i18n-key="select_brand">Sélectionnez une marque</option>
                </select>
                <p
                        id="brand-error"
                        class="text-red-600 text-sm mt-1 hidden"
                        aria-live="assertive"
                >
                    Veuillez sélectionner une marque.
                </p>
            </div>
            
            <div id="other-brand-container" class="hidden">
                 <label for="product-brand-other" class="block font-medium mb-1" data-i18n-key="other_brand_label">
                    Autre Marque <span class="text-red-500">*</span>
                </label>
                <input
                        type="text"
                        id="product-brand-other"
                        name="brand-other"
                        placeholder="Entrez la marque"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
            </div>

            <div>
                <label for="product-model" class="block font-medium mb-1" data-i18n-key="model_label">
                    Modèle
                </label>
                <select
                        id="product-model"
                        name="model"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled
                >
                    <option value="" data-i18n-key="select_model">Sélectionnez un modèle</option>
                </select>
            </div>

            <div>
                <label for="product-year" class="block font-medium mb-1" data-i18n-key="year_label">
                    Année
                </label>
                <select
                        id="product-year"
                        name="year"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="" data-i18n-key="select_year">Sélectionnez une année</option>
                </select>
            </div>

            <div>
                <label for="product-wilaya" class="block font-medium mb-1" data-i18n-key="wilaya_label">
                    Wilaya <span class="text-red-500">*</span>
                </label>
                <select
                        id="product-wilaya"
                        name="wilaya"
                        required
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-describedby="wilaya-error"
                >
                    <option value="" data-i18n-key="select_wilaya">Sélectionnez une wilaya</option>
                </select>
                <p
                        id="wilaya-error"
                        class="text-red-600 text-sm mt-1 hidden"
                        aria-live="assertive"
                >
                    Veuillez sélectionner une wilaya.
                </p>
            </div>

            <div>
                <label for="product-commune" class="block font-medium mb-1" data-i18n-key="commune_label">
                    Commune
                </label>
                <select
                        id="product-commune"
                        name="commune"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled
                >
                    <option value="" data-i18n-key="select_commune">Sélectionnez une commune</option>
                </select>
            </div>

            <div>
                <label for="product-condition" class="block font-medium mb-1" data-i18n-key="condition_label">
                    État
                </label>
                <select
                        id="product-condition"
                        name="condition"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="new" data-i18n-key="new">Neuf</option>
                    <option value="used" data-i18n-key="used">Occasion</option>
                </select>
            </div>
            
            <div>
                <label for="product-phone" class="block font-medium mb-1" data-i18n-key="phone_label">
                    Numéro de téléphone <span class="text-red-500">*</span>
                </label>
                <input
                        type="tel"
                        id="product-phone"
                        name="phone"
                        required
                        placeholder="Ex: 0555123456"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-describedby="phone-error"
                />
                <p
                        id="phone-error"
                        class="text-red-600 text-sm mt-1 hidden"
                        aria-live="assertive"
                >
                    Veuillez entrer un numéro de téléphone valide.
                </p>
            </div>

            <div>
                <label for="product-price" class="block font-medium mb-1" data-i18n-key="price_label">
                    Prix (DA) <span class="text-red-500">*</span>
                </label>
                <input
                        type="number"
                        id="product-price"
                        name="price"
                        min="0"
                        required
                        placeholder="Ex: 15000"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-describedby="price-error"
                />
                <p
                        id="price-error"
                        class="text-red-600 text-sm mt-1 hidden"
                        aria-live="assertive"
                >
                    Veuillez entrer un prix valide.
                </p>
            </div>

            <div>
                <label for="product-description" class="block font-medium mb-1" data-i18n-key="description_label">
                    Description
                </label>
                <textarea
                        id="product-description"
                        name="description"
                        rows="3"
                        placeholder="Informations supplémentaires..."
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                ></textarea>
            </div>
            
            <div class="text-center">
                <button
                        id="submit-ad-btn"
                        type="submit"
                        class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md disabled:bg-blue-400"
                >
                    <span data-i18n-key="submit_ad_btn_text">Soumettre</span>
                </button>
            </div>
        </form>
    </div>
</div>

<div
        id="auth-modal"
        class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden"
        role="dialog"
        aria-modal="true"
        aria-labelledby="auth-modal-title"
>
    <div
            class="bg-white rounded-lg shadow-lg max-w-sm w-11/12 p-6 relative"
    >
        <button
                id="auth-modal-close-btn"
                class="absolute top-4 right-4 text-gray-600 hover:text-red-600 focus:outline-none"
                aria-label="Fermer le formulaire de connexion"
        >
            <i class="fas fa-times text-2xl"></i>
        </button>
        <h3
                id="auth-modal-title"
                class="text-2xl font-bold mb-6 text-center"
                data-i18n-key="connect"
        >
            Se connecter
        </h3>
        <div class="space-y-4">
            <p class="text-center text-gray-600" data-i18n-key="login_text">Connectez-vous pour accéder à toutes les fonctionnalités.</p>
            <button id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 bg-white border border-gray-300 rounded-full text-gray-700 font-semibold hover:bg-gray-100 transition-colors duration-200 shadow-sm">
                <i class="fab fa-google text-xl mr-2"></i>
                <span data-i18n-key="google_login">Se connecter avec Google</span>
            </button>
        </div>
    </div>
</div>

<template id="home-view-template">
    <section
            class="text-center py-8 sm:py-12 md:py-24 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg mb-8 md:mb-12"
    >
        <h1 class="text-3xl md:text-5xl font-extrabold mb-4" data-i18n-key="hero_title">
            Trouvez la bonne pièce pour votre voiture
        </h1>
        <p
                class="text-lg md:text-xl font-light mb-8"
                data-i18n-key="hero_subtitle"
        >
            Le marché algérien des pièces automobiles le plus fiable.
        </p>
    </section>

    <section class="mb-8 md:mb-12" aria-label="Catégories de pièces">
        <h2
                class="text-2xl md:text-3xl font-bold mb-6 text-center"
                data-i18n-key="categories_title"
        >
            Catégories de Pièces
        </h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-6">
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="engine"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-cogs text-3xl"></i>
                </div>
                <h3 class="font-semibold text-base sm:text-lg" data-i18n-key="category_engine">
                    Moteur
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="brakes"
            >
                <div
                        class="p-2 rounded-full bg-blue-100 text-blue-600 mx-auto w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <img src="https://www.svgrepo.com/show/493547/brake-disc.svg" alt="Brakes Icon" class="w-10 h-10 sm:w-12 sm:h-12">
                </div>
                <h3 class="font-semibold text-base sm:text-lg" data-i18n-key="category_brakes">
                    Freins
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="fuel_system"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-gas-pump text-3xl"></i>
                </div>
                <h3 class="font-semibold text-base sm:text-lg" data-i18n-key="category_fuel_system">
                    Système de carburant
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="cooling"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-fan text-3xl"></i>
                </div>
                <h3 class="font-semibold text-base sm:text-lg" data-i18n-key="category_cooling">
                    Refroidissement
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="tires"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-circle text-3xl"></i>
                </div>
                <h3 class="font-semibold text-base sm:text-lg" data-i18n-key="category_tires">
                    Pneus &amp; Jantes
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="electrical"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-bolt text-3xl"></i>
                </div>
                <h3 class="font-semibold text-base sm:text-lg" data-i18n-key="category_electrical">
                    Électrique
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="body"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-car-side text-3xl"></i>
                </div>
                <h3 class="font-semibold text-base sm:text-lg" data-i18n-key="category_body">
                    Carrosserie
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="tools"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-wrench text-3xl"></i>
                </div>
                <h3 class="font-semibold text-base sm:text-lg" data-i18n-key="category_tools">
                    Outillage
                </h3>
            </a>
        </div>
    </section>

    <section
            class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-12"
            aria-label="Filtrer les annonces"
    >
        <h2 class="text-2xl font-bold mb-6" data-i18n-key="filters_title">
            Filtrer les annonces
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div>
                <label
                        for="brand"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="all_brands"
                >Toutes les marques</label
                >
                <select
                        id="brand"
                        aria-describedby="brand-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="all_brands">
                        Toutes les marques
                    </option>
                </select>
                <p id="brand-desc" class="sr-only">
                    Sélectionnez une marque de voiture pour filtrer les annonces
                </p>
            </div>
            <div id="model-filter-container" class="hidden">
                <label
                        for="model"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="all_models"
                >Tous les modèles</label
                >
                <select
                        id="model"
                        aria-describedby="model-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="all_models">Tous les modèles</option>
                </select>
                <p id="model-desc" class="sr-only">
                    Sélectionnez un modèle pour filtrer les annonces
                </p>
            </div>
            <div>
                <label
                        for="year"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="all_years"
                >Toutes années</label
                >
                <select
                        id="year"
                        aria-describedby="year-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="all_years">Toutes années</option>
                </select>
                <p id="year-desc" class="sr-only">
                    Sélectionnez une année pour filtrer les annonces
                </p>
            </div>
            <div>
                <label
                        for="wilaya"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="all_wilayas"
                >Toutes wilayas</label
                >
                <select
                        id="wilaya"
                        aria-describedby="wilaya-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="all_wilayas">Toutes wilayas</option>
                </select>
                <p id="wilaya-desc" class="sr-only">
                    Sélectionnez une wilaya pour filtrer les annonces
                </p>
            </div>
            <div id="commune-container" class="hidden">
                <label
                        for="commune"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="all_communes"
                >Toutes communes</label
                >
                <select
                        id="commune"
                        aria-describedby="commune-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="all_communes">Toutes communes</option>
                </select>
                <p id="commune-desc" class="sr-only">
                    Sélectionnez une commune pour filtrer les annonces
                </p>
            </div>
            <div>
                <label
                        for="condition"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="condition"
                >État</label
                >
                <select
                        id="condition"
                        aria-describedby="condition-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="any_condition">Tout</option>
                    <option value="new" data-i18n-key="new">Neuf</option>
                    <option value="used" data-i18n-key="used">Occasion</option>
                </select>
                <p id="condition-desc" class="sr-only">
                    Sélectionnez l'état du produit
                </p>
            </div>
        </div>

        <div
                class="mt-6 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 justify-center"
        >
            <button
                    id="filter-apply-btn"
                    class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md"
                    data-i18n-key="apply_filters"
            >
                Appliquer les filtres
            </button>
            <button
                    id="filter-reset-btn"
                    class="w-full sm:w-auto px-6 py-3 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300 transition-colors duration-200 shadow-md"
                    data-i18n-key="reset"
            >
                Réinitialiser
            </button>
        </div>
    </section>

    <section
            id="listings-section"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
            aria-live="polite"
            aria-label="Liste des annonces"
    >
    </section>
</template>

<template id="brands-view-template">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <button id="back-to-home-btn" class="mb-4 text-blue-600 hover:text-blue-800 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_categories">Retour aux catégories</span>
        </button>
        <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center" data-i18n-key="brands_title">Choisissez une marque</h2>
        <div id="brands-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
        </div>
    </div>
</template>

<template id="product-detail-view-template">
    <div id="product-detail" class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <button id="back-to-listings-btn" class="mb-4 text-blue-600 hover:text-blue-800 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_listings">Retour aux annonces</span>
        </button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <img id="product-image-detail" src="" alt="" class="w-full h-80 object-cover rounded-lg shadow-md" />
            <div>
                <h2 id="product-title-detail" class="text-3xl font-bold mb-2"></h2>
                <p id="product-price-detail" class="text-blue-600 font-bold text-2xl mb-4"></p>
                <p id="product-description-detail" class="text-gray-700 mb-6"></p>

                <div class="space-y-2 text-gray-700 text-sm mb-6">
                    <p><strong><span data-i18n-key="brand_label">Marque</span>:</strong> <span id="product-brand-detail"></span></p>
                    <p><strong><span data-i18n-key="model_label">Modèle</span>:</strong> <span id="product-model-detail"></span></p>
                    <p><strong><span data-i18n-key="year_label">Année</span>:</strong> <span id="product-year-detail"></span></p>
                    <p><strong><span data-i18n-key="wilaya_label">Wilaya</span>:</strong> <span id="product-wilaya-detail"></span></p>
                    <p><strong><span data-i18n-key="commune_label">Commune</span>:</strong> <span id="product-commune-detail"></span></p>
                </div>

                <div class="flex flex-col space-y-4">
                    <button id="show-contact-btn" class="w-full px-6 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">
                        <i class="fas fa-phone mr-2"></i>
                        <span data-i18n-key="show_contact">Contacter le Vendeur</span>
                    </button>
                    <button id="add-to-cart-btn" class="w-full px-6 py-3 bg-green-600 text-white rounded-full font-semibold hover:bg-green-700 transition-colors duration-200 shadow-md">
                        <i class="fas fa-cart-plus mr-2"></i>
                        <span data-i18n-key="add_to_cart">Ajouter au panier</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="cart-view-template">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <button id="back-from-cart-btn" class="mb-4 text-blue-600 hover:text-blue-800 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_listings">Retour aux annonces</span>
        </button>
        <h2 class="text-2xl md:text-3xl font-bold mb-6" data-i18n-key="cart_title">Mon panier</h2>
        <div id="cart-items-container" class="space-y-4">
        </div>
        <div id="cart-summary" class="mt-8 pt-4 border-t border-gray-200">
            <p class="text-xl font-bold flex justify-between">
                <span data-i18n-key="cart_total">Total</span>:
                <span id="cart-total-price">0 DA</span>
            </p>
            <button id="checkout-btn" class="w-full mt-4 px-6 py-3 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition-colors duration-200 shadow-md">
                <span data-i18n-key="checkout_btn">Passer à la caisse</span>
            </button>
        </div>
    </div>
</template>

<script type="module">
    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getFirestore, collection, addDoc, query, getDocs, doc, setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    
    // --- App State ---
    let currentUser = null;
    let currentLang = localStorage.getItem("piecety_lang") || "fr";
    let allProducts = [];

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBIptEskV2soajxRYPDfwYFYyz9pWQvZL0",
      authDomain: "piecety-app-b39c4.firebaseapp.com",
      projectId: "piecety-app-b39c4",
      storageBucket: "piecety-app-b39c4.appspot.com",
      messagingSenderId: "265795860915",
      appId: "1:265795860915:web:aa10241788cce42f6373c6"
    };

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // --- Translations ---
    const translations = {
        fr: {
            sell: "Vendre", connect: "Se connecter", logout: "Déconnexion",
            hero_title: "Trouvez la bonne pièce pour votre voiture", hero_subtitle: "Le marché algérien des pièces automobiles le plus fiable.",
            categories_title: "Catégories de Pièces", category_engine: "Moteur", category_brakes: "Freins", category_fuel_system: "Système de carburant", category_cooling: "Refroidissement", category_tires: "Pneus & Jantes", category_electrical: "Électrique", category_body: "Carrosserie", category_tools: "Outillage",
            filters_title: "Filtrer les annonces", all_brands: "Toutes les marques", all_models: "Tous les modèles", all_years: "Toutes années", all_wilayas: "Toutes wilayas", all_communes: "Toutes communes", condition: "État", any_condition: "Tout", new: "Neuf", used: "Occasion", apply_filters: "Appliquer les filtres", reset: "Réinitialiser",
            submit_ad: "Soumettre une annonce rapide", ad_title_label: "Titre de la pièce", brand_label: "Marque", select_brand: "Sélectionnez une marque", other_brand_label: "Autre Marque", model_label: "Modèle", select_model: "Sélectionnez un modèle", year_label: "Année", select_year: "Sélectionnez une année", wilaya_label: "Wilaya", select_wilaya: "Sélectionnez une wilaya", commune_label: "Commune", select_commune: "Sélectionnez une commune", condition_label: "État", price_label: "Prix (DA)", description_label: "Description", submit_ad_btn_text: "Soumettre", phone_label: "Numéro de téléphone",
            login_required: "Veuillez vous connecter pour utiliser cette fonctionnalité.", brands_title: "Choisissez une marque", submitting: "Soumission en cours...",
            back_to_listings: "Retour aux annonces", back_to_categories: "Retour aux catégories", add_to_cart: "Ajouter au panier", show_contact: "Contacter le Vendeur",
            no_listings: "Aucune annonce trouvée.", your_cart_is_empty: "Votre panier est vide.", cart_title: "Mon panier", cart_total: "Total", checkout_btn: "Passer à la caisse"
        },
        en: {
            sell: "Sell", connect: "Log In", logout: "Log Out",
            hero_title: "Find the right car part for your vehicle", hero_subtitle: "The most trusted Algerian car parts marketplace.",
            categories_title: "Parts Categories", category_engine: "Engine", category_brakes: "Brakes", category_fuel_system: "Fuel System", category_cooling: "Cooling", category_tires: "Tires & Rims", category_electrical: "Electrical", category_body: "Body", category_tools: "Tools",
            filters_title: "Filter Listings", all_brands: "All brands", all_models: "All models", all_years: "All years", all_wilayas: "All wilayas", all_communes: "All communes", condition: "Condition", any_condition: "Any", new: "New", used: "Used", apply_filters: "Apply Filters", reset: "Reset",
            submit_ad: "Submit a quick ad", ad_title_label: "Part Title", brand_label: "Brand", select_brand: "Select a brand", other_brand_label: "Other Brand", model_label: "Model", select_model: "Select a model", year_label: "Year", select_year: "Select a year", wilaya_label: "Wilaya", select_wilaya: "Select a wilaya", commune_label: "Commune", select_commune: "Select a commune", condition_label: "Condition", price_label: "Price (DA)", description_label: "Description", submit_ad_btn_text: "Submit", phone_label: "Phone Number",
            login_required: "Please log in to use this feature.", brands_title: "Choose a brand", submitting: "Submitting...",
            back_to_listings: "Back to listings", back_to_categories: "Back to Categories", add_to_cart: "Add to cart", show_contact: "Contact Seller",
            no_listings: "No listings found.", your_cart_is_empty: "Your cart is empty.", cart_title: "My Cart", cart_total: "Total", checkout_btn: "Proceed to Checkout"
        },
        ar: {
            sell: "بيع", connect: "تسجيل الدخول", logout: "تسجيل الخروج",
            hero_title: "ابحث عن قطعة الغيار المناسبة لسيارتك", hero_subtitle: "أكثر أسواق قطع غيار السيارات ثقة في الجزائر.",
            categories_title: "فئات القطع", category_engine: "محرك", category_brakes: "مكابح", category_fuel_system: "نظام الوقود", category_cooling: "التبريد", category_tires: "الإطارات والعجلات", category_electrical: "كهربائي", category_body: "هيكل", category_tools: "أدوات",
            filters_title: "تصفية الإعلانات", all_brands: "جميع الماركات", all_models: "جميع الموديلات", all_years: "جميع السنوات", all_wilayas: "جميع الولايات", all_communes: "جميع البلديات", condition: "الحالة", any_condition: "الكل", new: "جديد", used: "مستعمل", apply_filters: "تطبيق الفلاتر", reset: "إعادة تعيين",
            submit_ad: "إرسال إعلان سريع", ad_title_label: "عنوان القطعة", brand_label: "الماركة", select_brand: "اختر ماركة", other_brand_label: "ماركة أخرى", model_label: "الموديل", select_model: "اختر موديل", year_label: "السنة", select_year: "اختر سنة", wilaya_label: "الولاية", select_wilaya: "اختر ولاية", commune_label: "البلدية", select_commune: "اختر بلدية", condition_label: "الحالة", price_label: "السعر (دج)", description_label: "الوصف", submit_ad_btn_text: "إرسال", phone_label: "رقم الهاتف",
            login_required: "يرجى تسجيل الدخول لاستخدام هذه الميزة.", brands_title: "اختر ماركة", submitting: "...جاري الإرسال",
            back_to_listings: "العودة إلى الإعلانات", back_to_categories: "العودة إلى الفئات", add_to_cart: "أضف إلى السلة", show_contact: "اتصل بالبائع",
            no_listings: "لم يتم العثور على إعلانات.", your_cart_is_empty: "سلة التسوق فارغة.", cart_title: "سلة التسوق", cart_total: "الإجمالي", checkout_btn: "الدفع"
        }
    };

    // --- Static Data ---
    const wilayas = {"Adrar": ["Adrar", "Charouine"], "Chlef": ["Chlef", "Ténès"], "Laghouat": ["Laghouat", "Aflou"], "Oum El Bouaghi": ["Oum El Bouaghi", "Aïn Beïda"], "Batna": ["Batna", "Barika"], "Béjaïa": ["Béjaïa", "Akbou"], "Biskra": ["Biskra", "Tolga"], "Béchar": ["Béchar", "Abadla"], "Blida": ["Blida", "Boufarik"], "Bouira": ["Bouira", "Lakhdaria"], "Tamanrasset": ["Tamanrasset", "In Salah"], "Tébessa": ["Tébessa", "Chéria"], "Tlemcen": ["Tlemcen", "Maghnia"], "Tiaret": ["Tiaret", "Frenda"], "Tizi Ouzou": ["Tizi Ouzou", "Azazga"], "Alger": ["Alger Centre", "Bab El Oued", "Hydra"], "Djelfa": ["Djelfa", "Messaad"], "Jijel": ["Jijel", "Taher"], "Sétif": ["Sétif", "El Eulma"], "Saïda": ["Saïda"], "Skikda": ["Skikda", "Azzaba"], "Sidi Bel Abbès": ["Sidi Bel Abbès", "Telagh"], "Annaba": ["Annaba", "El Bouni"], "Guelma": ["Guelma", "Oued Zenati"], "Constantine": ["Constantine", "El Khroub"], "Médéa": ["Médéa", "Berrouaghia"], "Mostaganem": ["Mostaganem", "Sidi Ali"], "M'Sila": ["M'Sila", "Bou Saâda"], "Mascara": ["Mascara", "Tighennif"], "Ouargla": ["Ouargla", "Hassi Messaoud"], "Oran": ["Oran", "Es Senia"], "El Bayadh": ["El Bayadh"], "Illizi": ["Illizi", "Djanet"], "Bordj Bou Arréridj": ["Bordj Bou Arréridj"], "Boumerdès": ["Boumerdès", "Réghaïa"], "El Tarf": ["El Tarf", "El Kala"], "Tindouf": ["Tindouf"], "Tissemsilt": ["Tissemsilt", "Théniet El Had"], "El Oued": ["El Oued", "Guemar"], "Khenchela": ["Khenchela", "Kaïs"], "Souk Ahras": ["Souk Ahras"], "Tipaza": ["Tipaza", "Cherchell"], "Mila": ["Mila", "Ferdjioua"], "Aïn Defla": ["Aïn Defla", "Khemis Miliana"], "Naâma": ["Naâma", "Mécheria"], "Aïn Témouchent": ["Aïn Témouchent", "Béni Saf"], "Ghardaïa": ["Ghardaïa", "Metlili"], "Relizane": ["Relizane", "Oued Rhiou"]};
    const car_data = {"Toyota": {models: ["Yaris", "Corolla", "Hilux"]}, "Peugeot": {models: ["208", "308", "301"]}, "Volkswagen": {models: ["Golf", "Polo", "Passat"]}, "Renault": {models: ["Clio", "Megane", "Symbol"]},"Hyundai": {models: ["i10", "i20", "Accent"]}, "Nissan": {models: ["Micra", "Sunny"]}, "Fiat": {models: ["500", "Tipo"]}, "Citroën": {models: ["C3", "C-Elysée"]}, "Kia": {models: ["Picanto", "Rio"]}, "Mercedes-Benz": {models: ["Class A", "Class C"]}, "BMW": {models: ["Series 1", "Series 3"]}, "Audi": {models: ["A3", "A4"]}, "Dacia": {models: ["Logan", "Sandero", "Duster"]}};
    const currentYear = new Date().getFullYear();
    const years = Array.from({ length: currentYear - 1979 }, (_, i) => currentYear - i);

    // --- DOM References ---
    const appContainer = document.getElementById("app-container");

    // --- Utility Functions ---
    const showMessage = (msg, type = "info") => {
        const messageBox = document.getElementById("message-box");
        messageBox.textContent = msg;
        messageBox.className = `message-box show ${type === "error" ? "bg-red-100 text-red-800" : "bg-green-100 text-green-800"}`;
        setTimeout(() => messageBox.classList.remove("show"), 3500);
    };

    const translatePage = (lang) => {
        document.getElementById("current-lang").textContent = lang.toUpperCase();
        document.body.setAttribute("dir", lang === "ar" ? "rtl" : "ltr");
        document.querySelectorAll("[data-i18n-key]").forEach(el => {
            const key = el.getAttribute("data-i18n-key");
            if(translations[lang]?.[key]) {
                if(el.placeholder !== undefined) el.placeholder = translations[lang][key];
                else el.innerHTML = translations[lang][key];
            }
        });
    };

    const populateSelect = (selectEl, options, defaultLabelKey, lang, addOtherOption = false) => {
        if (!selectEl) return;
        selectEl.innerHTML = `<option value="">${translations[lang][defaultLabelKey]}</option>`;
        options.forEach(opt => selectEl.insertAdjacentHTML('beforeend', `<option value="${opt}">${opt}</option>`));
        if (addOtherOption) {
            selectEl.insertAdjacentHTML('beforeend', `<option value="other">${translations[lang].other_brand_label}</option>`);
        }
    };

    // --- View Rendering ---
    const renderView = (viewName, data = null) => {
        appContainer.innerHTML = '';
        const template = document.getElementById(`${viewName}-view-template`);
        if (template) {
            appContainer.appendChild(template.content.cloneNode(true));
            const renderFunctions = {'home': renderHomePage, 'brands': renderBrandsPage, 'product-detail': renderProductPage, 'cart': renderCartPage};
            renderFunctions[viewName]?.(data);
        } else {
            renderView('home');
        }
        translatePage(currentLang);
    };
    
    const renderHomePage = () => {
        const brandFilter = document.getElementById('brand');
        const modelFilterContainer = document.getElementById('model-filter-container');
        populateSelect(brandFilter, Object.keys(car_data), "all_brands", currentLang);
        populateSelect(document.getElementById('year'), years, "all_years", currentLang);
        populateSelect(document.getElementById('wilaya'), Object.keys(wilayas), "all_wilayas", currentLang);
        document.querySelectorAll('.category-link').forEach(link => link.addEventListener('click', e => { e.preventDefault(); renderView('brands'); }));
        brandFilter.addEventListener('change', () => {
            const modelFilter = document.getElementById('model');
            if (brandFilter.value && car_data[brandFilter.value]) {
                populateSelect(modelFilter, car_data[brandFilter.value].models, "all_models", currentLang);
                modelFilterContainer.classList.remove("hidden");
                modelFilter.disabled = false;
            } else {
                modelFilterContainer.classList.add("hidden");
                modelFilter.disabled = true;
            }
        });
        document.getElementById('filter-apply-btn').addEventListener('click', renderListings);
        document.getElementById('filter-reset-btn').addEventListener('click', () => {
            document.getElementById('brand').value = ''; document.getElementById('model').value = ''; document.getElementById('year').value = '';
            document.getElementById('wilaya').value = ''; document.getElementById('search-input').value = '';
            modelFilterContainer.classList.add('hidden');
            renderListings();
        });
        renderListings();
    };
    
    const renderBrandsPage = () => {
        const brandsGrid = document.getElementById('brands-grid');
        document.getElementById('back-to-home-btn').addEventListener('click', () => renderView('home'));
        brandsGrid.innerHTML = Object.keys(car_data).map(brandName => `
            <div class="brand-card bg-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center cursor-pointer hover:shadow-xl hover:scale-105 transition-transform duration-200" data-brand="${brandName}">
                <span class="font-semibold text-gray-700">${brandName}</span>
            </div>`).join('');
        brandsGrid.querySelectorAll('.brand-card').forEach(card => card.addEventListener('click', () => {
            renderView('home');
            setTimeout(() => {
                const brandFilter = document.getElementById('brand');
                if(brandFilter) {
                    brandFilter.value = card.dataset.brand;
                    brandFilter.dispatchEvent(new Event('change'));
                    renderListings();
                }
            }, 100);
        }));
    };

    const renderProductPage = (product) => {
        if (!product) { renderView('home'); return; }
        document.getElementById('product-image-detail').src = product.imageUrl || 'https://via.placeholder.com/600x400.png?text=No+Image';
        document.getElementById('product-title-detail').textContent = product.title;
        document.getElementById('product-price-detail').textContent = `${product.price.toLocaleString()} DA`;
        document.getElementById('product-description-detail').textContent = product.description;
        document.getElementById('product-brand-detail').textContent = product.brand;
        document.getElementById('product-model-detail').textContent = product.model || "-";
        document.getElementById('product-year-detail').textContent = product.year || "-";
        document.getElementById('product-wilaya-detail').textContent = product.wilaya;
        document.getElementById('product-commune-detail').textContent = product.commune || "-";
        document.getElementById('back-to-listings-btn').addEventListener('click', () => renderView('home'));
        const contactBtn = document.getElementById('show-contact-btn');
        contactBtn.addEventListener('click', () => {
            if (product.phoneNumber) {
                contactBtn.outerHTML = `<a href="tel:${product.phoneNumber}" class="${contactBtn.className}"><i class="fas fa-phone mr-2"></i> ${product.phoneNumber}</a>`;
            } else {
                contactBtn.textContent = 'Contact non disponible';
                contactBtn.disabled = true;
            }
        }, { once: true });
    };

    // JS FIX: Added the missing renderCartPage function to prevent the app from crashing.
    const renderCartPage = () => {
        const cartItemsContainer = document.getElementById('cart-items-container');
        document.getElementById('back-from-cart-btn').addEventListener('click', () => renderView('home'));
        if (cartItemsContainer) {
            cartItemsContainer.innerHTML = `<p class="text-center text-gray-500" data-i18n-key="your_cart_is_empty"></p>`;
            translatePage(currentLang);
        }
    };

    // --- Data & Logic ---
    const renderListings = async () => {
        const listingsSection = document.getElementById('listings-section');
        listingsSection.innerHTML = `<p class="col-span-full text-center py-6 text-gray-600">Chargement...</p>`;
        try {
            if (allProducts.length === 0) {
                const querySnapshot = await getDocs(query(collection(db, "products")));
                allProducts = querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
            }
            displayProducts(filterProducts(allProducts), listingsSection);
        } catch (err) {
            listingsSection.innerHTML = `<p class="col-span-full text-center py-6 text-red-600">Erreur de chargement des annonces.</p>`;
        }
    };
    
    const filterProducts = (products) => {
        const brand = document.getElementById('brand')?.value;
        const searchTerm = document.getElementById('search-input')?.value.toLowerCase();
        return products.filter(p => 
            (!brand || p.brand === brand) &&
            (!searchTerm || p.title.toLowerCase().includes(searchTerm))
        );
    };

    const displayProducts = (products, container) => {
        container.innerHTML = "";
        if (products.length === 0) {
            container.innerHTML = `<p class="col-span-full text-center py-6 text-gray-600" data-i18n-key="no_listings"></p>`;
            translatePage(currentLang);
            return;
        }
        products.forEach(item => {
            const card = document.createElement("article");
            card.className = "bg-white rounded-lg shadow-md overflow-hidden flex flex-col cursor-pointer hover:shadow-xl transition-shadow duration-300";
            card.addEventListener('click', () => renderView('product-detail', item));
            card.innerHTML = `
                <img src="${item.imageUrl || 'https://via.placeholder.com/300x200.png?text=No+Image'}" alt="${item.title}" class="w-full h-40 sm:h-48 object-cover" loading="lazy" />
                <div class="p-4 flex-1 flex flex-col">
                    <h3 class="font-semibold text-lg mb-1">${item.title}</h3>
                    <p class="text-blue-600 font-bold text-lg mt-auto pt-2">${item.price.toLocaleString()} DA</p>
                </div>`;
            container.appendChild(card);
        });
    };
    
    const handleSellFormSubmit = async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = form.querySelector('#submit-ad-btn');
        let isValid = true;
        form.querySelectorAll('[required]').forEach(input => { if (!input.value) isValid = false; });
        if (!isValid) { showMessage("Veuillez remplir tous les champs obligatoires.", "error"); return; }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span>${translations[currentLang].submitting}</span>`;
        
        try {
            const formData = new FormData(form);
            let brand = formData.get('brand');
            if (brand === 'other') brand = formData.get('brand-other');
            const newProduct = { 
                title: formData.get('title'), brand,
                model: formData.get('model'), year: formData.get('year'),
                wilaya: formData.get('wilaya'), commune: formData.get('commune'),
                condition: formData.get('condition'), price: parseInt(formData.get('price')) || 0,
                phoneNumber: formData.get('phone'), description: formData.get('description'),
                imageUrl: 'https://via.placeholder.com/300x200.png?text=No+Image', // Placeholder since upload is removed
                timestamp: new Date(), sellerId: currentUser.uid
            };
            await addDoc(collection(db, "products"), newProduct);
            showMessage("Annonce soumise avec succès!", "success");
            form.reset();
            document.getElementById('post-product-modal').classList.add('hidden');
            allProducts = []; // Refresh cache
            renderView('home');
        } catch (error) {
            showMessage("Erreur lors de la soumission.", "error");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<span>${translations[currentLang].submit_ad_btn_text}</span>`;
        }
    };
    
    // --- Initial Setup ---
    const setupGlobalEventListeners = () => {
        document.getElementById('lang-dropdown-btn').addEventListener('click', () => document.getElementById('lang-dropdown').classList.toggle('hidden'));
        document.querySelectorAll(".lang-btn").forEach(btn => btn.addEventListener('click', (e) => {
            currentLang = e.target.dataset.lang;
            localStorage.setItem('piecety_lang', currentLang);
            translatePage(currentLang);
            document.getElementById('lang-dropdown').classList.add('hidden');
        }));
        document.getElementById('modal-close-btn').addEventListener('click', () => document.getElementById('post-product-modal').classList.add('hidden'));
        document.getElementById('auth-modal-close-btn').addEventListener('click', () => document.getElementById('auth-modal').classList.add('hidden'));
        const openSellModal = () => { if (currentUser) document.getElementById('post-product-modal').classList.remove('hidden'); else document.getElementById('auth-modal').classList.remove('hidden'); };
        document.getElementById('sell-link').addEventListener('click', openSellModal);
        document.getElementById('sell-link-mobile').addEventListener('click', openSellModal);
        document.getElementById('mobile-menu-btn').addEventListener('click', () => document.getElementById('mobile-menu').classList.remove('hidden'));
        document.getElementById('mobile-menu-close-btn').addEventListener('click', () => document.getElementById('mobile-menu').classList.add('hidden'));
        document.getElementById('home-link').addEventListener('click', (e) => { e.preventDefault(); renderView('home'); });
        document.getElementById('cart-btn').addEventListener('click', () => renderView('cart'));

        const postProductForm = document.getElementById('post-product-form');
        const brandSelect = postProductForm.querySelector('#product-brand');
        populateSelect(brandSelect, Object.keys(car_data), "select_brand", currentLang, true);
        populateSelect(postProductForm.querySelector('#product-year'), years, "select_year", currentLang);
        populateSelect(postProductForm.querySelector('#product-wilaya'), Object.keys(wilayas), "select_wilaya", currentLang);
        brandSelect.addEventListener('change', () => {
            const modelSelect = postProductForm.querySelector('#product-model');
            if (brandSelect.value === 'other') {
                postProductForm.querySelector('#other-brand-container').classList.remove('hidden'); modelSelect.disabled = true;
            } else {
                postProductForm.querySelector('#other-brand-container').classList.add('hidden');
                if (brandSelect.value && car_data[brandSelect.value]) {
                    populateSelect(modelSelect, car_data[brandSelect.value].models, "select_model", currentLang); modelSelect.disabled = false;
                } else { modelSelect.disabled = true; }
            }
        });
        postProductForm.addEventListener('submit', handleSellFormSubmit);
    };

    const bootApp = () => {
        document.getElementById('current-year').textContent = new Date().getFullYear();
        setupGlobalEventListeners();
        onAuthStateChanged(auth, user => {
            currentUser = user;
            const authLinks = document.getElementById('auth-links');
            const mobileAuthBtn = document.getElementById('auth-btn-mobile');
            if (user) {
                authLinks.innerHTML = `<button id="signout-btn" class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-full font-semibold" data-i18n-key="logout"></button>`;
                authLinks.querySelector('#signout-btn').addEventListener('click', () => signOut(auth));
                mobileAuthBtn.setAttribute('data-i18n-key', 'logout');
                mobileAuthBtn.onclick = () => { signOut(auth); document.getElementById('mobile-menu').classList.add('hidden'); };
            } else {
                authLinks.innerHTML = `<button id="login-btn" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-full font-semibold" data-i18n-key="connect"></button>`;
                const openAuthModal = () => document.getElementById('auth-modal').classList.remove('hidden');
                authLinks.querySelector('#login-btn').addEventListener('click', openAuthModal);
                mobileAuthBtn.setAttribute('data-i18n-key', 'connect');
                mobileAuthBtn.onclick = openAuthModal;
            }
            translatePage(currentLang);
        });
        document.getElementById('google-login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider).then(() => document.getElementById('auth-modal').classList.add('hidden'));
        });
        renderView('home');
    };

    bootApp();
</script>
    
</body>
</html>
