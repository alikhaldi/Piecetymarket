<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Piecety - Marché des Pièces Auto en Algérie</title>
    
    <link rel="icon" type="image/svg+xml" href="https://www.svgrepo.com/show/493547/brake-disc.svg">

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.5s ease-in-out;
            opacity: 0;
            transform: translateX(100%);
            max-width: 300px;
            word-wrap: break-word;
        }
        .message-box.show {
            opacity: 1;
            transform: translateX(0);
        }
        .category-card:hover .category-icon {
            transform: scale(1.1);
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.4);
        }
        /* RTL-specific styles */
        body[dir="rtl"] .logo {
            text-align: right;
        }
        body[dir="rtl"] .flex-1.mx-4.sm\:mx-8 {
            margin-right: 0.5rem;
            margin-left: 0.5rem;
        }
        body[dir="rtl"] .fa-search {
            right: 3px;
            left: auto;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">

<div id="message-box" class="message-box bg-white text-gray-800"></div>

<header
        class="bg-white shadow-sm sticky top-0 z-50"
        role="banner"
>
    <div
            class="container mx-auto p-4 flex items-center justify-between"
    >
        <a href="#" id="home-link" class="text-3xl font-bold text-blue-600 logo cursor-pointer">
            Piecety
        </a>

        <div class="flex-1 mx-4 sm:mx-8">
            <div class="relative">
                <input
                        id="search-input"
                        type="text"
                        placeholder="Rechercher une pièce..."
                        class="w-full p-3 pl-10 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 shadow-inner"
                        aria-label="Rechercher une pièce"
                />
                <i
                        class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                ></i>
            </div>
        </div>

        <nav class="hidden md:flex items-center space-x-6" role="navigation" aria-label="Main navigation">
            <div class="relative group">
                <button
                        id="lang-dropdown-btn"
                        aria-haspopup="true"
                        aria-expanded="false"
                        class="flex items-center space-x-1 font-medium text-gray-600 hover:text-blue-600 transition-colors duration-200"
                >
                    <span id="current-lang" class="lang-text">FR</span>
                    <i class="fas fa-chevron-down text-xs"></i>
                </button>
                <div
                        id="lang-dropdown"
                        class="absolute right-0 mt-2 w-28 bg-white rounded-lg shadow-lg py-1 hidden transition-all duration-300 z-10"
                        role="menu"
                        aria-label="Select Language"
                >
                    <button
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 lang-btn"
                            data-lang="fr"
                            role="menuitem"
                    >
                        Français
                    </button>
                    <button
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 lang-btn"
                            data-lang="en"
                            role="menuitem"
                    >
                        English
                    </button>
                    <button
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 lang-btn"
                            data-lang="ar"
                            role="menuitem"
                    >
                        العربية
                    </button>
                </div>
            </div>
            <a
                    href="#"
                    class="text-gray-600 hover:text-blue-600 font-medium transition-colors duration-200"
                    data-i18n-key="sell"
                    id="sell-link"
            >Vendre</a
            >
            <button
                    id="cart-btn"
                    class="relative p-2 text-gray-600 hover:text-blue-600 focus:outline-none"
            >
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
            </button>
            <div id="auth-links" class="flex items-center space-x-4">
                <button
                        id="login-btn"
                        class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-full font-semibold transition-colors duration-200 shadow-md"
                        data-i18n-key="connect"
                >
                    Se connecter
                </button>
            </div>
        </nav>

        <button
                id="mobile-menu-btn"
                class="md:hidden p-2 text-gray-600 hover:text-blue-600 focus:outline-none"
                aria-label="Menu"
                aria-expanded="false"
                aria-controls="mobile-menu"
        >
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>
</header>

<div
        id="mobile-menu"
        class="fixed inset-0 bg-white z-40 hidden flex-col p-6 space-y-6 md:hidden"
        role="dialog"
        aria-modal="true"
        aria-labelledby="mobile-menu-label"
>
    <div class="flex justify-between items-center">
        <h2
                id="mobile-menu-label"
                class="text-2xl font-bold text-blue-600"
                data-i18n-key="menu"
        >
            Menu
        </h2>
        <button
                id="mobile-menu-close-btn"
                class="text-gray-600 hover:text-blue-600"
                aria-label="Fermer menu"
        >
            <i class="fas fa-times text-xl"></i>
        </button>
    </div>
    <a
            href="#"
            class="text-xl font-medium text-gray-800 hover:text-blue-600"
            data-i18n-key="sell"
            id="sell-link-mobile"
    >Vendre</a
    >
    <button
            id="auth-btn-mobile"
            class="text-xl font-medium text-gray-800 hover:text-blue-600 text-left"
            data-i18n-key="connect"
    >
        Se connecter
    </button>

    <div class="pt-4 border-t border-gray-200">
        <h3 class="text-lg font-semibold text-gray-600" data-i18n-key="language">
            Langue
        </h3>
        <div class="flex space-x-4 mt-2">
            <button
                    class="p-2 border rounded-md text-sm font-medium lang-btn"
                    data-lang="fr"
            >
                Français
            </button>
            <button
                    class="p-2 border rounded-md text-sm font-medium lang-btn"
                    data-lang="en"
            >
                English
            </button>
            <button
                    class="p-2 border rounded-md text-sm font-medium lang-btn"
                    data-lang="ar"
            >
                العربية
            </button>
        </div>
    </div>
</div>

<main
        id="app-container"
        class="flex-1 container mx-auto p-4 md:p-8"
        role="main"
        aria-live="polite"
>
</main>

<footer class="bg-gray-800 text-white p-6 md:p-8 mt-auto text-center">
    <p class="text-sm font-light" data-i18n-key="footer_text">
        &copy; <span id="current-year"></span> Piecety - Marché des Pièces Auto en
        Algérie. Tous droits réservés.
    </p>
</footer>

<div
        id="post-product-modal"
        class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modal-title"
>
    <div
            class="bg-white rounded-lg shadow-lg max-w-2xl w-11/12 max-h-[90vh] overflow-y-auto p-6 relative"
    >
        <button
                id="modal-close-btn"
                class="absolute top-4 right-4 text-gray-600 hover:text-red-600 focus:outline-none"
                aria-label="Fermer le formulaire"
        >
            <i class="fas fa-times text-2xl"></i>
        </button>
        <h3
                id="modal-title"
                class="text-2xl font-bold mb-6 text-center"
                data-i18n-key="submit_ad"
        >
            Soumettre une annonce rapide
        </h3>
        <form id="post-product-form" class="space-y-4" novalidate>
            <div>
                <label for="product-title" class="block font-medium mb-1" data-i18n-key="ad_title_label">
                    Titre de la pièce <span class="text-red-500">*</span>
                </label>
                <input
                        type="text"
                        id="product-title"
                        name="title"
                        required
                        placeholder="Ex: Disque de frein avant"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-describedby="title-error"
                />
                <p
                        id="title-error"
                        class="text-red-600 text-sm mt-1 hidden"
                        aria-live="assertive"
                >
                    Veuillez entrer un titre valide.
                </p>
            </div>

            <div>
                <label for="product-brand" class="block font-medium mb-1" data-i18n-key="brand_label">
                    Marque <span class="text-red-500">*</span>
                </label>
                <select
                        id="product-brand"
                        name="brand"
                        required
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-describedby="brand-error"
                >
                    <option value="" data-i18n-key="select_brand">Sélectionnez une marque</option>
                </select>
                <p
                        id="brand-error"
                        class="text-red-600 text-sm mt-1 hidden"
                        aria-live="assertive"
                >
                    Veuillez sélectionner une marque.
                </p>
            </div>
            
            <div id="other-brand-container" class="hidden">
                 <label for="product-brand-other" class="block font-medium mb-1" data-i18n-key="other_brand_label">
                    Autre Marque <span class="text-red-500">*</span>
                </label>
                <input
                        type="text"
                        id="product-brand-other"
                        name="brand-other"
                        placeholder="Entrez la marque"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
            </div>

            <div>
                <label for="product-model" class="block font-medium mb-1" data-i18n-key="model_label">
                    Modèle
                </label>
                <select
                        id="product-model"
                        name="model"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled
                >
                    <option value="" data-i18n-key="select_model">Sélectionnez un modèle</option>
                </select>
            </div>

            <div>
                <label for="product-year" class="block font-medium mb-1" data-i18n-key="year_label">
                    Année
                </label>
                <select
                        id="product-year"
                        name="year"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="" data-i18n-key="select_year">Sélectionnez une année</option>
                </select>
            </div>

            <div>
                <label for="product-wilaya" class="block font-medium mb-1" data-i18n-key="wilaya_label">
                    Wilaya <span class="text-red-500">*</span>
                </label>
                <select
                        id="product-wilaya"
                        name="wilaya"
                        required
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-describedby="wilaya-error"
                >
                    <option value="" data-i18n-key="select_wilaya">Sélectionnez une wilaya</option>
                </select>
                <p
                        id="wilaya-error"
                        class="text-red-600 text-sm mt-1 hidden"
                        aria-live="assertive"
                >
                    Veuillez sélectionner une wilaya.
                </p>
            </div>

            <div>
                <label for="product-commune" class="block font-medium mb-1" data-i18n-key="commune_label">
                    Commune
                </label>
                <select
                        id="product-commune"
                        name="commune"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled
                >
                    <option value="" data-i18n-key="select_commune">Sélectionnez une commune</option>
                </select>
            </div>

            <div>
                <label for="product-condition" class="block font-medium mb-1" data-i18n-key="condition_label">
                    État
                </label>
                <select
                        id="product-condition"
                        name="condition"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="new" data-i18n-key="new">Neuf</option>
                    <option value="used" data-i18n-key="used">Occasion</option>
                </select>
            </div>
            
            <div>
                <label for="product-phone" class="block font-medium mb-1" data-i18n-key="phone_label">
                    Numéro de téléphone <span class="text-red-500">*</span>
                </label>
                <input
                        type="tel"
                        id="product-phone"
                        name="phone"
                        required
                        placeholder="Ex: 0555123456"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-describedby="phone-error"
                />
                <p
                        id="phone-error"
                        class="text-red-600 text-sm mt-1 hidden"
                        aria-live="assertive"
                >
                    Veuillez entrer un numéro de téléphone valide.
                </p>
            </div>

            <div>
                <label for="product-price" class="block font-medium mb-1" data-i18n-key="price_label">
                    Prix (DA) <span class="text-red-500">*</span>
                </label>
                <input
                        type="number"
                        id="product-price"
                        name="price"
                        min="0"
                        required
                        placeholder="Ex: 15000"
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-describedby="price-error"
                />
                <p
                        id="price-error"
                        class="text-red-600 text-sm mt-1 hidden"
                        aria-live="assertive"
                >
                    Veuillez entrer un prix valide.
                </p>
            </div>

            <div>
                <label for="product-description" class="block font-medium mb-1" data-i18n-key="description_label">
                    Description
                </label>
                <textarea
                        id="product-description"
                        name="description"
                        rows="3"
                        placeholder="Informations supplémentaires..."
                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                ></textarea>
            </div>
            
            <div>
                <label for="product-image" class="block font-medium mb-1" data-i18n-key="image_label">
                    Image de la pièce
                </label>
                <input
                        type="file"
                        id="product-image"
                        name="image"
                        accept="image/*"
                        class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
                <div id="image-preview-container" class="mt-2"></div>
            </div>

            <div class="text-center">
                <button
                        id="submit-ad-btn"
                        type="submit"
                        class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md disabled:bg-blue-400"
                >
                    <span data-i18n-key="submit_ad_btn_text">Soumettre</span>
                </button>
            </div>
        </form>
    </div>
</div>

<div
        id="auth-modal"
        class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden"
        role="dialog"
        aria-modal="true"
        aria-labelledby="auth-modal-title"
>
    <div
            class="bg-white rounded-lg shadow-lg max-w-sm w-11/12 p-6 relative"
    >
        <button
                id="auth-modal-close-btn"
                class="absolute top-4 right-4 text-gray-600 hover:text-red-600 focus:outline-none"
                aria-label="Fermer le formulaire de connexion"
        >
            <i class="fas fa-times text-2xl"></i>
        </button>
        <h3
                id="auth-modal-title"
                class="text-2xl font-bold mb-6 text-center"
                data-i18n-key="connect"
        >
            Se connecter
        </h3>
        <div class="space-y-4">
            <p class="text-center text-gray-600" data-i18n-key="login_text">Connectez-vous pour accéder à toutes les fonctionnalités.</p>
            <button id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 bg-white border border-gray-300 rounded-full text-gray-700 font-semibold hover:bg-gray-100 transition-colors duration-200 shadow-sm">
                <i class="fab fa-google text-xl mr-2"></i>
                <span data-i18n-key="google_login">Se connecter avec Google</span>
            </button>
        </div>
    </div>
</div>

<template id="home-view-template">
    <section
            class="text-center py-12 md:py-24 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg mb-8 md:mb-12"
    >
        <h1 class="text-3xl md:text-5xl font-extrabold mb-4" data-i18n-key="hero_title">
            Trouvez la bonne pièce pour votre voiture
        </h1>
        <p
                class="text-lg md:text-xl font-light mb-8"
                data-i18n-key="hero_subtitle"
        >
            Le marché algérien des pièces automobiles le plus fiable.
        </p>
    </section>

    <section class="mb-8 md:mb-12" aria-label="Catégories de pièces">
        <h2
                class="text-2xl md:text-3xl font-bold mb-6 text-center"
                data-i18n-key="categories_title"
        >
            Catégories de Pièces
        </h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-6">
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="engine"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-16 h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-cogs text-3xl"></i>
                </div>
                <h3 class="font-semibold text-lg" data-i18n-key="category_engine">
                    Moteur
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="brakes"
            >
                <div
                        class="p-2 rounded-full bg-blue-100 text-blue-600 mx-auto w-16 h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <img src="https://www.svgrepo.com/show/493547/brake-disc.svg" alt="Brakes Icon" class="w-12 h-12">
                </div>
                <h3 class="font-semibold text-lg" data-i18n-key="category_brakes">
                    Freins
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="fuel_system"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-16 h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-gas-pump text-3xl"></i>
                </div>
                <h3 class="font-semibold text-lg" data-i18n-key="category_fuel_system">
                    Système de carburant
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="cooling"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-16 h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-fan text-3xl"></i>
                </div>
                <h3 class="font-semibold text-lg" data-i18n-key="category_cooling">
                    Refroidissement
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="tires"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-16 h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-circle text-3xl"></i>
                </div>
                <h3 class="font-semibold text-lg" data-i18n-key="category_tires">
                    Pneus &amp; Jantes
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="electrical"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-16 h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-bolt text-3xl"></i>
                </div>
                <h3 class="font-semibold text-lg" data-i18n-key="category_electrical">
                    Électrique
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="body"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-16 h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-car-side text-3xl"></i>
                </div>
                <h3 class="font-semibold text-lg" data-i18n-key="category_body">
                    Carrosserie
                </h3>
            </a>
            <a
                    href="#"
                    class="category-link bg-white rounded-xl shadow-md p-4 text-center transform transition-transform duration-300 hover:scale-105 hover:shadow-xl category-card"
                    data-category="tools"
            >
                <div
                        class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-16 h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon"
                >
                    <i class="fas fa-wrench text-3xl"></i>
                </div>
                <h3 class="font-semibold text-lg" data-i18n-key="category_tools">
                    Outillage
                </h3>
            </a>
        </div>
    </section>

    <section
            class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-12"
            aria-label="Filtrer les annonces"
    >
        <h2 class="text-2xl font-bold mb-6" data-i18n-key="filters_title">
            Filtrer les annonces
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div>
                <label
                        for="brand"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="all_brands"
                >Toutes les marques</label
                >
                <select
                        id="brand"
                        aria-describedby="brand-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="all_brands">
                        Toutes les marques
                    </option>
                </select>
                <p id="brand-desc" class="sr-only">
                    Sélectionnez une marque de voiture pour filtrer les annonces
                </p>
            </div>
            <div id="model-filter-container" class="hidden">
                <label
                        for="model"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="all_models"
                >Tous les modèles</label
                >
                <select
                        id="model"
                        aria-describedby="model-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="all_models">Tous les modèles</option>
                </select>
                <p id="model-desc" class="sr-only">
                    Sélectionnez un modèle pour filtrer les annonces
                </p>
            </div>
            <div>
                <label
                        for="year"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="all_years"
                >Toutes années</label
                >
                <select
                        id="year"
                        aria-describedby="year-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="all_years">Toutes années</option>
                </select>
                <p id="year-desc" class="sr-only">
                    Sélectionnez une année pour filtrer les annonces
                </p>
            </div>
            <div>
                <label
                        for="wilaya"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="all_wilayas"
                >Toutes wilayas</label
                >
                <select
                        id="wilaya"
                        aria-describedby="wilaya-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="all_wilayas">Toutes wilayas</option>
                </select>
                <p id="wilaya-desc" class="sr-only">
                    Sélectionnez une wilaya pour filtrer les annonces
                </p>
            </div>
            <div id="commune-container" class="hidden">
                <label
                        for="commune"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="all_communes"
                >Toutes communes</label
                >
                <select
                        id="commune"
                        aria-describedby="commune-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="all_communes">Toutes communes</option>
                </select>
                <p id="commune-desc" class="sr-only">
                    Sélectionnez une commune pour filtrer les annonces
                </p>
            </div>
            <div>
                <label
                        for="condition"
                        class="block text-sm font-medium text-gray-700"
                        data-i18n-key="condition"
                >État</label
                >
                <select
                        id="condition"
                        aria-describedby="condition-desc"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                >
                    <option value="" data-i18n-key="any_condition">Tout</option>
                    <option value="new" data-i18n-key="new">Neuf</option>
                    <option value="used" data-i18n-key="used">Occasion</option>
                </select>
                <p id="condition-desc" class="sr-only">
                    Sélectionnez l'état du produit
                </p>
            </div>
        </div>

        <div
                class="mt-6 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 justify-center"
        >
            <button
                    id="filter-apply-btn"
                    class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md"
                    data-i18n-key="apply_filters"
            >
                Appliquer les filtres
            </button>
            <button
                    id="filter-reset-btn"
                    class="w-full sm:w-auto px-6 py-3 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300 transition-colors duration-200 shadow-md"
                    data-i18n-key="reset"
            >
                Réinitialiser
            </button>
        </div>
    </section>

    <section
            id="listings-section"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
            aria-live="polite"
            aria-label="Liste des annonces"
    >
    </section>
</template>

<template id="brands-view-template">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <button id="back-to-home-btn" class="mb-4 text-blue-600 hover:text-blue-800 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_categories">Retour aux catégories</span>
        </button>
        <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center" data-i18n-key="brands_title">Choisissez une marque</h2>
        <div id="brands-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
        </div>
    </div>
</template>

<template id="product-detail-view-template">
    <div id="product-detail" class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <button id="back-to-listings-btn" class="mb-4 text-blue-600 hover:text-blue-800 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_listings">Retour aux annonces</span>
        </button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <img id="product-image-detail" src="" alt="" class="w-full h-96 object-cover rounded-lg shadow-md" />
            <div>
                <h2 id="product-title-detail" class="text-3xl font-bold mb-2"></h2>
                <p id="product-price-detail" class="text-blue-600 font-bold text-2xl mb-4"></p>
                <p id="product-description-detail" class="text-gray-700 mb-6"></p>

                <div class="space-y-2 text-gray-700 text-sm mb-6">
                    <p><strong><span data-i18n-key="brand_label">Marque</span>:</strong> <span id="product-brand-detail"></span></p>
                    <p><strong><span data-i18n-key="model_label">Modèle</span>:</strong> <span id="product-model-detail"></span></p>
                    <p><strong><span data-i18n-key="year_label">Année</span>:</strong> <span id="product-year-detail"></span></p>
                    <p><strong><span data-i18n-key="wilaya_label">Wilaya</span>:</strong> <span id="product-wilaya-detail"></span></p>
                    <p><strong><span data-i18n-key="commune_label">Commune</span>:</strong> <span id="product-commune-detail"></span></p>
                </div>

                <div class="flex flex-col space-y-4">
                    <button id="show-contact-btn" class="w-full px-6 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">
                        <i class="fas fa-phone mr-2"></i>
                        <span data-i18n-key="show_contact">Contacter le Vendeur</span>
                    </button>
                    <button id="add-to-cart-btn" class="w-full px-6 py-3 bg-green-600 text-white rounded-full font-semibold hover:bg-green-700 transition-colors duration-200 shadow-md">
                        <i class="fas fa-cart-plus mr-2"></i>
                        <span data-i18n-key="add_to_cart">Ajouter au panier</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-12">
            <h3 class="text-2xl font-bold mb-4" data-i18n-key="reviews_title">Avis des utilisateurs</h3>
            <div id="reviews-container" class="space-y-4">
            </div>
        </div>

        <div class="mt-8" id="add-review-section">
            <h4 class="text-xl font-bold mb-2" data-i18n-key="add_review_title">Ajouter votre avis</h4>
            <form id="add-review-form" class="space-y-4">
                <div>
                    <label for="review-rating" class="block text-sm font-medium text-gray-700">Note</label>
                    <select id="review-rating" name="rating" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="5">5 Étoiles</option>
                        <option value="4">4 Étoiles</option>
                        <option value="3">3 Étoiles</option>
                        <option value="2">2 Étoiles</option>
                        <option value="1">1 Étoile</option>
                    </select>
                </div>
                <div>
                    <label for="review-comment" class="block text-sm font-medium text-gray-700">Commentaire</label>
                    <textarea id="review-comment" name="comment" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    <span data-i18n-key="submit_review">Soumettre l'avis</span>
                </button>
            </form>
        </div>
    </div>
</template>

<template id="cart-view-template">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <button id="back-from-cart-btn" class="mb-4 text-blue-600 hover:text-blue-800 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_listings">Retour aux annonces</span>
        </button>
        <h2 class="text-2xl md:text-3xl font-bold mb-6" data-i18n-key="cart_title">Mon panier</h2>
        <div id="cart-items-container" class="space-y-4">
        </div>
        <div id="cart-summary" class="mt-8 pt-4 border-t border-gray-200">
            <p class="text-xl font-bold flex justify-between">
                <span data-i18n-key="cart_total">Total</span>:
                <span id="cart-total-price">0 DA</span>
            </p>
            <button id="checkout-btn" class="w-full mt-4 px-6 py-3 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition-colors duration-200 shadow-md">
                <span data-i18n-key="checkout_btn">Passer à la caisse</span>
            </button>
        </div>
    </div>
</template>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getFirestore,
        collection,
        addDoc,
        query,
        onSnapshot,
        where,
        getDocs,
        doc,
        setDoc,
        getDoc,
        enableNetwork, 
        disableNetwork
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    
    // --- App State ---
    let currentUser = null;
    let currentLang = localStorage.getItem("piecety_lang") || "fr";
    let currentView = 'home';
    let allProducts = [];
    let userCart = {};

    // --- Firebase Config ---
    // IMPORTANT: For production, use environment variables or Firebase Hosting's reserved URLs to hide your config.
    const firebaseConfig = {
      apiKey: "AIzaSyBIptEskV2soajxRYPDfwYFYyz9pWQvZL0",
      authDomain: "piecety-app-b39c4.firebaseapp.com",
      projectId: "piecety-app-b39c4",
      storageBucket: "piecety-app-b39c4.appspot.com",
      messagingSenderId: "265795860915",
      appId: "1:265795860915:web:aa10241788cce42f6373c6"
    };

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // --- Translations ---
    const translations = {
        fr: {
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "Menu", sell: "Vendre", connect: "Se connecter", logout: "Déconnexion", language: "Langue",
            hero_title: "Trouvez la bonne pièce pour votre voiture",
            hero_subtitle: "Le marché algérien des pièces automobiles le plus fiable.",
            categories_title: "Catégories de Pièces",
            category_engine: "Moteur", category_brakes: "Freins", category_fuel_system: "Système de carburant",
            category_cooling: "Refroidissement", category_tires: "Pneus & Jantes", category_electrical: "Électrique",
            category_body: "Carrosserie", category_tools: "Outillage",
            filters_title: "Filtrer les annonces", all_brands: "Toutes les marques", all_models: "Tous les modèles",
            all_years: "Toutes années", all_wilayas: "Toutes wilayas", all_communes: "Toutes communes",
            condition: "État", any_condition: "Tout", new: "Neuf", used: "Occasion",
            apply_filters: "Appliquer les filtres", reset: "Réinitialiser",
            search_placeholder: "Rechercher une pièce...",
            footer_text: "&copy; <span id='current-year'></span> Piecety - Marché des Pièces Auto en Algérie. Tous droits réservés.",
            submit_ad: "Soumettre une annonce rapide", ad_title_label: "Titre de la pièce", brand_label: "Marque",
            select_brand: "Sélectionnez une marque", other_brand_label: "Autre Marque", model_label: "Modèle", select_model: "Sélectionnez un modèle",
            year_label: "Année", select_year: "Sélectionnez une année", wilaya_label: "Wilaya",
            select_wilaya: "Sélectionnez une wilaya", commune_label: "Commune", select_commune: "Sélectionnez une commune",
            condition_label: "État", price_label: "Prix (DA)", description_label: "Description",
            submit_ad_btn_text: "Soumettre",
            login_text: "Connectez-vous pour accéder à toutes les fonctionnalités.", google_login: "Se connecter avec Google",
            back_to_listings: "Retour aux annonces", back_to_categories: "Retour aux catégories", add_to_cart: "Ajouter au panier",
            reviews_title: "Avis des utilisateurs", add_review_title: "Ajouter votre avis", submit_review: "Soumettre l'avis",
            cart_title: "Mon panier", cart_total: "Total", checkout_btn: "Passer à la caisse",
            no_listings: "Aucune annonce trouvée.",
            profile_title: "Mon profil",
            your_cart_is_empty: "Votre panier est vide.",
            remove: "Supprimer", quantity: "Quantité", item_total: "Total de l'article",
            login_required: "Veuillez vous connecter pour utiliser cette fonctionnalité.",
            brands_title: "Choisissez une marque",
            submitting: "Soumission en cours...",
            phone_label: "Numéro de téléphone", image_label: "Image de la pièce", show_contact: "Contacter le Vendeur",
        },
        en: {
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "Menu", sell: "Sell", connect: "Log In", logout: "Log Out", language: "Language",
            hero_title: "Find the right car part for your vehicle",
            hero_subtitle: "The most trusted Algerian car parts marketplace.",
            categories_title: "Parts Categories",
            category_engine: "Engine", category_brakes: "Brakes", category_fuel_system: "Fuel System",
            category_cooling: "Cooling", category_tires: "Tires & Rims", category_electrical: "Electrical",
            category_body: "Body", category_tools: "Tools",
            filters_title: "Filter Listings", all_brands: "All brands", all_models: "All models",
            all_years: "All years", all_wilayas: "All wilayas", all_communes: "All communes",
            condition: "Condition", any_condition: "Any", new: "New", used: "Used",
            apply_filters: "Apply Filters", reset: "Reset",
            search_placeholder: "Search for a part...",
            footer_text: "&copy; <span id='current-year'></span> Piecety - Car Parts Marketplace in Algeria. All rights reserved.",
            submit_ad: "Submit a quick ad", ad_title_label: "Part Title", brand_label: "Brand",
            select_brand: "Select a brand", other_brand_label: "Other Brand", model_label: "Model", select_model: "Select a model",
            year_label: "Year", select_year: "Select a year", wilaya_label: "Wilaya",
            select_wilaya: "Select a wilaya", commune_label: "Commune", select_commune: "Select a commune",
            condition_label: "Condition", price_label: "Price (DA)", description_label: "Description",
            submit_ad_btn_text: "Submit",
            login_text: "Log in to access all features.", google_login: "Sign in with Google",
            back_to_listings: "Back to listings", back_to_categories: "Back to Categories", add_to_cart: "Add to cart",
            reviews_title: "User Reviews", add_review_title: "Add your review", submit_review: "Submit Review",
            cart_title: "My Cart", cart_total: "Total", checkout_btn: "Proceed to Checkout",
            no_listings: "No listings found.",
            profile_title: "My Profile",
            your_cart_is_empty: "Your cart is empty.",
            remove: "Remove", quantity: "Quantity", item_total: "Item Total",
            login_required: "Please log in to use this feature.",
            brands_title: "Choose a brand",
            submitting: "Submitting...",
            phone_label: "Phone Number", image_label: "Part Image", show_contact: "Contact Seller",
        },
        ar: {
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "القائمة", sell: "بيع", connect: "تسجيل الدخول", logout: "تسجيل الخروج", language: "اللغة",
            hero_title: "ابحث عن قطعة الغيار المناسبة لسيارتك",
            hero_subtitle: "أكثر أسواق قطع غيار السيارات ثقة في الجزائر.",
            categories_title: "فئات القطع",
            category_engine: "محرك", category_brakes: "مكابح", category_fuel_system: "نظام الوقود",
            category_cooling: "التبريد", category_tires: "الإطارات والعجلات", category_electrical: "كهربائي",
            category_body: "هيكل", category_tools: "أدوات",
            filters_title: "تصفية الإعلانات", all_brands: "جميع الماركات", all_models: "جميع الموديلات",
            all_years: "جميع السنوات", all_wilayas: "جميع الولايات", all_communes: "جميع البلديات",
            condition: "الحالة", any_condition: "الكل", new: "جديد", used: "مستعمل",
            apply_filters: "تطبيق الفلاتر", reset: "إعادة تعيين",
            search_placeholder: "ابحث عن قطعة...",
            footer_text: "&copy; <span id='current-year'></span> Piecety - سوق قطع غيار السيارات في الجزائر. جميع الحقوق محفوظة.",
            submit_ad: "إرسال إعلان سريع", ad_title_label: "عنوان القطعة", brand_label: "الماركة",
            select_brand: "اختر ماركة", other_brand_label: "ماركة أخرى", model_label: "الموديل", select_model: "اختر موديل",
            year_label: "السنة", select_year: "اختر سنة", wilaya_label: "الولاية",
            select_wilaya: "اختر ولاية", commune_label: "البلدية", select_commune: "اختر بلدية",
            condition_label: "الحالة", price_label: "السعر (دج)", description_label: "الوصف",
            submit_ad_btn_text: "إرسال",
            login_text: "تسجيل الدخول للوصول إلى جميع الميزات.", google_login: "تسجيل الدخول باستخدام Google",
            back_to_listings: "العودة إلى الإعلانات", back_to_categories: "العودة إلى الفئات", add_to_cart: "أضف إلى السلة",
            reviews_title: "آراء المستخدمين", add_review_title: "أضف رأيك", submit_review: "إرسال الرأي",
            cart_title: "سلة التسوق", cart_total: "الإجمالي", checkout_btn: "الدفع",
            no_listings: "لم يتم العثور على إعلانات.",
            profile_title: "ملفي الشخصي",
            your_cart_is_empty: "سلة التسوق فارغة.",
            remove: "حذف", quantity: "الكمية", item_total: "إجمالي السلعة",
            login_required: "يرجى تسجيل الدخول لاستخدام هذه الميزة.",
            brands_title: "اختر ماركة",
            submitting: "...جاري الإرسال",
            phone_label: "رقم الهاتف", image_label: "صورة القطعة", show_contact: "اتصل بالبائع",
        }
    };

    // --- Static Data ---
    const wilayas = {
        "Adrar": ["Adrar", "Charouine", "Tamest", "Reggane", "Aoulef", "Fenoughil", "Timimoun", "Talmine", "Bordj Badji Mokhtar", "In Salah"],
        "Chlef": ["Chlef", "Ténès", "Ouled Farès", "El Marsa", "Abou El Hassan", "Oued Fodda", "Beni Haoua", "El Karimia", "Taougrite", "Harchoun"],
        "Laghouat": ["Aïn Madhi", "Aflou", "El Ghicha", "El Houaita", "El Assafia", "Ksar El Hirane", "Laghouat", "Taougrite", "Sidi Makhlouf", "Ouled Farès"],
        "Oum El Bouaghi": ["Aïn Beïda", "Aïn Fekroun", "Aïn Babouche", "Aïn M'lila", "Dhalaâ", "F'kirina", "Oum El Bouaghi", "Sidi R'ghiss", "Souk Naamane", "El Fedjoudj"],
        "Batna": ["Aïn Touta", "Arris", "Barika", "Batna", "El Madher", "Menaa", "Merouana", "Ras El Aioun", "Timgad", "Ouled Si Slimane"],
        "Béjaïa": ["Aïn El Kebira", "Akbou", "Béjaïa", "El Kseur", "Sidi Aïch", "Tichy", "Toudja", "Aokas", "Ighil Ali", "Darguina"],
        "Biskra": ["Biskra", "El Kantara", "Sidi Okba", "Ourlal", "Zeribet El Oued", "Tolga", "Sidi Khaled", "Djemorah", "M'chouneche", "El Outaya"],
        "Béchar": ["Béchar", "Abadla", "Beni Ounif", "Lahmar", "Tabelbala", "Kenadsa", "Igli", "Taghit", "Mechraâ Houari Boumediene", "Ouled Khoudir"],
        "Blida": ["Blida", "Boufarik", "Chebli", "Oued El Alleug", "Larbaâ", "Meftah", "Soumaâ", "Bougara", "Mouzaia", "Chréa"],
        "Bouira": ["Bouira", "Lakhdaria", "Sour El Ghozlane", "Ahnif", "Bir Ghbalou", "Haïzer", "M'chedallah", "El Hachimia", "Sidi Aïssa", "Taghzout"],
        "Tamanrasset": ["Tamanrasset", "Abalessa", "Idles", "In Amguel", "Tazrouk", "Tin Zaouatine", "In Guezzam", "Djanet", "Bordj Omar Driss", "Illizi"],
        "Tébessa": ["Tébessa", "Bir El Ater", "Cheria", "El Aouinet", "El Kouif", "El Ma Labiod", "Morsott", "Ouenza", "Bir Mokkadem", "Hammamet"],
        "Tlemcen": ["Tlemcen", "Ghazaouet", "Maghnia", "Remchi", "Sebdou", "Sidi Djillali", "Hennaya", "Nedroma", "Marsa Ben M'Hidi", "Beni Snous"],
        "Tiaret": ["Tiaret", "Aïn Deheb", "Frenda", "Ksar Chellala", "Mahdia", "Rahouia", "Sougueur", "Dahmouni", "Sidi Ali Mellal", "Medroussa"],
        "Tizi Ouzou": ["Tizi Ouzou", "Aïn El Hammam", "Azazga", "Bouzeguène", "Draâ Ben Khedda", "Ouacif", "Larbaâ Nath Irathen", "Tigzirt", "Tizi Gheniff", "Maâtkas"],
        "Alger": ["Alger", "Bab El Oued", "Baraki", "Bir Mourad Raïs", "Birkhadem", "Bologhine", "Bordj El Kiffan", "Hussein Dey", "Hydra", "Dar El Beïda"],
        "Djelfa": ["Djelfa", "Aïn Oussera", "Messaad", "Hassi Bahbah", "Had Sahary", "Guettara", "El Idrissia", "Dar Chioukh", "Zaccar", "Faidh El Botma"],
        "Jijel": ["Jijel", "Taher", "El Milia", "Chekfa", "Ziamamansouria", "Texenna", "Djemaa Beni Habibi", "Sidi Maarouf", "Settara", "Kaous"],
        "Sétif": ["Sétif", "Aïn Oulmane", "El Eulma", "Bousselam", "Beni Ouartilane", "Bougaâ", "Salah Bey", "Hammamlou", "Guenzet", "Maouaklane"],
        "Saïda": ["Saïda", "Aïn El Hadjar", "Sidi Boubkeur", "Youb", "El Hassasna", "Tircine", "Maamora", "Ouled Brahim", "Aïn Sekhouna", "Moulay Larbi"],
        "Skikda": ["Skikda", "Aïn Bouziane", "Azzaba", "El Harrouch", "Collo", "Filfila", "Ramdane Djamel", "Salah Bouchaour", "Zerdaza", "Beni Oulbane"],
        "Sidi Bel Abbès": ["Sidi Bel Abbès", "Sfisef", "Telagh", "Ras El Ma", "Tessala", "Aïn El Berd", "Boukhanafis", "Ben Badis", "Sidi Chaib", "Moulay Slissen"],
        "Annaba": ["Annaba", "El Hadjar", "Berrahal", "El Bouni", "Seraïdi", "Chetaïbi", "Oued El Aneb", "Aïn El Berda", "Trézel", "Sidi Amar"],
        "Guelma": ["Guelma", "Héliopolis", "Oued Zenati", "Bouchegouf", "Ain Reggada", "Tamlouka", "Dkhila", "Bou Hachana", "Belkheir", "Bordj Sabath"],
        "Constantine": ["Constantine", "El Khroub", "Hamma Bouziane", "Aïn Smara", "Didouche Mourad", "Zighoud Youcef", "Messaoud Boudjriou", "Beni Hamidane", "Ibn Ziad", "Oued El Hadjar"],
        "Médéa": ["Médéa", "Berrouaghia", "Chahbounia", "Tablat", "Aïn Boucif", "Beni Slimane", "El Azizia", "Si Mahdjoub", "Ouzera", "Ksar Boukhari"],
        "Mostaganem": ["Mostaganem", "Hassi Mameche", "Aïn Tédelès", "Sidi Ali", "Bouguirat", "Achaacha", "Khadra", "Oued El Kheir", "Mazagran", "Foran"],
        "M'Sila": ["M'Sila", "Bou Saâda", "Aïn El Melh", "Sidi Aïssa", "Magra", "M'Cif", "Hammam Dhalaâ", "Ouled Derradj", "Ben Srour", "Ouanougha"],
        "Mascara": ["Mascara", "Ghriss", "Tighennif", "Sig", "Bou Hanifia", "Oued Taria", "Hachem", "Mohammadia", "El Bordj", "Aïn Fares"],
        "Ouargla": ["Ouargla", "Hassi Messaoud", "Rouissat", "N'Goussa", "Sidi Khouiled", "Blidet Amor", "El Borma", "Tebesbest", "Zaouia El Abidia", "Hassi Ben Abdallah"],
        "Oran": ["Oran", "Arzew", "Bir El Djir", "Es Senia", "Boutlélis", "Hassi Bounif", "Oued Tlélat", "Sidi Chami", "Gdyel", "Aïn El Turk"],
        "El Bayadh": ["El Bayadh", "Bougtob", "Chellala", "Breïna", "Rogassa", "Brezina", "Boussemghoun", "El Kheiter", "Kraïr", "Ghassoul"],
        "Illizi": ["Illizi", "Djanet", "Bordj El Houasse", "Tamanrasset", "In Salah", "Abalessa", "Tazrouk", "Idles", "In Amguel", "Tin Zaouatine"],
        "Bordj Bou Arréridj": ["Bordj Bou Arréridj", "Ras El Oued", "Mansoura", "Tassameurt", "El Achir", "Medjana", "Bordj Ghedir", "Hammam El Biban", "L'Hassaneia", "Ghassira"],
        "Boumerdès": ["Boumerdès", "Dellys", "Boudouaou", "Isser", "Béni Amrane", "Naciria", "Corso", "Zemmouri", "Réghaïa", "Tidjelabine"],
        "El Tarf": ["El Tarf", "Ben M'Hidi", "Besbes", "Drea", "El Kala", "Bougous", "Raml Souk", "Sidi Khelil", "Oued Zitoun", "Aïn Kerma"],
        "Tindouf": ["Tindouf", "Oum El Assel"],
        "Tissemsilt": ["Tissemsilt", "Bordj Bounaama", "Lardjem", "Théniet El Had", "Ammi Moussa", "Sidi Boutouchent", "Layoune", "Lazharia", "Bougara", "Bordj Emir Khaled"],
        "El Oued": ["El Oued", "Guemar", "Hassi Khalifa", "Robbah", "Debila", "Bayadha", "Magrane", "Nakhla", "Kouinine", "El Ogla"],
        "Khenchela": ["Khenchela", "Aïn Touila", "Bab El Ain", "Kais", "Yabous", "Chechar", "M'Sara", "Ouled Rechache", "Taouzianat", "Remila"],
        "Souk Ahras": ["Souk Ahras", "Heddada", "M'daourouch", "Mechrouha", "Ouled Driss", "Taoura", "Zaarouria", "Ouillen", "Sidi Fredj", "Tiffech"],
        "Tipaza": ["Tipaza", "Cherchell", "Koléa", "Fouka", "Hadjout", "Sidi Rached", "Menaceur", "Bou Ismaïl", "Khemis Miliana", "Aïn Tagourait"],
        "Mila": ["Mila", "Bouhatem", "Ferdjioua", "Grarem Gouga", "Tadjenanet", "Sidi Merouane", "Oued Endja", "Teleghma", "Chigara", "Rouached"],
        "Aïn Defla": ["Aïn Defla", "Khemis Miliana", "El Attaf", "Aïn Torki", "Djelida", "Rouina", "Hammam Righa", "Miliana", "Boumedfaa", "Aïn Soltane"],
        "Naâma": ["Naâma", "Mécheria", "Aïn Sefra", "Moghrar", "Tiout", "Sfissifa", "Makman Ben Amer", "Asla", "Kasdir", "El Biod"],
        "Aïn Témouchent": ["Aïn Témouchent", "Hammam Bou Hadjar", "El Malah", "Béni Saf", "Aghlal", "Chaabat El Ham", "Oued Berkeche", "Aoubellil", "Bouzedjar", "Tamesna"],
        "Ghardaïa": ["Ghardaïa", "El Guerrara", "Berriane", "Dhayet Bendhahoua", "Metlili", "Zelfana", "Bounoura", "El Atteuf", "Guerrara", "Dra' El Mizan"],
        "Relizane": ["Relizane", "Oued Rhiou", "Zemmoura", "Sidi M'Hamed Ben Ali", "El H'madna", "Ammi Moussa", "Mazouna", "Mendes", "Ain Tarek", "Oued El Djemaa"],
        "El M'ghair": ["El M'ghair", "Sidi Amrane", "Djamaa", "Oum Toub", "M'Rara", "Oued Allenda", "Sidi Khelil", "Oued R'hiou", "Sidi Yahia", "Bouchakroun"],
        "El Meniaa": ["El Meniaa", "Hassi Gara", "Mansourah", "Dhiafat", "El Guerrara", "Tadjmout", "El Hachane", "El Oued", "Chabet El Ami", "Ouled Gacem"]
    };
    const car_data = {
        "Toyota": { logo: "https://cdn.worldvectorlogo.com/logos/toyota-1.svg", models: ["Yaris", "Corolla", "Camry", "Land Cruiser", "Hilux", "RAV4", "Prado", "Fortuner"] },
        "Peugeot": { logo: "https://cdn.worldvectorlogo.com/logos/peugeot-01.svg", models: ["208", "308", "301", "2008", "3008", "508", "Partner", "Expert"] },
        "Volkswagen": { logo: "https://cdn.worldvectorlogo.com/logos/volkswagen-3.svg", models: ["Golf", "Polo", "Passat", "Tiguan", "Touareg", "Jetta", "Caddy", "Amarok"] },
        "Renault": { logo: "https://cdn.worldvectorlogo.com/logos/renault-1.svg", models: ["Clio", "Megane", "Captur", "Duster", "Symbol", "Kadjar", "Kangoo"] },
        "Hyundai": { logo: "https://cdn.worldvectorlogo.com/logos/hyundai-5.svg", models: ["i10", "i20", "Accent", "Tucson", "Santa Fe", "Elantra", "Creta"] },
        "Nissan": { logo: "https://cdn.worldvectorlogo.com/logos/nissan-7.svg", models: ["Micra", "Sentra", "Qashqai", "X-Trail", "Juke", "Navara", "Patrol"] },
        "Fiat": { logo: "https://cdn.worldvectorlogo.com/logos/fiat-4.svg", models: ["500", "Tipo", "Punto", "Ducato", "Doblo"] },
        "Citroën": { logo: "https://cdn.worldvectorlogo.com/logos/citroen-1.svg", models: ["C3", "C4", "C-Elysée", "Berlingo", "Jumper"] },
        "Kia": { logo: "https://cdn.worldvectorlogo.com/logos/kia-2021.svg", models: ["Picanto", "Rio", "Sportage", "Sorento", "Cerato"] },
        "Mercedes-Benz": { logo: "https://cdn.worldvectorlogo.com/logos/mercedes-benz-9.svg", models: ["A-Class", "C-Class", "E-Class", "GLA", "GLC", "GLE", "Sprinter"] },
        "BMW": { logo: "https://cdn.worldvectorlogo.com/logos/bmw.svg", models: ["Series 1", "Series 3", "Series 5", "X1", "X3", "X5"] },
        "Audi": { logo: "https://cdn.worldvectorlogo.com/logos/audi-1.svg", models: ["A3", "A4", "A6", "Q3", "Q5", "Q7"] },
        "Ford": { logo: "https://cdn.worldvectorlogo.com/logos/ford-5.svg", models: ["Fiesta", "Focus", "Ranger", "Transit"] },
        "Chevrolet": { logo: "https://cdn.worldvectorlogo.com/logos/chevrolet-5.svg", models: ["Spark", "Aveo", "Cruze", "Captiva"] },
        "Skoda": { logo: "https://cdn.worldvectorlogo.com/logos/skoda-4.svg", models: ["Fabia", "Octavia", "Rapid", "Kodiaq"] },
        "Seat": { logo: "https://cdn.worldvectorlogo.com/logos/seat-1.svg", models: ["Ibiza", "Leon", "Arona", "Ateca"] },
        "Dacia": { logo: "https://cdn.worldvectorlogo.com/logos/dacia-2.svg", models: ["Logan", "Sandero", "Duster", "Lodgy"] },
        "Jeep": { logo: "https://cdn.worldvectorlogo.com/logos/jeep.svg", models: ["Renegade", "Compass", "Cherokee", "Grand Cherokee", "Wrangler"] },
        "Land Rover": { logo: "https://cdn.worldvectorlogo.com/logos/land-rover-1.svg", models: ["Defender", "Discovery", "Range Rover Evoque", "Range Rover Sport", "Range Rover"] },
        "Mitsubishi": { logo: "https://cdn.worldvectorlogo.com/logos/mitsubishi-5.svg", models: ["L200", "Pajero", "Outlander"] },
        "Suzuki": { logo: "https://cdn.worldvectorlogo.com/logos/suzuki-4.svg", models: ["Swift", "Vitara", "Jimny"] }
    };
    const currentYear = new Date().getFullYear();
    const years = Array.from({ length: currentYear - 1979 }, (_, i) => currentYear - i);

    // --- DOM References (Lazy-loaded within functions) ---
    const appContainer = document.getElementById("app-container");

    // --- Utility Functions ---
    const showMessage = (msg, duration = 3500, type = "info") => {
        const messageBox = document.getElementById("message-box");
        if (!messageBox) return;
        messageBox.textContent = msg;
        messageBox.className = `message-box show`;
        messageBox.classList.add(
            type === "error" ? "bg-red-100 text-red-800" : 
            type === "success" ? "bg-green-100 text-green-800" : 
            "bg-white text-gray-800"
        );
        setTimeout(() => messageBox.classList.remove("show"), duration);
    };

    const closeMobileMenu = () => {
        document.getElementById('mobile-menu')?.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    };

    const translatePage = (lang) => {
        document.getElementById("current-lang").textContent = translations[lang][lang + "_short"];
        document.body.setAttribute("dir", lang === "ar" ? "rtl" : "ltr");
        document.querySelectorAll("[data-i18n-key]").forEach(el => {
            const key = el.getAttribute("data-i18n-key");
            if (translations[lang][key]) {
                if (el.placeholder !== undefined) {
                    el.placeholder = translations[lang][key];
                } else {
                    el.innerHTML = translations[lang][key];
                }
            }
        });
    };

    const populateSelect = (selectEl, options, defaultLabelKey, lang, addOtherOption = false) => {
        if (!selectEl) return;
        selectEl.innerHTML = `<option value="">${translations[lang][defaultLabelKey]}</option>`;
        options.forEach(opt => selectEl.insertAdjacentHTML('beforeend', `<option value="${opt}">${opt}</option>`));
        if (addOtherOption) {
            selectEl.insertAdjacentHTML('beforeend', `<option value="other">${translations[lang].other_brand_label}</option>`);
        }
    };

    // --- View Rendering ---
    const renderView = (viewName, data = null) => {
        if (!appContainer) return;
        appContainer.innerHTML = '';
        currentView = viewName;
        const template = document.getElementById(`${viewName}-view-template`);
        if (template) {
            appContainer.appendChild(template.content.cloneNode(true));
            // Call the corresponding render function
            const renderFunctions = {
                'home': renderHomePage,
                'brands': renderBrandsPage,
                'product-detail': renderProductPage,
                'cart': renderCartPage
            };
            renderFunctions[viewName]?.(data);
        } else {
            renderView('home'); // Fallback to home
        }
        translatePage(currentLang);
    };
    
    const renderHomePage = () => {
        const brandFilter = document.getElementById('brand');
        const modelFilter = document.getElementById('model');
        const yearFilter = document.getElementById('year');
        const wilayaFilter = document.getElementById('wilaya');
        const communeFilter = document.getElementById('commune');
        const modelFilterContainer = document.getElementById('model-filter-container');
        const communeContainer = document.getElementById('commune-container');

        populateSelect(brandFilter, Object.keys(car_data), "all_brands", currentLang);
        populateSelect(yearFilter, years, "all_years", currentLang);
        populateSelect(wilayaFilter, Object.keys(wilayas), "all_wilayas", currentLang);

        document.querySelectorAll('.category-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                renderView('brands', { category: e.currentTarget.dataset.category });
            });
        });

        const setupFilterListeners = () => {
            brandFilter.addEventListener('change', () => {
                const selectedBrand = brandFilter.value;
                if (selectedBrand && car_data[selectedBrand]) {
                    populateSelect(modelFilter, car_data[selectedBrand].models, "all_models", currentLang);
                    modelFilterContainer.classList.remove("hidden");
                    modelFilter.disabled = false;
                } else {
                    modelFilter.innerHTML = `<option value="">${translations[currentLang]["all_models"]}</option>`;
                    modelFilterContainer.classList.add("hidden");
                    modelFilter.disabled = true;
                }
            });

            wilayaFilter.addEventListener('change', () => {
                const val = wilayaFilter.value;
                if (val) {
                    populateSelect(communeFilter, wilayas[val], "all_communes", currentLang);
                    communeContainer.classList.remove("hidden");
                    communeFilter.disabled = false;
                } else {
                    communeFilter.innerHTML = `<option value="">${translations[currentLang]["all_communes"]}</option>`;
                    communeContainer.classList.add("hidden");
                    communeFilter.disabled = true;
                }
            });
            
            document.getElementById('filter-apply-btn').addEventListener('click', renderListings);
            document.getElementById('filter-reset-btn').addEventListener('click', () => {
                document.getElementById('brand').value = '';
                document.getElementById('model').value = '';
                document.getElementById('year').value = '';
                document.getElementById('wilaya').value = '';
                document.getElementById('commune').value = '';
                document.getElementById('condition').value = '';
                document.getElementById('search-input').value = '';
                modelFilterContainer.classList.add('hidden');
                communeContainer.classList.add('hidden');
                renderListings();
            });
        };

        setupFilterListeners();
        renderListings();
    };
    
    const renderBrandsPage = () => {
        const brandsGrid = document.getElementById('brands-grid');
        document.getElementById('back-to-home-btn').addEventListener('click', () => renderView('home'));
        brandsGrid.innerHTML = '';
        for (const brandName in car_data) {
            const brand = car_data[brandName];
            const card = document.createElement('div');
            card.className = "bg-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center cursor-pointer hover:shadow-xl hover:scale-105 transition-all duration-200";
            card.innerHTML = `
                <img src="${brand.logo}" alt="${brandName} Logo" class="h-16 w-full object-contain mb-2">
                <span class="font-semibold text-gray-700">${brandName}</span>
            `;
            card.addEventListener('click', () => {
                // This flow takes user back to homepage with the brand pre-selected.
                renderView('home');
                // Use a timeout to ensure the home page elements are rendered before setting the value
                setTimeout(() => {
                    const brandFilter = document.getElementById('brand');
                    if(brandFilter) {
                        brandFilter.value = brandName;
                        brandFilter.dispatchEvent(new Event('change')); // Trigger change to populate models
                        renderListings();
                    }
                }, 100);
            });
            brandsGrid.appendChild(card);
        }
    };

    const renderProductPage = (product) => {
        if (!product) { renderView('home'); return; }
        
        document.getElementById('product-image-detail').src = product.imageUrl || 'https://via.placeholder.com/600x400.png?text=No+Image';
        document.getElementById('product-title-detail').textContent = product.title;
        document.getElementById('product-price-detail').textContent = `${product.price.toLocaleString()} DA`;
        document.getElementById('product-description-detail').textContent = product.description;
        document.getElementById('product-brand-detail').textContent = product.brand;
        document.getElementById('product-model-detail').textContent = product.model || "-";
        document.getElementById('product-year-detail').textContent = product.year || "-";
        document.getElementById('product-wilaya-detail').textContent = product.wilaya;
        document.getElementById('product-commune-detail').textContent = product.commune || "-";
        
        document.getElementById('back-to-listings-btn').addEventListener('click', () => renderView('home'));
        
        const contactBtn = document.getElementById('show-contact-btn');
        contactBtn.addEventListener('click', () => {
            if (product.phoneNumber) {
                const anchor = document.createElement('a');
                anchor.href = `tel:${product.phoneNumber}`;
                anchor.className = contactBtn.className;
                anchor.innerHTML = `<i class="fas fa-phone mr-2"></i> ${product.phoneNumber}`;
                contactBtn.parentNode.replaceChild(anchor, contactBtn);
            } else {
                contactBtn.textContent = 'Contact non disponible';
                contactBtn.disabled = true;
            }
        }, { once: true }); // The listener will only run once

        document.getElementById('add-to-cart-btn').addEventListener('click', () => addToCart(product));
    };

    const renderListings = async () => {
        const listingsSection = document.getElementById('listings-section');
        if (!listingsSection) return;
        listingsSection.innerHTML = `<p class="col-span-full text-center py-6 text-gray-600">Chargement...</p>`;
        
        try {
            if (allProducts.length === 0) {
                const querySnapshot = await getDocs(query(collection(db, "products")));
                allProducts = querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
            }
            displayProducts(filterProducts(allProducts), listingsSection);
        } catch (err) {
            listingsSection.innerHTML = `<p class="col-span-full text-center py-6 text-red-600">Erreur de chargement des annonces.</p>`;
        }
    };

    // --- Data & Logic ---
    const filterProducts = (products) => {
        const brand = document.getElementById('brand')?.value.trim().toLowerCase();
        const model = document.getElementById('model')?.value.trim().toLowerCase();
        const year = document.getElementById('year')?.value.trim();
        const wilaya = document.getElementById('wilaya')?.value.trim().toLowerCase();
        const commune = document.getElementById('commune')?.value.trim().toLowerCase();
        const condition = document.getElementById('condition')?.value.trim().toLowerCase();
        const searchTerm = document.getElementById('search-input')?.value.trim().toLowerCase();

        return products.filter(p => 
            (!brand || p.brand.toLowerCase() === brand) &&
            (!model || p.model?.toLowerCase() === model) &&
            (!year || p.year?.toString() === year) &&
            (!wilaya || p.wilaya.toLowerCase() === wilaya) &&
            (!commune || p.commune?.toLowerCase() === commune) &&
            (!condition || p.condition.toLowerCase() === condition) &&
            (!searchTerm || p.title.toLowerCase().includes(searchTerm))
        );
    };

    const displayProducts = (products, container) => {
        container.innerHTML = "";
        if (products.length === 0) {
            container.innerHTML = `<p class="col-span-full text-center py-6 text-gray-600" data-i18n-key="no_listings"></p>`;
            translatePage(currentLang);
            return;
        }
        products.forEach(item => {
            const card = document.createElement("article");
            card.className = "bg-white rounded-lg shadow-md overflow-hidden flex flex-col cursor-pointer hover:shadow-xl transition-shadow duration-300";
            card.addEventListener('click', () => renderView('product-detail', item));
            card.innerHTML = `
                <img src="${item.imageUrl || 'https://via.placeholder.com/300x200.png?text=No+Image'}" alt="${item.title}" class="w-full h-48 object-cover" loading="lazy" />
                <div class="p-4 flex-1 flex flex-col">
                    <h3 class="font-semibold text-lg mb-1">${item.title}</h3>
                    <p class="text-blue-600 font-bold text-lg mt-auto pt-2">${item.price.toLocaleString()} DA</p>
                </div>
            `;
            container.appendChild(card);
        });
    };

    const addToCart = (product) => {
        if (!currentUser) { showMessage(translations[currentLang].login_required, 4000, 'error'); return; }
        // Cart logic would go here
        showMessage(`${product.title} ajouté au panier (simulation).`, 3000, 'success');
    };

    // --- Modal Logic ---
    const openAuthModal = () => document.getElementById('auth-modal').classList.remove('hidden');
    const closeAuthModal = () => document.getElementById('auth-modal').classList.add('hidden');
    const openSellModal = () => {
        if (!currentUser) {
            showMessage(translations[currentLang].login_required, 4000, 'error');
            openAuthModal();
            return;
        }
        document.getElementById('post-product-modal').classList.remove('hidden');
    }

    const validatePostForm = (form) => {
        let isValid = true;
        form.querySelectorAll('[required]').forEach(input => {
            const errorEl = document.getElementById(`${input.id}-error`);
            if (!input.value.trim()) {
                if (errorEl) errorEl.classList.remove("hidden");
                isValid = false;
            } else {
                if (errorEl) errorEl.classList.add("hidden");
            }
        });
        return isValid;
    };

    const handleSellFormSubmit = async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = form.querySelector('#submit-ad-btn');
        if (!validatePostForm(form)) { showMessage("Veuillez remplir tous les champs obligatoires.", 3000, 'error'); return; }

        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span data-i18n-key="submitting">${translations[currentLang].submitting}</span>`;
        
        const formData = new FormData(form);
        const imageFile = formData.get('image');
        let imageUrl = '';

        try {
            if (imageFile && imageFile.size > 0) {
                const imageName = `${Date.now()}-${imageFile.name}`;
                const storageRef = ref(storage, `product_images/${imageName}`);
                const snapshot = await uploadBytes(storageRef, imageFile);
                imageUrl = await getDownloadURL(snapshot.ref);
            }

            let brand = formData.get('brand');
            if (brand === 'other') brand = formData.get('brand-other');
            
            const newProduct = { 
                title: formData.get('title'), brand,
                model: formData.get('model'), year: formData.get('year'),
                wilaya: formData.get('wilaya'), commune: formData.get('commune'),
                condition: formData.get('condition'), price: parseInt(formData.get('price')) || 0,
                phoneNumber: formData.get('phone'), description: formData.get('description'),
                imageUrl, timestamp: new Date(),
                sellerId: currentUser.uid
            };

            await addDoc(collection(db, "products"), newProduct);
            
            showMessage("Annonce soumise avec succès!", 4000, 'success');
            form.reset();
            document.getElementById('image-preview-container').innerHTML = '';
            document.getElementById('post-product-modal').classList.add('hidden');
            allProducts = []; // Invalidate cache
            renderView('home');
        } catch (error) {
            showMessage("Erreur lors de la soumission de l'annonce.", 4000, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<span data-i18n-key="submit_ad_btn_text">${translations[currentLang].submit_ad_btn_text}</span>`;
        }
    };
    
    // --- Initial Setup ---
    const setupGlobalEventListeners = () => {
        // Language switcher
        document.getElementById('lang-dropdown-btn').addEventListener('click', () => {
            document.getElementById('lang-dropdown').classList.toggle('hidden');
        });
        document.querySelectorAll(".lang-btn").forEach(btn => btn.addEventListener('click', (e) => {
            currentLang = e.target.dataset.lang;
            localStorage.setItem('piecety_lang', currentLang);
            translatePage(currentLang);
            closeMobileMenu();
            document.getElementById('lang-dropdown').classList.add('hidden');
        }));

        // Modals
        document.getElementById('modal-close-btn').addEventListener('click', () => document.getElementById('post-product-modal').classList.add('hidden'));
        document.getElementById('auth-modal-close-btn').addEventListener('click', closeAuthModal);
        document.getElementById('sell-link').addEventListener('click', openSellModal);
        document.getElementById('sell-link-mobile').addEventListener('click', openSellModal);

        // Mobile Menu
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        });
        document.getElementById('mobile-menu-close-btn').addEventListener('click', closeMobileMenu);

        // Navigation
        document.getElementById('home-link').addEventListener('click', (e) => { e.preventDefault(); renderView('home'); });

        // Sell Form Logic
        const postProductForm = document.getElementById('post-product-form');
        const brandSelect = postProductForm.querySelector('#product-brand');
        const modelSelect = postProductForm.querySelector('#product-model');
        const wilayaSelect = postProductForm.querySelector('#product-wilaya');
        const communeSelect = postProductForm.querySelector('#product-commune');
        const imageInput = postProductForm.querySelector('#product-image');

        populateSelect(brandSelect, Object.keys(car_data), "select_brand", currentLang, true);
        populateSelect(postProductForm.querySelector('#product-year'), years, "select_year", currentLang);
        populateSelect(wilayaSelect, Object.keys(wilayas), "select_wilaya", currentLang);

        brandSelect.addEventListener('change', () => {
            const selected = brandSelect.value;
            const otherContainer = postProductForm.querySelector('#other-brand-container');
            if (selected === 'other') {
                otherContainer.classList.remove('hidden');
                modelSelect.disabled = true;
            } else {
                otherContainer.classList.add('hidden');
                if (selected && car_data[selected]) {
                    populateSelect(modelSelect, car_data[selected].models, "select_model", currentLang);
                    modelSelect.disabled = false;
                } else {
                    modelSelect.disabled = true;
                }
            }
        });
        wilayaSelect.addEventListener('change', () => {
            if (wilayaSelect.value) {
                populateSelect(communeSelect, wilayas[wilayaSelect.value], "select_commune", currentLang);
                communeSelect.disabled = false;
            } else {
                communeSelect.disabled = true;
            }
        });
        imageInput.addEventListener('change', () => {
            const previewContainer = document.getElementById('image-preview-container');
            previewContainer.innerHTML = '';
            if (imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = e => previewContainer.innerHTML = `<img src="${e.target.result}" class="w-24 h-24 object-cover rounded-md shadow-md">`;
                reader.readAsDataURL(imageInput.files[0]);
            }
        });
        postProductForm.addEventListener('submit', handleSellFormSubmit);
    };

    const bootApp = () => {
        document.getElementById('current-year').textContent = currentYear;
        setupGlobalEventListeners();

        onAuthStateChanged(auth, user => {
            currentUser = user;
            const authLinks = document.getElementById('auth-links');
            const mobileAuthBtn = document.getElementById('auth-btn-mobile');
            if (user) {
                authLinks.innerHTML = `<button id="signout-btn" class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-full font-semibold" data-i18n-key="logout"></button>`;
                authLinks.querySelector('#signout-btn').addEventListener('click', () => signOut(auth));
                mobileAuthBtn.setAttribute('data-i18n-key', 'logout');
                mobileAuthBtn.onclick = () => { signOut(auth); closeMobileMenu(); };
            } else {
                authLinks.innerHTML = `<button id="login-btn" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-full font-semibold" data-i18n-key="connect"></button>`;
                authLinks.querySelector('#login-btn').addEventListener('click', openAuthModal);
                mobileAuthBtn.setAttribute('data-i18n-key', 'connect');
                mobileAuthBtn.onclick = openAuthModal;
            }
            translatePage(currentLang);
        });

        document.getElementById('google-login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider)
              .then(result => showMessage(`Bienvenue, ${result.user.displayName}!`, 3000, 'success'))
              .catch(err => showMessage("Erreur de connexion avec Google.", 3000, 'error'))
              .finally(closeAuthModal);
        });

        renderView('home');
    };

    // --- Start the App ---
    bootApp();

</script>
    
</body>
</html>
