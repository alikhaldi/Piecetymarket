<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Piecety - Marché des Pièces Auto en Algérie</title>
    
    <link rel="icon" type="image/svg+xml" href="https://www.svgrepo.com/show/493547/brake-disc.svg">

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* DESIGN ENHANCEMENT: Softer background color */
            background-color: #f9fafb; /* gray-50 */
        }
        /* Custom scrollbar for a more polished look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #999; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .message-box {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            padding: 1rem; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.5s ease-in-out; opacity: 0; transform: translateX(100%);
            max-width: 300px; word-wrap: break-word;
        }
        .message-box.show { opacity: 1; transform: translateX(0); }
        .category-card:hover .category-icon { transform: scale(1.1); }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">

<div id="message-box" class="message-box bg-white text-gray-800"></div>

<header class="bg-white shadow-sm sticky top-0 z-50" role="banner">
    <div class="container mx-auto p-4 flex items-center justify-between">
        <a href="#" id="home-link" class="text-3xl font-extrabold text-blue-600 logo cursor-pointer">Piecety</a>
        <div class="flex-1 mx-4 sm:mx-8">
            <div class="relative">
                <input id="search-input" type="text" placeholder="Rechercher une pièce..." class="w-full p-3 pl-10 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 shadow-inner" aria-label="Rechercher une pièce"/>
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>
        <nav class="hidden md:flex items-center space-x-6" role="navigation">
            <a href="#" class="text-gray-600 hover:text-blue-600 font-medium transition-colors duration-200" data-i18n-key="sell" id="sell-link">Vendre</a>
            <div id="auth-links" class="flex items-center space-x-4">
                <button id="login-btn" class="text-white bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded-full font-semibold transition-all duration-200 shadow-md hover:shadow-lg" data-i18n-key="connect">Se connecter</button>
            </div>
        </nav>
        <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-600 hover:text-blue-600 focus:outline-none" aria-label="Menu">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>
</header>

<div id="mobile-menu" class="fixed inset-0 bg-white z-40 hidden flex-col p-6 md:hidden" role="dialog">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-bold text-blue-600" data-i18n-key="menu">Menu</h2>
        <button id="mobile-menu-close-btn" class="text-gray-600 hover:text-blue-600" aria-label="Fermer menu">
            <i class="fas fa-times text-2xl"></i>
        </button>
    </div>
    <div class="flex flex-col space-y-4">
        <a href="#" class="text-xl font-medium text-gray-800 hover:text-blue-600 py-2" data-i18n-key="sell" id="sell-link-mobile">Vendre</a>
        <div id="auth-links-mobile" class="text-xl font-medium text-gray-800">
             <button class="text-left w-full hover:text-blue-600 py-2" data-i18n-key="connect">Se connecter</button>
        </div>
    </div>
</div>

<main id="app-container" class="flex-1 container mx-auto p-4 md:p-8" role="main"></main>

<footer class="bg-gray-800 text-white p-6 md:p-8 mt-auto text-center">
    <p class="text-sm font-light">&copy; <span id="current-year"></span> Piecety - Marché des Pièces Auto en Algérie. Tous droits réservés.</p>
</footer>

<div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-11/12 p-6 relative">
        <button id="auth-modal-close-btn" class="absolute top-4 right-4 text-gray-600 hover:text-red-600"><i class="fas fa-times text-2xl"></i></button>
        <h3 class="text-2xl font-bold mb-6 text-center" data-i18n-key="connect">Se connecter</h3>
        <div class="space-y-4">
            <p class="text-center text-gray-600" data-i18n-key="login_text">Connectez-vous pour accéder à toutes les fonctionnalités.</p>
            <button id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 bg-white border border-gray-300 rounded-full text-gray-700 font-semibold hover:bg-gray-100 transition-colors duration-200 shadow-sm">
                <i class="fab fa-google text-xl mr-3"></i><span data-i18n-key="google_login">Se connecter avec Google</span>
            </button>
        </div>
    </div>
</div>

<template id="home-view-template">
    <section class="text-center py-12 md:py-20 bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-xl shadow-xl mb-8 md:mb-12">
        <h1 class="text-3xl md:text-5xl font-extrabold mb-4" data-i18n-key="hero_title">Trouvez la bonne pièce pour votre voiture</h1>
        <p class="text-lg md:text-xl font-light mb-8 max-w-2xl mx-auto px-4" data-i18n-key="hero_subtitle">Le marché algérien des pièces automobiles le plus fiable.</p>
    </section>
    <section class="mb-8 md:mb-12" aria-label="Catégories de pièces">
        <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center" data-i18n-key="categories_title">Catégories de Pièces</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4 sm:gap-6">
            <a href="#" class="category-link bg-white rounded-xl shadow-lg p-4 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl category-card" data-category="engine">
                <div class="p-4 rounded-full bg-blue-100 text-blue-600 mx-auto w-16 h-16 flex items-center justify-center mb-3 transition-transform duration-300 category-icon"><i class="fas fa-cogs text-3xl"></i></div>
                <h3 class="font-semibold text-base" data-i18n-key="category_engine">Moteur</h3>
            </a>
            <a href="#" class="category-link bg-white rounded-xl shadow-lg p-4 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl category-card" data-category="brakes">
                <div class="p-2 rounded-full bg-blue-100 text-blue-600 mx-auto w-16 h-16 flex items-center justify-center mb-3 transition-transform duration-300 category-icon"><img src="https://www.svgrepo.com/show/493547/brake-disc.svg" alt="Brakes Icon" class="w-12 h-12"></div>
                <h3 class="font-semibold text-base" data-i18n-key="category_brakes">Freins</h3>
            </a>
            </div>
    </section>
    <section id="listings-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" aria-live="polite"></section>
</template>

<template id="filter-drilldown-view-template">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <button id="back-to-home-btn" class="mb-6 text-blue-600 hover:text-blue-800 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span>Retour</span>
        </button>
        <h2 id="drilldown-title" class="text-2xl md:text-3xl font-bold mb-6 text-center">Filtres</h2>
        <div id="drilldown-filters" class="max-w-xl mx-auto grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
                <label for="filter-company" class="block text-sm font-medium text-gray-700">Constructeur</label>
                <select id="filter-company" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
            </div>
            <div>
                <label for="filter-brand" class="block text-sm font-medium text-gray-700">Marque</label>
                <select id="filter-brand" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" disabled></select>
            </div>
            <div>
                <label for="filter-model" class="block text-sm font-medium text-gray-700">Modèle</label>
                <select id="filter-model" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" disabled></select>
            </div>
            <div>
                <label for="filter-year" class="block text-sm font-medium text-gray-700">Année</label>
                <select id="filter-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" disabled></select>
            </div>
        </div>
        <div class="text-center mt-8">
            <button id="show-results-btn" class="w-full sm:w-auto px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-lg transform hover:scale-105">Afficher les résultats</button>
        </div>
    </div>
</template>

<template id="product-detail-view-template">
    </template>

<script type="module">
    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    
    // --- App State ---
    let currentUser = null;
    let allProducts = [];
    let currentLang = 'fr'; // Default language

    // --- Firebase Config (Ensure this is filled with your actual config) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBIptEskV2soajxRYPDfwYFYyz9pWQvZL0",
      authDomain: "piecety-app-b39c4.firebaseapp.com",
      projectId: "piecety-app-b39c4",
      storageBucket: "piecety-app-b39c4.appspot.com",
      messagingSenderId: "265795860915",
      appId: "1:265795860915:web:aa10241788cce42f6373c6"
    };

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // --- Translations (Full object restored) ---
    const translations = {
        fr: {
            menu: "Menu", sell: "Vendre", connect: "Se connecter", logout: "Déconnexion",
            hero_title: "Trouvez la bonne pièce pour votre voiture", hero_subtitle: "Le marché algérien des pièces automobiles le plus fiable.",
            categories_title: "Catégories de Pièces", category_engine: "Moteur", category_brakes: "Freins",
            login_text: "Connectez-vous pour accéder à toutes les fonctionnalités.", google_login: "Se connecter avec Google",
        },
        // Add 'en' and 'ar' translations here if needed
    };

    // --- Car Data (Full object restored) ---
    const car_data = {
        "Stellantis": { "Peugeot": { models: ["208", "308", "301"] }, "Citroën": { models: ["C3", "C4"] }, "Fiat": { models: ["500", "Tipo"] }, "Jeep": { models: ["Renegade", "Compass"] } },
        "Volkswagen Group": { "Volkswagen": { models: ["Golf", "Polo", "Passat"] }, "Audi": { models: ["A3", "A4"] }, "Seat": { models: ["Ibiza", "Leon"] }, "Skoda": { models: ["Fabia", "Octavia"] } },
        "Renault-Nissan-Mitsubishi Alliance": { "Renault": { models: ["Clio", "Megane", "Captur"] }, "Nissan": { models: ["Micra", "Qashqai"] }, "Dacia": { models: ["Logan", "Sandero", "Duster"] }, "Mitsubishi": { models: ["L200", "Pajero"] } },
        "Hyundai Motor Group": { "Hyundai": { models: ["i10", "i20", "Accent"] }, "Kia": { models: ["Picanto", "Rio", "Sportage"] } },
        "Toyota Motor Corp": { "Toyota": { models: ["Yaris", "Corolla", "Hilux"] } },
        "Mercedes-Benz Group": { "Mercedes-Benz": { models: ["A-Class", "C-Class"] } },
        "BMW Group": { "BMW": { models: ["Series 1", "Series 3", "X1"] } }
    };
    const currentYear = new Date().getFullYear();
    const years = Array.from({ length: currentYear - 1989 }, (_, i) => currentYear - i);
    
    // --- DOM References ---
    const appContainer = document.getElementById("app-container");

    // --- Utility Functions ---
    const populateSelect = (selectEl, options, defaultLabel) => {
        if (!selectEl) return;
        selectEl.innerHTML = `<option value="">${defaultLabel}</option>`;
        options.forEach(opt => selectEl.insertAdjacentHTML('beforeend', `<option value="${opt}">${opt}</option>`));
    };
    const translatePage = () => { /* Simplified for brevity, you can add your full translation logic here */ };


    // --- View Rendering ---
    const renderView = (viewName, data = null) => {
        appContainer.innerHTML = '';
        const template = document.getElementById(`${viewName}-view-template`);
        if (template) {
            appContainer.appendChild(template.content.cloneNode(true));
            const renderFunctions = {
                'home': renderHomePage,
                'filter-drilldown': renderFilterDrilldownPage,
                // Add other render functions here as you build them
            };
            // Use optional chaining to prevent crash if function doesn't exist yet
            renderFunctions[viewName]?.(data);
        } else {
            console.error(`Template not found for view: ${viewName}`);
            renderView('home'); // Fallback to home
        }
    };
    
    const renderHomePage = (filters = null) => {
        document.querySelectorAll('.category-link').forEach(link => 
            link.addEventListener('click', e => {
                e.preventDefault();
                renderView('filter-drilldown', { category: e.currentTarget.dataset.category });
            })
        );
        renderListings(filters);
    };

    const renderFilterDrilldownPage = (data) => {
        document.getElementById('back-to-home-btn').addEventListener('click', () => renderView('home'));
        const categoryName = translations['fr'][`category_${data.category}`] || "Filtres";
        document.getElementById('drilldown-title').textContent = `Filtres pour: ${categoryName}`;

        const companySelect = document.getElementById('filter-company');
        const brandSelect = document.getElementById('filter-brand');
        const modelSelect = document.getElementById('filter-model');
        const yearSelect = document.getElementById('filter-year');

        populateSelect(companySelect, Object.keys(car_data), "Choisissez un constructeur");
        
        companySelect.addEventListener('change', () => {
            const selectedCompany = companySelect.value;
            brandSelect.disabled = true; modelSelect.disabled = true; yearSelect.disabled = true;
            if (selectedCompany) {
                populateSelect(brandSelect, Object.keys(car_data[selectedCompany]), "Choisissez une marque");
                brandSelect.disabled = false;
            }
        });

        brandSelect.addEventListener('change', () => {
            const selectedCompany = companySelect.value;
            const selectedBrand = brandSelect.value;
            modelSelect.disabled = true; yearSelect.disabled = true;
            if (selectedBrand) {
                populateSelect(modelSelect, car_data[selectedCompany][selectedBrand].models, "Choisissez un modèle");
                modelSelect.disabled = false;
            }
        });

        modelSelect.addEventListener('change', () => {
            yearSelect.disabled = true;
            if(modelSelect.value){
                populateSelect(yearSelect, years, "Choisissez une année");
                yearSelect.disabled = false;
            }
        });
        
        document.getElementById('show-results-btn').addEventListener('click', () => {
            const filters = {
                category: data.category,
                company: companySelect.value,
                brand: brandSelect.value,
                model: modelSelect.value,
                year: yearSelect.value
            };
            renderView('home', filters);
        });
    };
    
    const renderListings = async (filters) => {
        const listingsSection = document.getElementById('listings-section');
        listingsSection.innerHTML = `<p class="col-span-full text-center py-12 text-gray-600">Chargement des annonces...</p>`;
        try {
            if (allProducts.length === 0) {
                const querySnapshot = await getDocs(query(collection(db, "products")));
                allProducts = querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
            }
            // Simple filter for demonstration. You can make this more complex.
            let filteredProducts = allProducts;
            if(filters?.brand) {
                filteredProducts = allProducts.filter(p => p.brand === filters.brand);
            }
            displayProducts(filteredProducts, listingsSection);
        } catch (err) { 
             listingsSection.innerHTML = `<p class="col-span-full text-center py-12 text-red-500">Erreur de chargement.</p>`;
        }
    };

    const displayProducts = (products, container) => {
        if (!container) return;
        container.innerHTML = "";
        if (products.length === 0) {
            container.innerHTML = `<p class="col-span-full text-center py-12 text-gray-500">Aucune annonce trouvée pour ces critères.</p>`;
            return;
        }
        products.forEach(item => {
            const card = document.createElement("article");
            card.className = "bg-white rounded-xl shadow-lg overflow-hidden flex flex-col cursor-pointer transform transition-all duration-300 hover:scale-105 hover:shadow-2xl";
            // card.addEventListener('click', () => renderView('product-detail', item)); // Temporarily disable to prevent errors
            card.innerHTML = `
                <img src="https://via.placeholder.com/300x200.png?text=No+Image" alt="${item.title}" class="w-full h-40 sm:h-48 object-cover" loading="lazy" />
                <div class="p-4 flex-1 flex flex-col">
                    <h3 class="font-semibold text-gray-800 text-lg mb-1">${item.title}</h3>
                    <p class="text-blue-600 font-bold text-xl mt-auto pt-2">${(item.price || 0).toLocaleString()} DA</p>
                </div>`;
            container.appendChild(card);
        });
    };

    // --- Initial Setup ---
    const setupGlobalEventListeners = () => {
        document.getElementById('mobile-menu-btn').addEventListener('click', () => document.getElementById('mobile-menu').classList.remove('hidden'));
        document.getElementById('mobile-menu-close-btn').addEventListener('click', () => document.getElementById('mobile-menu').classList.add('hidden'));
        document.getElementById('home-link').addEventListener('click', (e) => { e.preventDefault(); renderView('home'); });
    };

    const bootApp = () => {
        document.getElementById('current-year').textContent = new Date().getFullYear();
        setupGlobalEventListeners();
        onAuthStateChanged(auth, user => {
            currentUser = user;
            const authLinks = document.getElementById('auth-links');
            const authLinksMobile = document.getElementById('auth-links-mobile');
            const openAuthModal = () => document.getElementById('auth-modal').classList.remove('hidden');

            if (user) {
                authLinks.innerHTML = `<button id="signout-btn" class="text-white bg-red-500 hover:bg-red-600 px-5 py-2 rounded-full font-semibold transition-all duration-200 shadow-md hover:shadow-lg" data-i18n-key="logout">Déconnexion</button>`;
                authLinks.querySelector('#signout-btn').addEventListener('click', () => signOut(auth));
                
                authLinksMobile.innerHTML = `<button class="text-left w-full hover:text-red-500 py-2" data-i18n-key="logout">Déconnexion</button>`;
                authLinksMobile.querySelector('button').onclick = () => { signOut(auth); document.getElementById('mobile-menu').classList.add('hidden'); };

            } else {
                authLinks.innerHTML = `<button id="login-btn" class="text-white bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded-full font-semibold transition-all duration-200 shadow-md hover:shadow-lg" data-i18n-key="connect">Se connecter</button>`;
                authLinks.querySelector('#login-btn').addEventListener('click', openAuthModal);

                authLinksMobile.innerHTML = `<button class="text-left w-full hover:text-blue-600 py-2" data-i18n-key="connect">Se connecter</button>`;
                authLinksMobile.querySelector('button').onclick = openAuthModal;
            }
        });
        document.getElementById('google-login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider).then(() => document.getElementById('auth-modal').classList.add('hidden'));
        });
        renderView('home');
    };

    bootApp();
</script>
</body>
</html>
