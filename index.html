<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <title>Piecety - Marché des Pièces Auto en Algérie</title>
    <meta name="description" content="Le marché algérien des pièces automobiles le plus fiable. Trouvez la bonne pièce pour votre voiture à Hassi R'Mel et dans toute l'Algérie.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚗</text></svg>">
    <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Piecety&quot;,&quot;short_name&quot;:&quot;Piecety&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#2563eb&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚗</text></svg>&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        body {
            font-family: 'Inter', 'Noto Sans Arabic', sans-serif;
            background-color: #f7fafc;
        }
        .dark body {
            background-color: #111827;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Focus visible for accessibility */
        :focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* Modal transitions */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        /* Category Card Hover Effect */
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .dark .category-card:hover {
             box-shadow: 0 10px 15px rgba(255, 255, 255, 0.1);
        }
        .category-card:hover .category-icon {
            transform: scale(1.1);
            background-color: #dbeafe; /* bg-blue-100 */
        }
        .dark .category-card:hover .category-icon {
             background-color: #374151; /* dark:bg-gray-700 */
        }

    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800 dark:text-gray-200">

<div id="message-box" class="fixed top-5 right-5 z-[1000] p-4 rounded-lg shadow-lg transition-all duration-500 ease-in-out opacity-0 translate-x-full max-w-sm break-words"></div>

<header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50" role="banner">
    <div class="container mx-auto p-4 flex items-center justify-between">
        <a href="#" id="home-link" class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400 logo transition-transform hover:scale-105 flex items-center">
            <svg class="h-8 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.92,7.62A1,1,0,0,0,21,7H18.32a3,3,0,0,0-5.64,0H3a1,1,0,0,0-1,1V17a1,1,0,0,0,1,1H4.2a3,3,0,0,0,5.6,0H16.2a3,3,0,0,0,5.6,0H23a1,1,0,0,0,1-1V8.62A1,1,0,0,0,21.92,7.62ZM6,15a1,1,0,1,1,1-1A1,1,0,0,1,6,15Zm12,0a1,1,0,1,1,1-1A1,1,0,0,1,18,15Z"></path></svg>
            Piecety
        </a>

        <div class="flex-1 mx-4 sm:mx-8">
            <div class="relative">
                <input id="search-input" type="text" placeholder="Rechercher une pièce..." class="w-full p-3 pl-10 rounded-full border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 shadow-inner" aria-label="Rechercher une pièce" />
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <nav class="hidden md:flex items-center space-x-4" role="navigation" aria-label="Main navigation">
             <div class="relative group">
                <button id="lang-dropdown-btn" aria-haspopup="true" aria-expanded="false" class="flex items-center space-x-1 p-2 font-medium text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-200">
                    <span id="current-lang" class="lang-text">FR</span>
                    <i class="fas fa-chevron-down text-xs"></i>
                </button>
                <div id="lang-dropdown" class="absolute right-0 mt-2 w-28 bg-white dark:bg-gray-700 rounded-lg shadow-lg py-1 hidden transition-all duration-300 z-10" role="menu" aria-label="Select Language">
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-600 dark:hover:text-blue-300 lang-btn" data-lang="fr" role="menuitem">Français</button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-600 dark:hover:text-blue-300 lang-btn" data-lang="en" role="menuitem">English</button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-600 dark:hover:text-blue-300 lang-btn" data-lang="ar" role="menuitem">العربية</button>
                </div>
            </div>

            <button id="dark-mode-toggle" class="p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none" aria-label="Toggle Dark Mode">
                <i class="fas fa-moon text-xl"></i>
            </button>
            <a href="#" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 font-medium transition-colors duration-200" data-i18n-key="sell" id="sell-link">Vendre</a>
            
            <button id="cart-btn" class="relative p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none" aria-label="Shopping Cart">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
            </button>
            
            <div id="auth-links" class="flex items-center space-x-4"></div>
        </nav>

        <button id="mobile-menu-btn" class="md:hidden p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none" aria-label="Menu" aria-expanded="false" aria-controls="mobile-menu">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>
</header>

<div id="mobile-menu" class="fixed inset-0 bg-white dark:bg-gray-900 z-40 hidden flex-col p-6 space-y-6 md:hidden" role="dialog" aria-modal="true" aria-labelledby="mobile-menu-label">
    <div class="flex justify-between items-center">
        <h2 id="mobile-menu-label" class="text-2xl font-bold text-blue-600 dark:text-blue-400" data-i18n-key="menu">Menu</h2>
        <button id="mobile-menu-close-btn" class="p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400" aria-label="Fermer menu">
            <i class="fas fa-times text-2xl"></i>
        </button>
    </div>
    <div id="mobile-nav-links" class="flex flex-col space-y-6"></div>
    <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300" data-i18n-key="language">Langue</h3>
        <div class="flex space-x-4 mt-2">
            <button class="p-2 border dark:border-gray-600 rounded-md text-sm font-medium lang-btn" data-lang="fr">Français</button>
            <button class="p-2 border dark:border-gray-600 rounded-md text-sm font-medium lang-btn" data-lang="en">English</button>
            <button class="p-2 border dark:border-gray-600 rounded-md text-sm font-medium lang-btn" data-lang="ar">العربية</button>
        </div>
    </div>
</div>

<main id="app-container" class="flex-1 container mx-auto p-4 md:p-8" role="main" aria-live="polite"></main>

<footer class="bg-gray-800 dark:bg-gray-900 text-white p-6 md:p-8 mt-auto text-center">
    <div class="flex justify-center space-x-6 mb-4">
        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-facebook-f text-xl"></i></a>
        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-instagram text-xl"></i></a>
        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-twitter text-xl"></i></a>
    </div>
    <p class="text-sm font-light">
        &copy; <span id="current-year"></span> Piecety - Marché des Pièces Auto en Algérie.<br>
        <span class="text-xs" data-i18n-key="footer_location_text">Fièrement au service de Hassi R'Mel et de toute l'Algérie.</span>
    </p>
    <p class="text-xs mt-2 text-gray-400"><a href="#" class="hover:underline">Contact Us</a> | <a href="#" class="hover:underline">Terms of Service</a></p>
</footer>

<div id="post-product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 invisible opacity-0" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] flex flex-col">
        <div class="overflow-y-auto p-6 relative">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-600 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 focus:outline-none" aria-label="Fermer le formulaire">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h3 id="modal-title" class="text-2xl font-bold mb-6 text-center" data-i18n-key="submit_ad">Soumettre une annonce rapide</h3>
            <form id="post-product-form" class="space-y-4" novalidate>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="product-title" class="block font-medium mb-1" data-i18n-key="ad_title_label">Titre de la pièce <span class="text-red-500">*</span></label>
                        <input type="text" id="product-title" name="title" required placeholder="Ex: Disque de frein avant" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="title-error" />
                        <p id="title-error" class="text-red-500 text-sm mt-1 hidden" aria-live="assertive">Veuillez entrer un titre valide.</p>
                    </div>
                    <div>
                        <label for="product-brand" class="block font-medium mb-1" data-i18n-key="brand_label">Marque <span class="text-red-500">*</span></label>
                        <select id="product-brand" name="brand" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="brand-error">
                            <option value="" data-i18n-key="select_brand">Sélectionnez une marque</option>
                        </select>
                        <p id="brand-error" class="text-red-500 text-sm mt-1 hidden" aria-live="assertive">Veuillez sélectionner une marque.</p>
                    </div>
                    <div>
                        <label for="product-model" class="block font-medium mb-1" data-i18n-key="model_label">Modèle</label>
                        <select id="product-model" name="model" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <option value="" data-i18n-key="select_model">Sélectionnez un modèle</option>
                        </select>
                    </div>
                    <div>
                        <label for="product-year" class="block font-medium mb-1" data-i18n-key="year_label">Année</label>
                        <select id="product-year" name="year" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" data-i18n-key="select_year">Sélectionnez une année</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="product-wilaya" class="block font-medium mb-1" data-i18n-key="wilaya_label">Wilaya <span class="text-red-500">*</span></label>
                        <select id="product-wilaya" name="wilaya" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="wilaya-error">
                            <option value="" data-i18n-key="select_wilaya">Sélectionnez une wilaya</option>
                        </select>
                        <p id="wilaya-error" class="text-red-500 text-sm mt-1 hidden" aria-live="assertive">Veuillez sélectionner une wilaya.</p>
                    </div>
                    <div>
                        <label for="product-commune" class="block font-medium mb-1" data-i18n-key="commune_label">Commune</label>
                        <select id="product-commune" name="commune" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <option value="" data-i18n-key="select_commune">Sélectionnez une commune</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="product-category" class="block font-medium mb-1" data-i18n-key="category_label">Catégorie <span class="text-red-500">*</span></label>
                        <select id="product-category" name="category" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="category-error">
                             <option value="" data-i18n-key="select_category">Sélectionnez une catégorie</option>
                        </select>
                        <p id="category-error" class="text-red-500 text-sm mt-1 hidden" aria-live="assertive">Veuillez sélectionner une catégorie.</p>
                    </div>
                    <div>
                        <label for="product-condition" class="block font-medium mb-1" data-i18n-key="condition_label">État</label>
                        <select id="product-condition" name="condition" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="new" data-i18n-key="new">Neuf</option>
                            <option value="used" data-i18n-key="used">Occasion</option>
                        </select>
                    </div>
                    <div>
                        <label for="product-price" class="block font-medium mb-1" data-i18n-key="price_label">Prix (DA) <span class="text-red-500">*</span></label>
                        <input type="number" id="product-price" name="price" min="0" required placeholder="Ex: 15000" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="price-error" />
                        <p id="price-error" class="text-red-500 text-sm mt-1 hidden" aria-live="assertive">Veuillez entrer un prix valide.</p>
                    </div>
                </div>
                <div>
                    <label for="product-description" class="block font-medium mb-1" data-i18n-key="description_label">Description</label>
                    <textarea id="product-description" name="description" rows="3" placeholder="Informations supplémentaires..." class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" id="submit-ad-btn" class="mt-4 px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md flex items-center justify-center disabled:bg-blue-400 disabled:cursor-not-allowed">
                        <span class="btn-text" data-i18n-key="submit_ad_btn_text">Soumettre</span>
                        <svg class="animate-spin ml-3 h-5 w-5 text-white hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="auth-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 invisible opacity-0" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-sm w-full p-6 relative">
        <button id="auth-modal-close-btn" class="absolute top-4 right-4 text-gray-600 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 focus:outline-none" aria-label="Fermer le formulaire de connexion">
            <i class="fas fa-times text-2xl"></i>
        </button>
        <h3 id="auth-modal-title" class="text-2xl font-bold mb-6 text-center" data-i18n-key="connect">Se connecter</h3>
        <div class="space-y-4">
            <p class="text-center text-gray-600 dark:text-gray-400" data-i18n-key="login_text">Connectez-vous pour accéder à toutes les fonctionnalités.</p>
            <button id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-gray-700 dark:text-gray-200 font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200 shadow-sm">
                <i class="fab fa-google text-xl mr-2"></i>
                <span data-i18n-key="google_login">Se connecter avec Google</span>
            </button>
        </div>
    </div>
</div>

<template id="home-view-template">
    <section class="text-center py-12 md:py-20 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg mb-8 md:mb-12">
        <h1 class="text-3xl md:text-5xl font-extrabold mb-4" data-i18n-key="hero_title">Trouvez la bonne pièce pour votre voiture</h1>
        <p class="text-lg md:text-xl font-light mb-8 max-w-3xl mx-auto" data-i18n-key="hero_subtitle">Le marché algérien des pièces automobiles le plus fiable.</p>
    </section>

    <section class="mb-8 md:mb-12" aria-labelledby="categories-title">
        <h2 id="categories-title" class="text-2xl md:text-3xl font-bold mb-6 text-center" data-i18n-key="categories_title">Catégories de Pièces</h2>
        <div id="categories-grid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4 md:gap-6"></div>
    </section>

    <div class="flex flex-col md:flex-row gap-8">
        <aside id="filters-sidebar" class="w-full md:w-1/4 lg:w-1/5 md:block hidden">
             <div id="filters-content" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 space-y-6"></div>
        </aside>

        <section class="w-full md:w-3/4 lg:w-4/5">
             <div class="flex justify-between items-center mb-6">
                <button id="show-filters-btn" class="md:hidden w-full px-6 py-3 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-md font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200 shadow-md" data-i18n-key="show_filters">
                    Afficher les filtres
                </button>
            </div>
            <div id="listings-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </section>
    </div>
</template>

<template id="filters-template">
    <h2 class="text-2xl font-bold" data-i18n-key="filters_title">Filtrer les annonces</h2>
    <div>
        <label for="brand-filter" class="block text-sm font-medium" data-i18n-key="all_brands">Toutes les marques</label>
        <select id="brand-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="all_brands">Toutes les marques</option>
        </select>
    </div>
    <div id="model-filter-container" class="hidden">
        <label for="model-filter" class="block text-sm font-medium" data-i18n-key="all_models">Tous les modèles</label>
        <select id="model-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="all_models">Tous les modèles</option>
        </select>
    </div>
    <div>
        <label for="year-filter" class="block text-sm font-medium" data-i18n-key="all_years">Toutes années</label>
        <select id="year-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="all_years">Toutes années</option>
        </select>
    </div>
    <div>
        <label for="wilaya-filter" class="block text-sm font-medium" data-i18n-key="all_wilayas">Toutes wilayas</label>
        <select id="wilaya-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="all_wilayas">Toutes wilayas</option>
        </select>
    </div>
    <div id="commune-filter-container" class="hidden">
        <label for="commune-filter" class="block text-sm font-medium" data-i18n-key="all_communes">Toutes communes</label>
        <select id="commune-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="all_communes">Toutes communes</option>
        </select>
    </div>
    <div>
        <label for="category-filter" class="block text-sm font-medium" data-i18n-key="all_categories">Toutes catégories</label>
        <select id="category-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
             <option value="" data-i18n-key="all_categories">Toutes catégories</option>
        </select>
    </div>
    <div>
        <label for="condition-filter" class="block text-sm font-medium" data-i18n-key="condition">État</label>
        <select id="condition-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
            <option value="" data-i18n-key="any_condition">Tout</option>
            <option value="new" data-i18n-key="new">Neuf</option>
            <option value="used" data-i18n-key="used">Occasion</option>
        </select>
    </div>
    <div>
        <label for="price-range-filter" class="block text-sm font-medium" data-i18n-key="price_range">Gamme de prix</label>
        <input type="range" id="price-range-filter" min="0" max="100000" step="1000" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
            <span>0 DA</span>
            <span id="price-range-value">50000 DA</span>
            <span>100k+ DA</span>
        </div>
    </div>

    <div class="mt-6 flex flex-col space-y-4">
        <button id="filter-reset-btn" class="w-full px-6 py-3 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-md font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors duration-200 shadow-md" data-i18n-key="reset">Réinitialiser</button>
    </div>
</template>

<template id="product-detail-view-template">
    <div id="product-detail" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 md:p-8">
        <button id="back-to-listings-btn" class="mb-4 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_listings">Retour aux annonces</span>
        </button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <img id="product-image-detail" src="" alt="" class="w-full h-80 md:h-96 object-cover rounded-lg shadow-md" />
            <div>
                <h2 id="product-title-detail" class="text-2xl md:text-3xl font-bold mb-2"></h2>
                <p id="product-price-detail" class="text-blue-600 dark:text-blue-400 font-bold text-2xl mb-4"></p>
                <div class="space-y-2 text-sm mb-6 border-t border-b dark:border-gray-700 py-4">
                    <p><strong><span data-i18n-key="brand_label">Marque</span>:</strong> <span id="product-brand-detail"></span></p>
                    <p><strong><span data-i18n-key="model_label">Modèle</span>:</strong> <span id="product-model-detail"></span></p>
                    <p><strong><span data-i18n-key="year_label">Année</span>:</strong> <span id="product-year-detail"></span></p>
                    <p><strong><span data-i18n-key="wilaya_label">Wilaya</span>:</strong> <span id="product-wilaya-detail"></span></p>
                    <p><strong><span data-i18n-key="commune_label">Commune</span>:</strong> <span id="product-commune-detail"></span></p>
                    <p><strong>Vendu par:</strong> <a href="#" id="seller-profile-link" class="text-blue-600 dark:text-blue-400 hover:underline"></a></p>
                </div>
                <p id="product-description-detail" class="leading-relaxed mb-6"></p>
                <div class="flex flex-col space-y-3">
                     <button id="add-to-cart-btn" class="w-full px-6 py-3 bg-green-600 text-white rounded-full font-semibold hover:bg-green-700 transition-colors duration-200 shadow-md flex items-center justify-center">
                        <i class="fas fa-cart-plus mr-2"></i>
                        <span data-i18n-key="add_to_cart">Ajouter au panier</span>
                    </button>
                    <button id="contact-seller-btn" class="w-full px-6 py-3 bg-gray-600 text-white rounded-full font-semibold hover:bg-gray-700 transition-colors duration-200 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">
                        <i class="fas fa-comments mr-2"></i>
                        <span data-i18n-key="contact_seller">Contacter le vendeur</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="cart-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <button id="back-from-cart-btn" class="mb-4 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_listings">Retour aux annonces</span>
        </button>
        <div class="flex justify-between items-center mb-6">
             <h2 class="text-2xl md:text-3xl font-bold" data-i18n-key="cart_title">Mon panier</h2>
             <button id="clear-cart-btn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md font-semibold hover:bg-red-700 transition-colors duration-200 shadow-md" data-i18n-key="clear_cart">
                Vider le panier
            </button>
        </div>
        <div id="cart-items-container" class="space-y-4"></div>
        <div id="cart-summary" class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
            <p class="text-xl font-bold flex justify-between">
                <span data-i18n-key="cart_total">Total</span>:
                <span id="cart-total-price">0 DA</span>
            </p>
            <button id="checkout-btn" class="w-full mt-4 px-6 py-3 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition-colors duration-200 shadow-md">
                <span data-i18n-key="checkout_btn">Passer à la caisse</span>
            </button>
        </div>
    </div>
</template>

<template id="dashboard-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl md:text-3xl font-bold mb-6">Mon Tableau de Bord</h2>
        <div id="dashboard-content">
            <h3 class="text-xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Mes Annonces</h3>
            <div id="my-listings-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
    </div>
</template>

<template id="profile-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <div class="flex flex-col md:flex-row items-center md:items-start text-center md:text-left">
            <i class="fas fa-user-circle text-6xl md:text-8xl text-gray-300 md:mr-6 mb-4 md:mb-0"></i>
            <div>
                <h2 id="profile-name" class="text-2xl md:text-3xl font-bold">Nom du vendeur</h2>
                <div id="profile-rating" class="flex items-center justify-center md:justify-start text-yellow-500 mt-2">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i>
                    <span class="text-gray-600 dark:text-gray-400 ml-2 text-sm">(Avis bientôt disponibles)</span>
                </div>
            </div>
        </div>
        
        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Annonces de ce vendeur</h3>
            <div id="user-products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
        
        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Avis des acheteurs</h3>
            <div id="user-reviews-list" class="space-y-4">
                <p class="text-gray-500 dark:text-gray-400">La fonctionnalité d'avis sera bientôt disponible.</p>
            </div>
        </div>
    </div>
</template>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, where, getDocs, doc, setDoc, getDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    // Global state variables
    let currentUser = null;
    let currentLang = localStorage.getItem("piecety_lang") || "fr";
    let currentView = 'home';
    let allProducts = [];
    let userCart = {};
    let userFavorites = [];
    let productsUnsubscribe = null; // To detach the real-time listener

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBIptEskV2soajxRYPDfwYFYyz9pWQvZL0",
        authDomain: "piecety-app-b39c4.firebaseapp.com",
        projectId: "piecety-app-b39c4",
        storageBucket: "piecety-app-b39c4.appspot.com",
        messagingSenderId: "265795860915",
        appId: "1:265795860915:web:aa10241788cce42f6373c6"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Translations
    const translations = {
        fr: {
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "Menu", sell: "Vendre", connect: "Se connecter", language: "Langue",
            hero_title: "Trouvez la bonne pièce pour votre voiture",
            hero_subtitle: "Le marché algérien des pièces automobiles le plus fiable.",
            categories_title: "Catégories de Pièces",
            category_engine: "Moteur", category_brakes: "Freins", category_fuel_system: "Système de carburant",
            category_cooling: "Refroidissement", category_tires: "Pneus & Jantes", category_electrical: "Électrique",
            category_body: "Carrosserie", category_tools: "Outillage",
            filters_title: "Filtrer les annonces", all_brands: "Toutes les marques", all_models: "Tous les modèles",
            all_years: "Toutes années", all_wilayas: "Toutes wilayas", all_communes: "Toutes communes",
            condition: "État", any_condition: "Tout", new: "Neuf", used: "Occasion",
            apply_filters: "Appliquer les filtres", reset: "Réinitialiser",
            search_placeholder: "Rechercher une pièce...",
            footer_location_text: "Fièrement au service de Hassi R'Mel et de toute l'Algérie.",
            submit_ad: "Soumettre une annonce rapide", ad_title_label: "Titre de la pièce", brand_label: "Marque",
            select_brand: "Sélectionnez une marque", model_label: "Modèle", select_model: "Sélectionnez un modèle",
            year_label: "Année", select_year: "Sélectionnez une année", wilaya_label: "Wilaya",
            select_wilaya: "Sélectionnez une wilaya", commune_label: "Commune", select_commune: "Sélectionnez une commune",
            condition_label: "État", price_label: "Prix (DA)", description_label: "Description",
            image_label: "Image", submit_ad_btn_text: "Soumettre", loading_text: "Envoi...",
            login_text: "Connectez-vous pour accéder à toutes les fonctionnalités.", google_login: "Se connecter avec Google",
            back_to_listings: "Retour aux annonces", add_to_cart: "Ajouter au panier",
            cart_title: "Mon panier", cart_total: "Total", checkout_btn: "Passer à la caisse",
            no_listings: "Aucune annonce trouvée.",
            your_cart_is_empty: "Votre panier est vide.",
            remove: "Supprimer", quantity: "Quantité", item_total: "Total de l'article",
            login_required: "Veuillez vous connecter pour utiliser cette fonctionnalité.", dashboard_link_mobile: "Mon Tableau de Bord",
            show_filters: "Afficher les filtres", price_range: "Gamme de prix", all_categories: "Toutes catégories",
            category_label: "Catégorie", select_category: "Sélectionnez une catégorie", contact_seller: "Contacter le vendeur",
            clear_cart: "Vider le panier", favorite_added: "Ajouté aux favoris", favorite_removed: "Retiré des favoris",
        },
        en: {
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "Menu", sell: "Sell", connect: "Log In", language: "Language",
            hero_title: "Find the right car part for your vehicle",
            hero_subtitle: "The most trusted Algerian car parts marketplace.",
            categories_title: "Parts Categories",
            category_engine: "Engine", category_brakes: "Brakes", category_fuel_system: "Fuel System",
            category_cooling: "Cooling", category_tires: "Tires & Rims", category_electrical: "Electrical",
            category_body: "Body", category_tools: "Tools",
            filters_title: "Filter Listings", all_brands: "All brands", all_models: "All models",
            all_years: "All years", all_wilayas: "All wilayas", all_communes: "All communes",
            condition: "Condition", any_condition: "Any", new: "New", used: "Used",
            apply_filters: "Apply Filters", reset: "Reset",
            search_placeholder: "Search for a part...",
            footer_location_text: "Proudly serving Hassi R'Mel and all of Algeria.",
            submit_ad: "Submit a quick ad", ad_title_label: "Part Title", brand_label: "Brand",
            select_brand: "Select a brand", model_label: "Model", select_model: "Select a model",
            year_label: "Year", select_year: "Select a year", wilaya_label: "Wilaya",
            select_wilaya: "Select a wilaya", commune_label: "Commune", select_commune: "Select a commune",
            condition_label: "Condition", price_label: "Price (DA)", description_label: "Description",
            image_label: "Image", submit_ad_btn_text: "Submit", loading_text: "Submitting...",
            login_text: "Log in to access all features.", google_login: "Sign in with Google",
            back_to_listings: "Back to listings", add_to_cart: "Add to cart",
            cart_title: "My Cart", cart_total: "Total", checkout_btn: "Proceed to Checkout",
            no_listings: "No listings found.",
            your_cart_is_empty: "Your cart is empty.",
            remove: "Remove", quantity: "Quantity", item_total: "Item Total",
            login_required: "Please log in to use this feature.", dashboard_link_mobile: "My Dashboard",
            show_filters: "Show Filters", price_range: "Price Range", all_categories: "All Categories",
            category_label: "Category", select_category: "Select a category", contact_seller: "Contact Seller",
            clear_cart: "Clear Cart", favorite_added: "Added to favorites", favorite_removed: "Removed from favorites",
        },
        ar: {
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "القائمة", sell: "بيع", connect: "تسجيل الدخول", language: "اللغة",
            hero_title: "ابحث عن قطعة الغيار المناسبة لسيارتك",
            hero_subtitle: "أكثر أسواق قطع غيار السيارات ثقة في الجزائر.",
            categories_title: "فئات القطع",
            category_engine: "محرك", category_brakes: "مكابح", category_fuel_system: "نظام الوقود",
            category_cooling: "التبريد", category_tires: "الإطارات والعجلات", category_electrical: "كهربائي",
            category_body: "هيكل", category_tools: "أدوات",
            filters_title: "تصفية الإعلانات", all_brands: "جميع الماركات", all_models: "جميع الموديلات",
            all_years: "جميع السنوات", all_wilayas: "جميع الولايات", all_communes: "جميع البلديات",
            condition: "الحالة", any_condition: "الكل", new: "جديد", used: "مستعمل",
            apply_filters: "تطبيق الفلاتر", reset: "إعادة تعيين",
            search_placeholder: "ابحث عن قطعة...",
            footer_location_text: "بكل فخر في خدمة حاسي الرمل و كل الجزائر.",
            submit_ad: "إرسال إعلان سريع", ad_title_label: "عنوان القطعة", brand_label: "الماركة",
            select_brand: "اختر ماركة", model_label: "الموديل", select_model: "اختر موديل",
            year_label: "السنة", select_year: "اختر سنة", wilaya_label: "الولاية",
            select_wilaya: "اختر ولاية", commune_label: "البلدية", select_commune: "اختر بلدية",
            condition_label: "الحالة", price_label: "السعر (دج)", description_label: "الوصف",
            image_label: "الصورة", submit_ad_btn_text: "إرسال", loading_text: "جار الإرسال...",
            login_text: "تسجيل الدخول للوصول إلى جميع الميزات.", google_login: "تسجيل الدخول باستخدام Google",
            back_to_listings: "العودة إلى الإعلانات", add_to_cart: "أضف إلى السلة",
            cart_title: "سلة التسوق", cart_total: "الإجمالي", checkout_btn: "الدفع",
            no_listings: "لم يتم العثور على إعلانات.",
            your_cart_is_empty: "سلة التسوق فارغة.",
            remove: "حذف", quantity: "الكمية", item_total: "إجمالي السلعة",
            login_required: "يرجى تسجيل الدخول لاستخدام هذه الميزة.", dashboard_link_mobile: "لوحة التحكم",
            show_filters: "إظهار الفلاتر", price_range: "نطاق السعر", all_categories: "جميع الفئات",
            category_label: "الفئة", select_category: "اختر فئة", contact_seller: "اتصل بالبائع",
            clear_cart: "إفراغ السلة", favorite_added: "أضيفت إلى المفضلة", favorite_removed: "أزيلت من المفضلة",
        }
    };

    // Data for dynamic dropdowns
    const categories = {
        "engine": { fr: "Moteur", en: "Engine", ar: "محرك", icon: "fa-cogs" },
        "brakes": { fr: "Freins", en: "Brakes", ar: "مكابح", icon: "fa-car" },
        "fuel_system": { fr: "Système de carburant", en: "Fuel System", ar: "نظام الوقود", icon: "fa-gas-pump" },
        "cooling": { fr: "Refroidissement", en: "Cooling", ar: "التبريد", icon: "fa-fan" },
        "tires": { fr: "Pneus & Jantes", en: "Tires & Rims", ar: "الإطارات والعجلات", icon: "fa-circle" },
        "electrical": { fr: "Électrique", en: "Electrical", ar: "كهربائي", icon: "fa-bolt" },
        "body": { fr: "Carrosserie", en: "Body", ar: "هيكل", icon: "fa-car-side" },
        "tools": { fr: "Outillage", en: "Tools", ar: "أدوات", icon: "fa-wrench" },
    };
    const wilayas = {
        "Adrar": ["Adrar", "Charouine", "Tamest", "Reggane", "Aoulef", "Fenoughil", "Timimoun", "Talmine", "Bordj Badji Mokhtar", "In Salah"], 
        "Chlef": ["Chlef", "Ténès", "Ouled Farès", "El Marsa", "Abou El Hassan", "Oued Fodda", "Beni Haoua", "El Karimia", "Taougrite", "Harchoun"], 
        "Laghouat": ["Aïn Madhi", "Aflou", "El Ghicha", "El Houaita", "El Assafia", "Ksar El Hirane", "Laghouat", "Taougrite", "Sidi Makhlouf", "Ouled Farès", "Hassi R'Mel"], 
        "Oum El Bouaghi": ["Aïn Beïda", "Aïn Fekroun", "Aïn Babouche", "Aïn M'lila", "Dhalaâ", "F'kirina", "Oum El Bouaghi", "Sidi R'ghiss", "Souk Naamane", "El Fedjoudj"], 
        "Batna": ["Aïn Touta", "Arris", "Barika", "Batna", "El Madher", "Menaa", "Merouana", "Ras El Aioun", "Timgad", "Ouled Si Slimane"], 
        "Béjaïa": ["Aïn El Kebira", "Akbou", "Béjaïa", "El Kseur", "Sidi Aïch", "Tichy", "Toudja", "Aokas", "Ighil Ali", "Darguina"], 
        "Biskra": ["Biskra", "El Kantara", "Sidi Okba", "Ourlal", "Zeribet El Oued", "Tolga", "Sidi Khaled", "Djemorah", "M'chouneche", "El Outaya"], 
        "Béchar": ["Béchar", "Abadla", "Beni Ounif", "Lahmar", "Tabelbala", "Kenadsa", "Igli", "Taghit", "Mechraâ Houari Boumediene", "Ouled Khoudir"], 
        "Blida": ["Blida", "Boufarik", "Chebli", "Oued El Alleug", "Larbaâ", "Meftah", "Soumaâ", "Bougara", "Mouzaia", "Chréa"], 
        "Bouira": ["Bouira", "Lakhdaria", "Sour El Ghozlane", "Ahnif", "Bir Ghbalou", "Haïzer", "M'chedallah", "El Hachimia", "Sidi Aïssa", "Taghzout"], 
        "Tamanrasset": ["Tamanrasset", "Abalessa", "Idles", "In Amguel", "Tazrouk", "Tin Zaouatine", "In Guezzam", "Djanet", "Bordj Omar Driss", "Illizi"], 
        "Tébessa": ["Tébessa", "Bir El Ater", "Cheria", "El Aouinet", "El Kouif", "El Ma Labiod", "Morsott", "Ouenza", "Bir Mokkadem", "Hammamet"], 
        "Tlemcen": ["Tlemcen", "Ghazaouet", "Maghnia", "Remchi", "Sebdou", "Sidi Djillali", "Hennaya", "Nedroma", "Marsa Ben M'Hidi", "Beni Snous"], 
        "Tiaret": ["Tiaret", "Aïn Deheb", "Frenda", "Ksar Chellala", "Mahdia", "Rahouia", "Sougueur", "Dahmouni", "Sidi Ali Mellal", "Medroussa"], 
        "Tizi Ouzou": ["Tizi Ouzou", "Aïn El Hammam", "Azazga", "Bouzeguène", "Draâ Ben Khedda", "Ouacif", "Larbaâ Nath Irathen", "Tigzirt", "Tizi Gheniff", "Maâtkas"], 
        "Alger": ["Alger", "Bab El Oued", "Baraki", "Bir Mourad Raïs", "Birkhadem", "Bologhine", "Bordj El Kiffan", "Hussein Dey", "Hydra", "Dar El Beïda"], 
        "Djelfa": ["Djelfa", "Aïn Oussera", "Messaad", "Hassi Bahbah", "Had Sahary", "Guettara", "El Idrissia", "Dar Chioukh", "Zaccar", "Faidh El Botma"], 
        "Jijel": ["Jijel", "Taher", "El Milia", "Chekfa", "Ziamamansouria", "Texenna", "Djemaa Beni Habibi", "Sidi Maarouf", "Settara", "Kaous"], 
        "Sétif": ["Sétif", "Aïn Oulmane", "El Eulma", "Bousselam", "Beni Ouartilane", "Bougaâ", "Salah Bey", "Hammamlou", "Guenzet", "Maouaklane"], 
        "Saïda": ["Saïda", "Aïn El Hadjar", "Sidi Boubkeur", "Youb", "El Hassasna", "Tircine", "Maamora", "Ouled Brahim", "Aïn Sekhouna", "Moulay Larbi"], 
        "Skikda": ["Skikda", "Aïn Bouziane", "Azzaba", "El Harrouch", "Collo", "Filfila", "Ramdane Djamel", "Salah Bouchaour", "Zerdaza", "Beni Oulbane"], 
        "Sidi Bel Abbès": ["Sidi Bel Abbès", "Sfisef", "Telagh", "Ras El Ma", "Tessala", "Aïn El Berd", "Boukhanafis", "Ben Badis", "Sidi Chaib", "Moulay Slissen"], 
        "Annaba": ["Annaba", "El Hadjar", "Berrahal", "El Bouni", "Seraïdi", "Chetaïbi", "Oued El Aneb", "Aïn El Berda", "Trézel", "Sidi Amar"], 
        "Guelma": ["Guelma", "Héliopolis", "Oued Zenati", "Bouchegouf", "Ain Reggada", "Tamlouka", "Dkhila", "Bou Hachana", "Belkheir", "Bordj Sabath"], 
        "Constantine": ["Constantine", "El Khroub", "Hamma Bouziane", "Aïn Smara", "Didouche Mourad", "Zighoud Youcef", "Messaoud Boudjriou", "Beni Hamidane", "Ibn Ziad", "Oued El Hadjar"], 
        "Médéa": ["Médéa", "Berrouaghia", "Chahbounia", "Tablat", "Aïn Boucif", "Beni Slimane", "El Azizia", "Si Mahdjoub", "Ouzera", "Ksar Boukhari"], 
        "Mostaganem": ["Mostaganem", "Hassi Mameche", "Aïn Tédelès", "Sidi Ali", "Bouguirat", "Achaacha", "Khadra", "Oued El Kheir", "Mazagran", "Foran"], 
        "M'Sila": ["M'Sila", "Bou Saâda", "Aïn El Melh", "Sidi Aïssa", "Magra", "M'Cif", "Hammam Dhalaâ", "Ouled Derradj", "Ben Srour", "Ouanougha"], 
        "Mascara": ["Mascara", "Ghriss", "Tighennif", "Sig", "Bou Hanifia", "Oued Taria", "Hachem", "Mohammadia", "El Bordj", "Aïn Fares"], 
        "Ouargla": ["Ouargla", "Hassi Messaoud", "Rouissat", "N'Goussa", "Sidi Khouiled", "Blidet Amor", "El Borma", "Tebesbest", "Zaouia El Abidia", "Hassi Ben Abdallah"], 
        "Oran": ["Oran", "Arzew", "Bir El Djir", "Es Senia", "Boutlélis", "Hassi Bounif", "Oued Tlélat", "Sidi Chami", "Gdyel", "Aïn El Turk"], 
        "El Bayadh": ["El Bayadh", "Bougtob", "Chellala", "Breïna", "Rogassa", "Brezina", "Boussemghoun", "El Kheiter", "Kraïr", "Ghassoul"], 
        "Illizi": ["Illizi", "Djanet", "Bordj El Houasse", "Tamanrasset", "In Salah", "Abalessa", "Tazrouk", "Idles", "In Amguel", "Tin Zaouatine"], 
        "Bordj Bou Arréridj": ["Bordj Bou Arréridj", "Ras El Oued", "Mansoura", "Tassameurt", "El Achir", "Medjana", "Bordj Ghedir", "Hammam El Biban", "L'Hassaneia", "Ghassira"], 
        "Boumerdès": ["Boumerdès", "Dellys", "Boudouaou", "Isser", "Béni Amrane", "Naciria", "Corso", "Zemmouri", "Réghaïa", "Tidjelabine"], 
        "El Tarf": ["El Tarf", "Ben M'Hidi", "Besbes", "Drea", "El Kala", "Bougous", "Raml Souk", "Sidi Khelil", "Oued Zitoun", "Aïn Kerma"], 
        "Tindouf": ["Tindouf", "Oum El Assel"], "Tissemsilt": ["Tissemsilt", "Bordj Bounaama", "Lardjem", "Théniet El Had", "Ammi Moussa", "Sidi Boutouchent", "Layoune", "Lazharia", "Bougara", "Bordj Emir Khaled"], 
        "El Oued": ["El Oued", "Guemar", "Hassi Khalifa", "Robbah", "Debila", "Bayadha", "Magrane", "Nakhla", "Kouinine", "El Ogla"], 
        "Khenchela": ["Khenchela", "Aïn Touila", "Bab El Ain", "Kais", "Yabous", "Chechar", "M'Sara", "Ouled Rechache", "Taouzianat", "Remila"], 
        "Souk Ahras": ["Souk Ahras", "Heddada", "M'daourouch", "Mechrouha", "Ouled Driss", "Taoura", "Zaarouria", "Ouillen", "Sidi Fredj", "Tiffech"], 
        "Tipaza": ["Tipaza", "Cherchell", "Koléa", "Fouka", "Hadjout", "Sidi Rached", "Menaceur", "Bou Ismaïl", "Khemis Miliana", "Aïn Tagourait"], 
        "Mila": ["Mila", "Bouhatem", "Ferdjioua", "Grarem Gouga", "Tadjenanet", "Sidi Merouane", "Oued Endja", "Teleghma", "Chigara", "Rouached"], 
        "Aïn Defla": ["Aïn Defla", "Khemis Miliana", "El Attaf", "Aïn Torki", "Djelida", "Rouina", "Hammam Righa", "Miliana", "Boumedfaa", "Aïn Soltane"], 
        "Naâma": ["Naâma", "Mécheria", "Aïn Sefra", "Moghrar", "Tiout", "Sfissifa", "Makman Ben Amer", "Asla", "Kasdir", "El Biod"], 
        "Aïn Témouchent": ["Aïn Témouchent", "Hammam Bou Hadjar", "El Malah", "Béni Saf", "Aghlal", "Chaabat El Ham", "Oued Berkeche", "Aoubellil", "Bouzedjar", "Tamesna"], 
        "Ghardaïa": ["Ghardaïa", "El Guerrara", "Berriane", "Dhayet Bendhahoua", "Metlili", "Zelfana", "Bounoura", "El Atteuf", "Guerrara", "Dra' El Mizan"], 
        "Relizane": ["Relizane", "Oued Rhiou", "Zemmoura", "Sidi M'Hamed Ben Ali", "El H'madna", "Ammi Moussa", "Mazouna", "Mendes", "Ain Tarek", "Oued El Djemaa"], 
        "El M'ghair": ["El M'ghair", "Sidi Amrane", "Djamaa", "Oum Toub", "M'Rara", "Oued Allenda", "Sidi Khelil", "Oued R'hiou", "Sidi Yahia", "Bouchakroun"], 
        "El Meniaa": ["El Meniaa", "Hassi Gara", "Mansourah", "Dhiafat", "El Guerrara", "Tadjmout", "El Hachane", "El Oued", "Chabet El Ami", "Ouled Gacem"]
    };
    const car_data = {
        "Toyota": ["Yaris", "Corolla", "Camry", "Land Cruiser", "Hilux"], "Peugeot": ["208", "308", "301", "2008", "3008", "508"], "Volkswagen": ["Golf", "Polo", "Passat", "Tiguan", "Touareg", "Jetta"], "Renault": ["Clio", "Megane", "Captur", "Duster", "Symbol"], "Hyundai": ["i10", "i20", "Accent", "Tucson", "Santa Fe"], "Nissan": ["Micra", "Sentra", "Qashqai", "X-Trail", "Juke"], "Fiat": ["Panda", "500", "Tipo", "Punto"], "Citroën": ["C3", "C4", "Berlingo", "C-Elysée"], "Kia": ["Picanto", "Rio", "Sportage", "Sorento"], "Mercedes-Benz": ["A-Class", "C-Class", "E-Class", "GLA", "GLC"]
    };
    const currentYear = new Date().getFullYear();
    const years = Array.from({length: currentYear - 1979}, (_, i) => (currentYear - i).toString());

    // DOM Elements
    const DOMElements = {
        html: document.documentElement,
        body: document.body,
        appContainer: document.getElementById("app-container"),
        messageBox: document.getElementById("message-box"),
        langDropdownBtn: document.getElementById("lang-dropdown-btn"),
        langDropdown: document.getElementById("lang-dropdown"),
        currentLangSpan: document.getElementById("current-lang"),
        langBtns: document.querySelectorAll(".lang-btn"),
        searchInput: document.getElementById("search-input"),
        postProductModal: document.getElementById("post-product-modal"),
        modalCloseBtn: document.getElementById("modal-close-btn"),
        postProductForm: document.getElementById("post-product-form"),
        mobileMenuBtn: document.getElementById("mobile-menu-btn"),
        mobileMenu: document.getElementById("mobile-menu"),
        mobileMenuCloseBtn: document.getElementById("mobile-menu-close-btn"),
        mobileNavLinks: document.getElementById("mobile-nav-links"),
        authModal: document.getElementById("auth-modal"),
        authModalCloseBtn: document.getElementById("auth-modal-close-btn"),
        googleLoginBtn: document.getElementById("google-login-btn"),
        cartBtn: document.getElementById("cart-btn"),
        cartCountSpan: document.getElementById("cart-count"),
        authLinksContainer: document.getElementById("auth-links"),
        homeLink: document.getElementById("home-link"),
        sellLink: document.getElementById("sell-link"),
        loginBtn: document.getElementById('login-btn'),
        darkModeToggle: document.getElementById('dark-mode-toggle'),
        postProductBrandSelect: document.getElementById('product-brand'),
        postProductModelSelect: document.getElementById('product-model'),
        postProductYearSelect: document.getElementById('product-year'),
        postProductWilayaSelect: document.getElementById('product-wilaya'),
        postProductCommuneSelect: document.getElementById('product-commune'),
        postProductCategorySelect: document.getElementById('product-category'),
    };
    
    // UTILITY FUNCTIONS
    const showMessage = (msg, duration = 3500, type = "info") => {
        const { messageBox } = DOMElements;
        if (!messageBox) return;
        messageBox.textContent = msg;
        messageBox.className = `fixed top-5 right-5 z-[1000] p-4 rounded-lg shadow-lg transition-all duration-500 ease-in-out max-w-sm break-words`;
        
        let colors = '';
        if (type === 'success') {
            colors = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        } else if (type === 'error') {
            colors = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        } else {
            colors = 'bg-white text-gray-800 dark:bg-gray-700 dark:text-gray-200';
        }
        messageBox.classList.add(...colors.split(' '));

        // Show
        messageBox.classList.remove('opacity-0', 'translate-x-full');
        messageBox.classList.add('opacity-100', 'translate-x-0');

        setTimeout(() => {
            messageBox.classList.remove('opacity-100', 'translate-x-0');
            messageBox.classList.add('opacity-0', 'translate-x-full');
        }, duration);
    };
    
    const updateCartDisplay = () => {
       const { cartCountSpan } = DOMElements;
       const cartItemCount = Object.values(userCart).reduce((sum, item) => sum + item.quantity, 0);
       if (cartCountSpan) {
           if (cartItemCount > 0) {
               cartCountSpan.textContent = cartItemCount;
               cartCountSpan.classList.remove('hidden');
           } else {
               cartCountSpan.classList.add('hidden');
           }
       }
    };

    const debounce = (func, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    };

    // APP LOGIC
    const setDarkMode = (isDark) => {
        DOMElements.html.classList.toggle('dark', isDark);
        localStorage.setItem('piecety_dark_mode', isDark);
        const icon = document.querySelector('#dark-mode-toggle i');
        if (icon) icon.className = isDark ? 'fas fa-sun text-xl' : 'fas fa-moon text-xl';
    };

    const updateTitle = (view, data = null) => {
        let title = "Piecety";
        if (view === 'product-detail' && data) title = `Piecety - ${data.title}`;
        else if (view === 'cart') title = "Piecety - Mon Panier";
        else if (view === 'dashboard') title = "Piecety - Mon Tableau de Bord";
        else if (view === 'profile' && data) title = `Piecety - Profil de ${data.userName}`;
        document.title = title;
    };

    const translatePage = (lang) => {
        const { currentLangSpan, body } = DOMElements;
        if (currentLangSpan) currentLangSpan.textContent = translations[lang][lang + "_short"];
        if (body) {
            if (lang === "ar") {
                body.setAttribute("dir", "rtl");
                body.classList.add("rtl");
            } else {
                body.setAttribute("dir", "ltr");
                body.classList.remove("rtl");
            }
        }
        document.querySelectorAll("[data-i18n-key]").forEach(el => {
            const key = el.getAttribute("data-i18n-key");
            if (translations[lang] && translations[lang][key]) {
                if ((el.tagName === 'INPUT' && (el.type === 'text' || el.type === 'search')) || el.tagName === 'TEXTAREA') {
                    el.placeholder = translations[lang][key];
                } else {
                    el.innerHTML = translations[lang][key];
                }
            }
        });
    };

    const populateSelect = (selectEl, options, defaultLabelKey, lang, valueAsKey = false) => {
        if (!selectEl) return;
        selectEl.innerHTML = "";
        const defaultText = translations[lang][defaultLabelKey] || defaultLabelKey;
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = defaultText;
        selectEl.appendChild(defaultOption);
        
        const optionData = Array.isArray(options) ? options : Object.keys(options);
        
        optionData.forEach(opt => {
            const option = document.createElement('option');
            if (valueAsKey) {
                option.value = opt;
                option.textContent = options[opt][lang];
            } else {
                option.value = opt;
                option.textContent = opt;
            }
            selectEl.appendChild(option);
        });
    };

    const updateURLWithFilters = () => {
        const params = new URLSearchParams();
        const filters = {
            brand: document.getElementById('brand-filter')?.value,
            model: document.getElementById('model-filter')?.value,
            year: document.getElementById('year-filter')?.value,
            wilaya: document.getElementById('wilaya-filter')?.value,
            commune: document.getElementById('commune-filter')?.value,
            category: document.getElementById('category-filter')?.value,
            condition: document.getElementById('condition-filter')?.value,
            price: document.getElementById('price-range-filter')?.value,
            search: DOMElements.searchInput?.value
        };
        for (const key in filters) {
            if (filters[key]) {
                params.set(key, filters[key]);
            }
        }
        const newUrl = params.toString() ? `${window.location.pathname}?${params}` : window.location.pathname;
        window.history.replaceState({path: newUrl}, '', newUrl);
    };

    const applyFiltersFromURL = () => {
        const params = new URLSearchParams(window.location.search);
        params.forEach((value, key) => {
            const el = document.getElementById(`${key}-filter`) || (key === 'search' && DOMElements.searchInput);
            if (el) {
                el.value = value;
                // Trigger change events to populate dependent dropdowns
                if (key === 'brand' || key === 'wilaya') {
                     el.dispatchEvent(new Event('change'));
                }
            }
        });
    };

    // VIEW RENDERING
    const renderView = (viewName, data = null) => {
        if (productsUnsubscribe) {
            productsUnsubscribe(); // Detach old listener
            productsUnsubscribe = null;
        }
        const { appContainer } = DOMElements;
        if (!appContainer) return;
        appContainer.innerHTML = '';
        updateTitle(viewName, data);

        switch (viewName) {
            case 'home':
                appContainer.appendChild(document.getElementById('home-view-template').content.cloneNode(true));
                renderHomePage();
                break;
            case 'product-detail':
                appContainer.appendChild(document.getElementById('product-detail-view-template').content.cloneNode(true));
                renderProductPage(data);
                break;
            case 'cart':
                appContainer.appendChild(document.getElementById('cart-view-template').content.cloneNode(true));
                renderCartPage();
                break;
            case 'dashboard':
                appContainer.appendChild(document.getElementById('dashboard-view-template').content.cloneNode(true));
                renderDashboardPage();
                break;
            case 'profile':
                appContainer.appendChild(document.getElementById('profile-view-template').content.cloneNode(true));
                renderProfilePage(data);
                break;
            default:
                renderView('home');
                break;
        }
        currentView = viewName;
        translatePage(currentLang);
    };

    const renderHomePage = () => {
        // Populate categories
        const categoriesGrid = document.getElementById('categories-grid');
        if (categoriesGrid) {
            for (const key in categories) {
                const cat = categories[key];
                const card = document.createElement('a');
                card.href = `?category=${key}`;
                card.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 text-center category-card transition-all duration-300";
                card.innerHTML = `
                    <div class="p-4 rounded-full bg-blue-50 dark:bg-gray-700 text-blue-600 dark:text-blue-400 mx-auto w-16 h-16 flex items-center justify-center mb-2 transition-transform duration-300 category-icon">
                        <i class="fas ${cat.icon} text-3xl"></i>
                    </div>
                    <h3 class="font-semibold text-sm md:text-base">${cat[currentLang]}</h3>
                `;
                card.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderView('home');
                    setTimeout(() => { // wait for view to render
                        const catFilter = document.getElementById('category-filter');
                        if(catFilter) {
                           catFilter.value = key;
                           updateURLWithFilters();
                           renderListings();
                        }
                    }, 100);
                });
                categoriesGrid.appendChild(card);
            }
        }
        
        // Setup filters
        const filtersContent = document.getElementById('filters-content');
        if (filtersContent) {
            filtersContent.innerHTML = document.getElementById('filters-template').content.cloneNode(true).firstElementChild.innerHTML;
            setupFilterListeners();
            applyFiltersFromURL();
        }
        
        // Mobile filters
        const showFiltersBtn = document.getElementById('show-filters-btn');
        if (showFiltersBtn) {
            showFiltersBtn.addEventListener('click', () => {
                const filtersModal = document.createElement('div');
                filtersModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-end';
                filtersModal.innerHTML = `
                    <div class="w-4/5 max-w-sm h-full bg-white dark:bg-gray-800 shadow-xl p-6 overflow-y-auto space-y-6">
                        ${document.getElementById('filters-template').innerHTML}
                    </div>
                `;
                document.body.appendChild(filtersModal);
                setupFilterListeners(filtersModal);
                applyFiltersFromURL(); // re-apply values to modal filters
                filtersModal.addEventListener('click', (e) => {
                    if (e.target === filtersModal) {
                        filtersModal.remove();
                    }
                });
            });
        }
        
        renderListings();
    };

    const setupFilterListeners = (container = document) => {
        const brandFilter = container.querySelector('#brand-filter');
        const modelFilter = container.querySelector('#model-filter');
        const modelContainer = container.querySelector('#model-filter-container');
        const yearFilter = container.querySelector('#year-filter');
        const wilayaFilter = container.querySelector('#wilaya-filter');
        const communeFilter = container.querySelector('#commune-filter');
        const communeContainer = container.querySelector('#commune-filter-container');
        const categoryFilter = container.querySelector('#category-filter');
        const conditionFilter = container.querySelector('#condition-filter');
        const priceRangeFilter = container.querySelector('#price-range-filter');
        const priceRangeValue = container.querySelector('#price-range-value');
        const resetBtn = container.querySelector('#filter-reset-btn');

        populateSelect(brandFilter, Object.keys(car_data), "all_brands", currentLang);
        populateSelect(yearFilter, years, "all_years", currentLang);
        populateSelect(wilayaFilter, Object.keys(wilayas), "all_wilayas", currentLang);
        populateSelect(categoryFilter, categories, "all_categories", currentLang, true);

        const debouncedFilter = debounce(() => {
            updateURLWithFilters();
            renderListings();
        }, 300);

        DOMElements.searchInput.addEventListener('input', debouncedFilter);
        
        const directFilter = () => {
             updateURLWithFilters();
             renderListings();
        };
        
        if (brandFilter) brandFilter.addEventListener('change', (e) => {
            const val = e.target.value;
            if (val) {
                populateSelect(modelFilter, car_data[val], "all_models", currentLang);
                if (modelContainer) modelContainer.classList.remove("hidden");
                if (modelFilter) modelFilter.disabled = false;
            } else {
                if (modelFilter) modelFilter.innerHTML = `<option value="">${translations[currentLang]["all_models"]}</option>`;
                if (modelContainer) modelContainer.classList.add("hidden");
                if (modelFilter) modelFilter.disabled = true;
            }
            directFilter();
        });

        if (wilayaFilter) wilayaFilter.addEventListener('change', (e) => {
            const val = e.target.value;
            if (val) {
                populateSelect(communeFilter, wilayas[val] || [], "all_communes", currentLang);
                if (communeContainer) communeContainer.classList.remove("hidden");
                if (communeFilter) communeFilter.disabled = false;
            } else {
                if (communeFilter) communeFilter.innerHTML = `<option value="">${translations[currentLang]["all_communes"]}</option>`;
                if (communeContainer) communeContainer.classList.add("hidden");
                if (communeFilter) communeFilter.disabled = true;
            }
             directFilter();
        });

        if (modelFilter) modelFilter.addEventListener('change', directFilter);
        if (yearFilter) yearFilter.addEventListener('change', directFilter);
        if (communeFilter) communeFilter.addEventListener('change', directFilter);
        if (categoryFilter) categoryFilter.addEventListener('change', directFilter);
        if (conditionFilter) conditionFilter.addEventListener('change', directFilter);
        if (priceRangeFilter) {
            priceRangeFilter.addEventListener('input', () => {
                if (priceRangeValue) priceRangeValue.textContent = `${Number(priceRangeFilter.value).toLocaleString()} DA`;
            });
            priceRangeFilter.addEventListener('change', debouncedFilter);
        }

        if (resetBtn) resetBtn.addEventListener('click', () => {
            const formElements = container.querySelectorAll('select, input');
            formElements.forEach(el => {
                if(el.type !== 'range') el.value = '';
                else el.value = el.max / 2;
            });
            DOMElements.searchInput.value = '';
            window.history.replaceState({}, '', window.location.pathname);
            renderListings();
        });
    };

    const renderListings = () => {
        const listingsSection = document.getElementById('listings-section');
        if (!listingsSection) return;
        listingsSection.innerHTML = `<p class="col-span-full text-center py-6" data-i18n-key="loading">Chargement...</p>`;
        
        if (productsUnsubscribe) productsUnsubscribe(); // Unsubscribe from previous listener
        
        const q = query(collection(db, "products"));
        productsUnsubscribe = onSnapshot(q, (querySnapshot) => {
            allProducts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const filtered = filterProducts(allProducts);
            displayProducts(filtered, listingsSection);
            translatePage(currentLang);
        }, (error) => {
            console.error("Error fetching listings: ", error);
            listingsSection.innerHTML = `<p class="col-span-full text-center py-6 text-red-500">Erreur de chargement des annonces.</p>`;
        });
    };
    
    const filterProducts = (products) => {
        const params = new URLSearchParams(window.location.search);
        const brand = params.get('brand')?.toLowerCase();
        const model = params.get('model')?.toLowerCase();
        const year = params.get('year');
        const wilaya = params.get('wilaya')?.toLowerCase();
        const commune = params.get('commune')?.toLowerCase();
        const category = params.get('category');
        const condition = params.get('condition');
        const price = params.get('price');
        const searchTerm = params.get('search')?.toLowerCase();

        return products.filter(p => {
            if (brand && p.brand.toLowerCase() !== brand) return false;
            if (model && p.model?.toLowerCase() !== model) return false;
            if (year && p.year?.toString() !== year) return false;
            if (wilaya && p.wilaya.toLowerCase() !== wilaya) return false;
            if (commune && p.commune?.toLowerCase() !== commune) return false;
            if (category && p.category !== category) return false;
            if (condition && p.condition !== condition) return false;
            if (price && p.price > Number(price)) return false;
            if (searchTerm && !(p.title.toLowerCase().includes(searchTerm) || p.description?.toLowerCase().includes(searchTerm))) return false;
            return true;
        });
    };

    const displayProducts = (products, container) => {
        if (!container) return;
        container.innerHTML = products.length === 0 ? `<p class="col-span-full text-center py-6 text-gray-500" data-i18n-key="no_listings">Aucune annonce trouvée.</p>` : '';
        products.forEach(item => {
            const isFavorite = userFavorites.includes(item.id);
            const card = document.createElement("article");
            card.className = "bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden flex flex-col group relative transition-shadow hover:shadow-xl";
            card.innerHTML = `
                <div class="absolute top-2 right-2 z-10">
                    <button class="favorite-btn p-2 rounded-full bg-white/70 dark:bg-gray-900/70 text-gray-700 dark:text-gray-300 hover:text-red-500" data-id="${item.id}" aria-label="Add to favorites">
                        <i class="${isFavorite ? 'fas' : 'far'} fa-heart text-xl transition-colors ${isFavorite ? 'text-red-500' : ''}"></i>
                    </button>
                </div>
                ${item.condition === 'new' 
                    ? `<span class="absolute top-2 left-2 bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-green-900 dark:text-green-300" data-i18n-key="new">Neuf</span>`
                    : `<span class="absolute top-2 left-2 bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-yellow-900 dark:text-yellow-300" data-i18n-key="used">Occasion</span>`
                }
                <img src="${item.imageUrl}" alt="${item.title}" class="w-full h-48 object-cover cursor-pointer" loading="lazy" />
                <div class="p-4 flex-1 flex flex-col">
                    <h3 class="font-semibold text-lg mb-1 cursor-pointer">${item.title}</h3>
                    <p class="text-blue-600 dark:text-blue-400 font-bold text-lg mt-auto pt-2">${item.price.toLocaleString()} DA</p>
                </div>
            `;
            card.querySelector('img').addEventListener('click', () => renderView('product-detail', item));
            card.querySelector('h3').addEventListener('click', () => renderView('product-detail', item));
            card.querySelector('.favorite-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(item.id);
            });
            container.appendChild(card);
        });
    };

    const renderProductPage = (product) => {
        // ... implementation
    };

    const renderCartPage = () => {
        // ... implementation
        document.getElementById('clear-cart-btn')?.addEventListener('click', clearCart);
    };
    
    const renderDashboardPage = async () => {
        // ... implementation
    };
    
    const renderProfilePage = async (data) => {
         // ... implementation
    };


    // USER ACTIONS
    const toggleFavorite = async (productId) => {
        if (!currentUser) {
            showMessage(translations[currentLang].login_required, 3000, 'error');
            return;
        }
        const userDocRef = doc(db, 'users', currentUser.uid);
        const newFavorites = userFavorites.includes(productId)
            ? userFavorites.filter(id => id !== productId)
            : [...userFavorites, productId];

        try {
            await setDoc(userDocRef, { favorites: newFavorites }, { merge: true });
            // No need to update local state `userFavorites`, onSnapshot will do it.
            showMessage(translations[currentLang][newFavorites.includes(productId) ? 'favorite_added' : 'favorite_removed'], 2000, 'success');
        } catch (error) {
            console.error("Error updating favorites:", error);
        }
    };
    
    const clearCart = async () => {
        if (!currentUser || Object.keys(userCart).length === 0) return;
        const userDocRef = doc(db, 'users', currentUser.uid);
        try {
            await setDoc(userDocRef, { cart: {} }, { merge: true });
            // `onAuthStateChanged` will update the local cart state
            renderView('cart');
            showMessage("Panier vidé avec succès.", 2000, 'success');
        } catch (error) {
            console.error("Error clearing cart: ", error);
        }
    };

    const addToCart = async (product) => {
        // ... implementation
    };

    // SETUP & INITIALIZATION
    const setupEventListeners = () => {
        // ... all event listeners
        DOMElements.darkModeToggle?.addEventListener('click', () => {
            const isDark = DOMElements.html.classList.contains('dark');
            setDarkMode(!isDark);
        });
        
        DOMElements.postProductBrandSelect?.addEventListener('change', e => {
            const val = e.target.value;
            if (val && car_data[val]) {
                populateSelect(DOMElements.postProductModelSelect, car_data[val], "select_model", currentLang);
                DOMElements.postProductModelSelect.disabled = false;
            } else {
                DOMElements.postProductModelSelect.innerHTML = `<option value="">${translations[currentLang]["select_model"]}</option>`;
                DOMElements.postProductModelSelect.disabled = true;
            }
        });
        
        DOMElements.postProductWilayaSelect?.addEventListener('change', e => {
            const val = e.target.value;
             if (val && wilayas[val]) {
                populateSelect(DOMElements.postProductCommuneSelect, wilayas[val], "select_commune", currentLang);
                DOMElements.postProductCommuneSelect.disabled = false;
            } else {
                DOMElements.postProductCommuneSelect.innerHTML = `<option value="">${translations[currentLang]["select_commune"]}</option>`;
                DOMElements.postProductCommuneSelect.disabled = true;
            }
        });
    };

    const bootApp = () => {
        // Dark mode setup
        const isDarkMode = localStorage.getItem('piecety_dark_mode') === 'true';
        setDarkMode(isDarkMode);

        document.getElementById('current-year').textContent = currentYear;
        translatePage(currentLang);
        setupEventListeners();
        renderView('home');

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript,' +
                'const CACHE_NAME = "piecety-cache-v1";' +
                'const urlsToCache = ["/", "https://cdn.tailwindcss.com", "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"];' +
                'self.addEventListener("install", e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache))));' +
                'self.addEventListener("fetch", e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));'
            ).then(() => console.log('Service worker registered.'))
             .catch(err => console.error('Service worker registration failed:', err));
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                DOMElements.authLinksContainer.innerHTML = `
                    <button id="profile-btn" class="p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none" aria-label="Mon Tableau de Bord">
                        <i class="fas fa-user-circle text-2xl"></i>
                    </button>
                    <button id="signout-btn" class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-full font-semibold transition-colors duration-200 shadow-md">
                        Déconnexion
                    </button>
                `;
                document.getElementById('profile-btn').addEventListener('click', () => renderView('dashboard'));
                document.getElementById('signout-btn').addEventListener('click', () => signOut(auth));
                
                const userDocRef = doc(db, 'users', user.uid);
                onSnapshot(userDocRef, (userDoc) => {
                    if (!userDoc.exists()) {
                        setDoc(userDocRef, {
                            uid: user.uid,
                            displayName: user.displayName,
                            email: user.email,
                            createdAt: new Date(),
                            cart: {},
                            favorites: []
                        });
                    } else {
                        userCart = userDoc.data().cart || {};
                        userFavorites = userDoc.data().favorites || [];
                        updateCartDisplay();
                        if(currentView === 'home') renderListings(); // Re-render to update favorite icons
                    }
                });

            } else {
                DOMElements.authLinksContainer.innerHTML = `
                    <button id="login-btn" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-full font-semibold transition-colors duration-200 shadow-md" data-i18n-key="connect">Se connecter</button>
                `;
                document.getElementById('login-btn').addEventListener('click', () => DOMElements.authModal.classList.remove('invisible', 'opacity-0'));
                userCart = {};
                userFavorites = [];
                updateCartDisplay();
                if(currentView === 'home') renderListings();
            }
            translatePage(currentLang);
        });
    };

    bootApp();
</script>
</body>
</html>
