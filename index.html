<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piecety - Marché des Pièces Auto en Algérie</title>
    <meta name="description" content="Achetez et vendez des pièces automobiles en Algérie avec Piecety, le marché fiable pour les pièces neuves et d'occasion.">
    <meta name="keywords" content="pièces auto, Algérie, marché automobile, Piecety">

    <meta property="og:title" content="Piecety - Marché des Pièces Auto en Algérie">
    <meta property="og:description" content="Trouvez des pièces auto neuves et d'occasion en Algérie sur Piecety.">
    <meta property="og:image" content="./icons/car-512.png">
    <meta property="og:url" content="https://alikhaldi.github.io/Piecetymarket/">
    
    <meta name="twitter:card" content="summary_large_image">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚗</text></svg>">
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <link rel="stylesheet" href="style.css" />
</head>
<body class="flex flex-col min-h-screen text-gray-800 dark:text-gray-200">

<div id="message-box" class="fixed top-5 right-5 z-[1000] p-4 rounded-lg shadow-lg transition-all duration-500 ease-in-out opacity-0 translate-x-full max-w-sm break-words"></div>

<header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50" role="banner">
    <div class="container mx-auto p-4 flex items-center justify-between">
        <a href="#" id="home-link" class="text-xl sm:text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400 logo transition-transform hover:scale-105 flex items-center">
            <svg class="h-8 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.92,7.62A1,1,0,0,0,21,7H18.32a3,3,0,0,0-5.64,0H3a1,1,0,0,0-1,1V17a1,1,0,0,0,1,1H4.2a3,3,0,0,0,5.6,0H16.2a3,3,0,0,0,5.6,0H23a1,1,0,0,0,1-1V8.62A1,1,0,0,0,21.92,7.62ZM6,15a1,1,0,1,1,1-1A1,1,0,0,1,6,15Zm12,0a1,1,0,1,1,1-1A1,1,0,0,1,18,15Z"></path></svg>
            Piecety
        </a>

        <div class="flex-1 mx-2 sm:mx-4 md:mx-8 relative">
            <div class="relative">
                <input id="search-input" type="text" class="w-full p-3 pl-10 rounded-full border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 shadow-inner" data-i18n-placeholder="search_placeholder" aria-label="Search for parts" />
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <div id="search-suggestions" class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-700 rounded-lg shadow-lg z-20 hidden"></div>
        </div>

        <nav class="hidden md:flex items-center space-x-2 lg:space-x-4" role="navigation" aria-label="Main navigation">
             <div class="relative group">
                <button id="lang-dropdown-btn" aria-haspopup="true" aria-expanded="false" class="flex items-center space-x-1 p-3 font-medium text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-200">
                    <span id="current-lang" class="lang-text">FR</span>
                    <i class="fas fa-chevron-down text-xs"></i>
                </button>
                <div id="lang-dropdown" class="absolute right-0 mt-2 w-28 bg-white dark:bg-gray-700 rounded-lg shadow-lg py-1 hidden transition-all duration-300 z-10" role="menu" aria-label="Select Language">
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-600 dark:hover:text-blue-300 lang-btn" data-lang="fr" role="menuitem">Français</button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-600 dark:hover:text-blue-300 lang-btn" data-lang="en" role="menuitem">English</button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-600 dark:hover:text-blue-300 lang-btn" data-lang="ar" role="menuitem">العربية</button>
                </div>
            </div>

            <button id="dark-mode-toggle" class="p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none" aria-label="Toggle Dark Mode">
                <i class="fas fa-moon text-xl"></i>
            </button>
            <a href="#" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 font-medium transition-colors duration-200 px-3 py-2" data-i18n-key="sell" id="sell-link"></a>
            
            <button id="cart-btn" class="relative p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none" aria-label="Shopping Cart">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
            </button>
            
            <div id="auth-links" class="flex items-center space-x-2"></div>
        </nav>

        <button id="mobile-menu-btn" class="md:hidden p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none" aria-label="Open menu" aria-expanded="false" aria-controls="mobile-menu">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>
</header>

<div id="mobile-menu" class="fixed inset-0 bg-white dark:bg-gray-900 z-40 hidden flex-col p-6 space-y-4 md:hidden" role="dialog" aria-modal="true" aria-labelledby="mobile-menu-label">
    <div class="flex justify-between items-center">
        <h2 id="mobile-menu-label" class="text-2xl font-bold text-blue-600 dark:text-blue-400" data-i18n-key="menu"></h2>
        <button id="mobile-menu-close-btn" class="p-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400" aria-label="Close menu">
            <i class="fas fa-times text-2xl"></i>
        </button>
    </div>
    <div id="mobile-nav-links" class="flex flex-col space-y-2"></div>
    <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300" data-i18n-key="language"></h3>
        <div class="flex space-x-4 mt-2">
            <button class="p-2 border dark:border-gray-600 rounded-md text-sm font-medium lang-btn" data-lang="fr">Français</button>
            <button class="p-2 border dark:border-gray-600 rounded-md text-sm font-medium lang-btn" data-lang="en">English</button>
            <button class="p-2 border dark:border-gray-600 rounded-md text-sm font-medium lang-btn" data-lang="ar">العربية</button>
        </div>
    </div>
</div>

<div id="mobile-filters-modal" class="fixed top-0 right-0 h-full w-full max-w-md bg-white dark:bg-gray-900 z-[60] shadow-xl p-6 transform translate-x-full md:hidden">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold" data-i18n-key="filters_title"></h2>
        <button id="mobile-filters-close-btn" class="p-2" aria-label="Close filters">
            <i class="fas fa-times text-2xl"></i>
        </button>
    </div>
    <div id="mobile-filters-content" class="h-[calc(100%-100px)] overflow-y-auto"></div>
    <div class="absolute bottom-0 left-0 w-full p-4 bg-white dark:bg-gray-900 border-t dark:border-gray-700">
        <button id="mobile-apply-filters-btn" class="w-full px-6 py-3 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md" data-i18n-key="apply_filters"></button>
    </div>
</div>


<main id="app-container" class="flex-1 container mx-auto p-4 md:p-8" role="main" aria-live="polite"></main>

<footer class="bg-gray-800 dark:bg-gray-900 text-white p-6 md:p-8 mt-auto text-center pb-24 md:pb-8">
    <div class="flex justify-center space-x-6 mb-4">
        <a href="#" class="text-gray-400 hover:text-white transition" aria-label="Facebook"><i class="fab fa-facebook-f text-xl"></i></a>
        <a href="#" class="text-gray-400 hover:text-white transition" aria-label="Instagram"><i class="fab fa-instagram text-xl"></i></a>
        <a href="#" class="text-gray-400 hover:text-white transition" aria-label="Twitter"><i class="fab fa-twitter text-xl"></i></a>
    </div>
    <p class="text-sm font-light">
        &copy; <span id="current-year"></span> Piecety - Marché des Pièces Auto en Algérie.
    </p>
    <p class="text-xs mt-2 text-gray-400"><a href="#" class="hover:underline">Contact Us</a> | <a href="#" class="hover:underline">Terms of Service</a></p>
</footer>

<nav id="bottom-nav" class="fixed bottom-0 w-full bg-white dark:bg-gray-800 shadow-lg flex justify-around py-2 md:hidden z-50 border-t dark:border-gray-700">
    <a href="#" id="nav-home" class="flex flex-col items-center justify-center text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" aria-label="Home">
        <i class="fas fa-home text-xl"></i>
        <span class="text-xs" data-i18n-key="nav_home"></span>
    </a>
    <a href="#" id="nav-search" class="flex flex-col items-center justify-center text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" aria-label="Search">
        <i class="fas fa-search text-xl"></i>
        <span class="text-xs" data-i18n-key="nav_search"></span>
    </a>
    <a href="#" id="nav-sell" class="flex flex-col items-center justify-center text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" aria-label="Sell">
        <i class="fas fa-plus-circle text-xl"></i>
        <span class="text-xs" data-i18n-key="sell"></span>
    </a>
    <a href="#" id="nav-messages" class="flex flex-col items-center justify-center text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors relative" aria-label="Messages">
        <i class="fas fa-comments text-xl"></i>
        <span class="text-xs" data-i18n-key="messages"></span>
        <span id="nav-unread-badge" class="hidden absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center text-[10px]"></span>
    </a>
    <a href="#" id="nav-profile" class="flex flex-col items-center justify-center text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" aria-label="Profile">
        <i class="fas fa-user-circle text-xl"></i>
        <span class="text-xs" data-i18n-key="nav_profile"></span>
    </a>
</nav>

<div id="post-product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-0 sm:p-4 invisible opacity-0" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="bg-white dark:bg-gray-800 shadow-lg w-full h-full flex flex-col sm:h-auto sm:max-h-[90vh] sm:max-w-2xl sm:rounded-lg">
        <div class="overflow-y-auto p-6 relative">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-600 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 focus:outline-none" aria-label="Close form">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h3 id="modal-title" class="text-2xl font-bold mb-6 text-center" data-i18n-key="submit_ad"></h3>
            <form id="post-product-form" class="space-y-4" novalidate>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="product-title" class="block font-medium mb-1" data-i18n-key="ad_title_label"></label>
                        <input type="text" id="product-title" name="title" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" data-i18n-placeholder="ad_title_placeholder" aria-describedby="title-error" />
                        <p id="title-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="assertive" data-i18n-key="error_valid_title"></p>
                    </div>
                    <div>
                        <label for="product-brand" class="block font-medium mb-1" data-i18n-key="brand_label"></label>
                        <select id="product-brand" name="brand" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="brand-error">
                        </select>
                        <p id="brand-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="assertive" data-i18n-key="error_select_brand"></p>
                    </div>
                    <div>
                        <label for="product-model" class="block font-medium mb-1" data-i18n-key="model_label"></label>
                        <select id="product-model" name="model" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                        </select>
                    </div>
                    <div>
                        <label for="product-year" class="block font-medium mb-1" data-i18n-key="year_label"></label>
                        <select id="product-year" name="year" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="product-wilaya" class="block font-medium mb-1" data-i18n-key="wilaya_label"></label>
                        <select id="product-wilaya" name="wilaya" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="wilaya-error">
                        </select>
                        <p id="wilaya-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="assertive" data-i18n-key="error_select_wilaya"></p>
                    </div>
                    <div>
                        <label for="product-commune" class="block font-medium mb-1" data-i18n-key="commune_label"></label>
                        <select id="product-commune" name="commune" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="product-category" class="block font-medium mb-1" data-i18n-key="category_label"></label>
                        <select id="product-category" name="category" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-describedby="category-error">
                        </select>
                        <p id="category-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="assertive" data-i18n-key="error_select_category"></p>
                    </div>
                    <div>
                        <label for="product-condition" class="block font-medium mb-1" data-i18n-key="condition_label"></label>
                        <select id="product-condition" name="condition" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                    <div>
                        <label for="product-price" class="block font-medium mb-1" data-i18n-key="price_label"></label>
                        <input type="number" id="product-price" name="price" min="0" required class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" data-i18n-placeholder="price_placeholder" aria-describedby="price-error" />
                        <p id="price-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="assertive" data-i18n-key="error_valid_price"></p>
                    </div>
                </div>
                <div>
                    <label for="product-description" class="block font-medium mb-1" data-i18n-key="description_label"></label>
                    <textarea id="product-description" name="description" rows="3" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" data-i18n-placeholder="description_placeholder"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" id="submit-ad-btn" class="mt-4 px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md flex items-center justify-center disabled:bg-blue-400 disabled:cursor-not-allowed">
                        <span class="btn-text" data-i18n-key="submit_ad_btn_text"></span>
                        <svg class="animate-spin ml-3 h-5 w-5 text-white hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="auth-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 invisible opacity-0" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-sm w-full p-6 relative">
        <button id="auth-modal-close-btn" class="absolute top-4 right-4 text-gray-600 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 focus:outline-none" aria-label="Close login form">
            <i class="fas fa-times text-2xl"></i>
        </button>
        <h3 id="auth-modal-title" class="text-2xl font-bold mb-6 text-center" data-i18n-key="connect"></h3>
        <div class="space-y-4">
            <p class="text-center text-gray-600 dark:text-gray-400" data-i18n-key="login_text"></p>
            <button id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-gray-700 dark:text-gray-200 font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200 shadow-sm">
                <i class="fab fa-google text-xl mr-2"></i>
                <span data-i18n-key="google_login"></span>
            </button>
        </div>
    </div>
</div>

<template id="home-view-template">
    <section class="text-center py-12 md:py-20 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg mb-8 md:mb-12">
        <h1 class="text-3xl md:text-5xl font-extrabold mb-4" data-i18n-key="hero_title"></h1>
        <p class="text-lg md:text-xl font-light mb-8 max-w-3xl mx-auto" data-i18n-key="hero_subtitle"></p>
    </section>

    <section class="mb-8 md:mb-12" aria-labelledby="categories-title-heading">
        <div id="breadcrumb-nav" class="mb-4 text-sm text-gray-500 dark:text-gray-400"></div>
        <h2 id="categories-title-heading" class="text-2xl md:text-3xl font-bold mb-6 text-center"></h2>
        <div id="dynamic-grid" class="grid gap-4 md:gap-6"></div>
    </section>
    
    <section id="recently-viewed-section" class="mb-8 md:mb-12 hidden">
        <h2 class="text-2xl md:text-3xl font-bold mb-6" data-i18n-key="recently_viewed"></h2>
        <div id="recently-viewed-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </section>

    <div class="flex flex-col md:flex-row gap-8">
        <aside id="filters-sidebar" class="w-full md:w-1/4 lg:w-1/5 md:block hidden">
             <div id="filters-content" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 space-y-6"></div>
        </aside>

        <section class="w-full md:w-3/4 lg:w-4/5">
             <div class="flex justify-between items-center mb-6">
                <button id="show-filters-btn" class="md:hidden w-full px-6 py-3 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-md font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200 shadow-md" data-i18n-key="show_filters">
                </button>
            </div>
            <div id="listings-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            <div id="load-more-container" class="text-center mt-8"></div>
        </section>
    </div>
</template>

<template id="filters-template">
    <h2 class="text-2xl font-bold mb-4" data-i18n-key="filters_title"></h2>
    <div>
        <label for="brand-filter" class="block text-sm font-medium" data-i18n-key="brand_label"></label>
        <select id="brand-filter" class="filter mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
        </select>
    </div>
    <div id="model-filter-container" class="hidden">
        <label for="model-filter" class="block text-sm font-medium" data-i18n-key="model_label"></label>
        <select id="model-filter" class="filter mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
        </select>
    </div>
    <div>
        <label for="year-filter" class="block text-sm font-medium" data-i18n-key="year_label"></label>
        <select id="year-filter" class="filter mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
        </select>
    </div>
    <div>
        <label for="wilaya-filter" class="block text-sm font-medium" data-i18n-key="wilaya_label"></label>
        <select id="wilaya-filter" class="filter mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
        </select>
    </div>
    <div id="commune-filter-container" class="hidden">
        <label for="commune-filter" class="block text-sm font-medium" data-i18n-key="commune_label"></label>
        <select id="commune-filter" class="filter mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
        </select>
    </div>
    <div>
        <label for="category-filter" class="block text-sm font-medium" data-i18n-key="category_label"></label>
        <select id="category-filter" class="filter mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
        </select>
    </div>
    <div>
        <label for="condition-filter" class="block text-sm font-medium" data-i18n-key="condition_label"></label>
        <select id="condition-filter" class="filter mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm rounded-md shadow-sm">
        </select>
    </div>
    <div>
        <label for="price-range-filter" class="block text-sm font-medium" data-i18n-key="price_range"></label>
        <input type="range" id="price-range-filter" min="0" max="100000" step="1000" class="filter w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
            <span>0 DA</span>
            <span id="price-range-value">50000 DA</span>
            <span>100k+ DA</span>
        </div>
    </div>

    <div class="mt-6 flex flex-col space-y-4">
        <button id="filter-reset-btn" class="w-full px-6 py-3 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-md font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors duration-200 shadow-md" data-i18n-key="reset"></button>
    </div>
</template>

<template id="product-detail-view-template">
    <div id="product-detail" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 md:p-8">
        <button id="back-to-listings-btn" class="mb-4 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_listings"></span>
        </button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <img id="product-image-detail" src="" alt="" class="w-full h-80 md:h-96 object-cover rounded-lg shadow-md" />
            <div>
                <h2 id="product-title-detail" class="text-2xl md:text-3xl font-bold mb-2"></h2>
                <p id="product-price-detail" class="text-blue-600 dark:text-blue-400 font-bold text-2xl mb-4"></p>
                <div class="space-y-2 text-sm mb-6 border-t border-b dark:border-gray-700 py-4">
                    <p><strong><span data-i18n-key="brand_label"></span>:</strong> <span id="product-brand-detail"></span></p>
                    <p><strong><span data-i18n-key="model_label"></span>:</strong> <span id="product-model-detail"></span></p>
                    <p><strong><span data-i18n-key="year_label"></span>:</strong> <span id="product-year-detail"></span></p>
                    <p><strong><span data-i18n-key="wilaya_label"></span>:</strong> <span id="product-wilaya-detail"></span></p>
                    <p><strong><span data-i18n-key="commune_label"></span>:</strong> <span id="product-commune-detail"></span></p>
                    <p><strong data-i18n-key="sold_by"></strong> <a href="#" id="seller-profile-link" class="text-blue-600 dark:text-blue-400 hover:underline"></a></p>
                </div>
                <p id="product-description-detail" class="leading-relaxed mb-6"></p>
                <div class="flex flex-col space-y-4">
                     <button id="add-to-cart-btn" class="w-full px-6 py-3 bg-green-600 text-white rounded-full font-semibold hover:bg-green-700 transition-colors duration-200 shadow-md flex items-center justify-center">
                        <i class="fas fa-cart-plus mr-2"></i>
                        <span data-i18n-key="add_to_cart"></span>
                    </button>
                    <button id="contact-seller-btn" class="w-full px-6 py-3 bg-gray-600 text-white rounded-full font-semibold hover:bg-gray-700 transition-colors duration-200 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">
                        <i class="fas fa-comments mr-2"></i>
                        <span data-i18n-key="contact_seller"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="cart-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <button id="back-from-cart-btn" class="mb-4 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-semibold flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span data-i18n-key="back_to_listings"></span>
        </button>
        <div class="flex justify-between items-center mb-6">
             <h2 class="text-2xl md:text-3xl font-bold" data-i18n-key="cart_title"></h2>
             <button id="clear-cart-btn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md font-semibold hover:bg-red-700 transition-colors duration-200 shadow-md" data-i18n-key="clear_cart">
            </button>
        </div>
        <div id="cart-items-container" class="space-y-4"></div>
        <div id="cart-summary" class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
            <p class="text-xl font-bold flex justify-between">
                <span data-i18n-key="cart_total"></span>:
                <span id="cart-total-price">0 DA</span>
            </p>
            <button id="checkout-btn" class="w-full mt-4 px-6 py-3 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition-colors duration-200 shadow-md">
                <span data-i18n-key="checkout_btn"></span>
            </button>
        </div>
    </div>
</template>

<template id="dashboard-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl md:text-3xl font-bold mb-6" data-i18n-key="dashboard"></h2>
        <div id="dashboard-content">
            <h3 class="text-xl font-semibold mb-4 border-b dark:border-gray-700 pb-2" data-i18n-key="my_listings"></h3>
            <div id="my-listings-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
    </div>
</template>

<template id="profile-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <div class="flex flex-col md:flex-row items-center md:items-start text-center md:text-left">
            <i class="fas fa-user-circle text-6xl md:text-8xl text-gray-300 md:mr-6 mb-4 md:mb-0"></i>
            <div>
                <h2 id="profile-name" class="text-2xl md:text-3xl font-bold"></h2>
                <div id="profile-rating" class="flex items-center justify-center md:justify-start text-yellow-500 mt-2">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i>
                    <span class="text-gray-600 dark:text-gray-400 ml-2 text-sm" data-i18n-key="reviews_soon"></span>
                </div>
            </div>
        </div>
        
        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-4 border-b dark:border-gray-700 pb-2" data-i18n-key="seller_listings"></h3>
            <div id="user-products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
        
        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-4 border-b dark:border-gray-700 pb-2" data-i18n-key="buyer_reviews"></h3>
            <div id="user-reviews-list" class="space-y-4">
                <p class="text-gray-500 dark:text-gray-400" data-i18n-key="reviews_soon_2"></p>
            </div>
        </div>
    </div>
</template>

<template id="inbox-view-template">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl md:text-3xl font-bold mb-6" data-i18n-key="messages"></h2>
        <div id="conversations-list" class="space-y-4">
            <p id="inbox-loading" class="text-center text-gray-500" data-i18n-key="loading_convos"></p>
        </div>
    </div>
</template>

<template id="chat-view-template">
    <div class="bg-white dark:bg-gray-800 shadow-lg h-full w-full flex flex-col sm:h-auto sm:max-h-[85vh] sm:max-w-2xl sm:rounded-lg">
        <div class="flex items-center border-b dark:border-gray-700 p-4 mb-4 flex-shrink-0">
            <button id="back-to-inbox-btn" class="mr-4 text-blue-600 dark:text-blue-400" aria-label="Back to Inbox">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 id="chat-with-name" class="text-xl font-bold"></h2>
        </div>
        
        <div id="messages-container" class="flex-1 overflow-y-auto space-y-4 p-2 flex flex-col">
            </div>

        <form id="send-message-form" class="mt-4 flex gap-4 border-t dark:border-gray-700 p-4 flex-shrink-0">
            <input type="text" id="message-input" class="flex-1 p-3 rounded-full border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" required data-i18n-placeholder="type_message_placeholder">
            <button type="submit" class="bg-blue-600 text-white rounded-full w-12 h-12 flex-shrink-0 flex items-center justify-center" aria-label="Send Message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</template>


<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, where, getDocs, doc, setDoc, getDoc, deleteDoc, updateDoc, increment, writeBatch, serverTimestamp, orderBy, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    // Global state variables
    let currentUser = null;
    let currentLang = localStorage.getItem("piecety_lang") || "fr";
    let currentView = 'home';
    let userCart = {};
    let productsUnsubscribe = null;
    let chatsUnsubscribe = null;
    let lastVisibleProduct = null;
    let isFetching = false;
    let allProductsCache = []; // For search autocomplete
    let recentlyViewed = JSON.parse(localStorage.getItem('piecety_recently_viewed')) || [];

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBIptEskV2soajxRYPDfwYFYyz9pWQvZL0",
        authDomain: "piecety-app-b39c4.firebaseapp.com",
        projectId: "piecety-app-b39c4",
        storageBucket: "piecety-app-b39c4.appspot.com",
        messagingSenderId: "265795860915",
        appId: "1:265795860915:web:aa10241788cce42f6373c6"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Translations
    const translations = {
        fr: {
            page_title: "Piecety - Marché des Pièces Auto en Algérie",
            meta_description: "Achetez et vendez des pièces automobiles en Algérie avec Piecety, le marché fiable pour les pièces neuves et d'occasion.",
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "Menu", sell: "Vendre", connect: "Se connecter", language: "Langue", logout: "Déconnexion", dashboard: "Tableau de Bord",
            nav_home: "Accueil", nav_search: "Recherche", nav_profile: "Profil",
            hero_title: "Trouvez la bonne pièce pour votre voiture",
            hero_subtitle: "Le marché algérien des pièces automobiles le plus fiable.",
            categories_title: "Catégories de Pièces",
            brands_title: "Sélectionnez une Marque",
            years_title: "Sélectionnez une Année",
            filters_title: "Filtrer les annonces", all_brands: "Toutes les marques", all_models: "Tous les modèles",
            all_years: "Toutes années", all_wilayas: "Toutes wilayas", all_communes: "Toutes communes",
            condition: "État", any_condition: "Tout", new: "Neuf", used: "Occasion",
            apply_filters: "Appliquer les filtres", reset: "Réinitialiser",
            search_placeholder: "Rechercher une pièce...",
            submit_ad: "Soumettre une annonce", ad_title_label: "Titre de la pièce *", ad_title_placeholder: "Ex: Disque de frein avant",
            brand_label: "Marque *", select_brand: "Sélectionnez une marque",
            model_label: "Modèle", select_model: "Sélectionnez un modèle",
            year_label: "Année", select_year: "Sélectionnez une année",
            wilaya_label: "Wilaya *", select_wilaya: "Sélectionnez une wilaya",
            commune_label: "Commune", select_commune: "Sélectionnez une commune",
            condition_label: "État", price_label: "Prix (DA) *", price_placeholder: "Ex: 15000",
            description_label: "Description", description_placeholder: "Informations supplémentaires...",
            submit_ad_btn_text: "Soumettre", loading_text: "Envoi...",
            error_valid_title: "Veuillez entrer un titre valide.", error_select_brand: "Veuillez sélectionner une marque.",
            error_select_wilaya: "Veuillez sélectionner une wilaya.", error_select_category: "Veuillez sélectionner une catégorie.",
            error_valid_price: "Veuillez entrer un prix valide.",
            login_text: "Connectez-vous pour accéder à toutes les fonctionnalités.", google_login: "Se connecter avec Google",
            back_to_listings: "Retour aux annonces", add_to_cart: "Ajouter au panier",
            cart_title: "Mon panier", cart_total: "Total", checkout_btn: "Passer à la caisse",
            no_listings: "Aucune annonce trouvée.",
            your_cart_is_empty: "Votre panier est vide.",
            remove: "Supprimer", quantity: "Quantité", item_total: "Total de l'article",
            login_required: "Veuillez vous connecter pour utiliser cette fonctionnalité.",
            show_filters: "Afficher les filtres", price_range: "Gamme de prix", all_categories: "Toutes catégories",
            category_label: "Catégorie *", select_category: "Sélectionnez une catégorie", contact_seller: "Contacter le vendeur",
            clear_cart: "Vider le panier", ad_posted: "Votre annonce a été publiée avec succès !", ad_post_failed: "Échec de la publication de l'annonce.",
            item_added_to_cart: "Article ajouté au panier!", delete_ad_confirm: "Êtes-vous sûr de vouloir supprimer cette annonce ?",
            sold_by: "Vendu par:", my_listings: "Mes Annonces", seller_listings: "Annonces de ce vendeur",
            buyer_reviews: "Avis des acheteurs", reviews_soon: "(Avis bientôt disponibles)", reviews_soon_2: "La fonctionnalité d'avis sera bientôt disponible.",
            messages: "Messages", loading_convos: "Chargement des conversations...", chat_with: "Chat avec", type_message_placeholder: "Écrire un message...",
            recently_viewed: "Récemment consultés", chat: "Chat"
        },
        en: {
            page_title: "Piecety - Car Parts Marketplace in Algeria",
            meta_description: "Buy and sell car parts in Algeria with Piecety, the reliable marketplace for new and used parts.",
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "Menu", sell: "Sell", connect: "Log In", language: "Language", logout: "Logout", dashboard: "Dashboard",
            nav_home: "Home", nav_search: "Search", nav_profile: "Profile",
            hero_title: "Find the right car part for your vehicle",
            hero_subtitle: "The most trusted Algerian car parts marketplace.",
            categories_title: "Parts Categories",
            brands_title: "Select a Brand",
            years_title: "Select a Year",
            filters_title: "Filter Listings", all_brands: "All brands", all_models: "All models",
            all_years: "All years", all_wilayas: "All wilayas", all_communes: "All communes",
            condition: "Condition", any_condition: "Any", new: "New", used: "Used",
            apply_filters: "Apply Filters", reset: "Reset",
            search_placeholder: "Search for a part...",
            submit_ad: "Submit an Ad", ad_title_label: "Part Title *", ad_title_placeholder: "e.g., Front brake disc",
            brand_label: "Brand *", select_brand: "Select a brand",
            model_label: "Model", select_model: "Select a model",
            year_label: "Year", select_year: "Select a year",
            wilaya_label: "State *", select_wilaya: "Select a state",
            commune_label: "City", select_commune: "Select a city",
            condition_label: "Condition", price_label: "Price (DA) *", price_placeholder: "e.g., 15000",
            description_label: "Description", description_placeholder: "Additional information...",
            submit_ad_btn_text: "Submit", loading_text: "Submitting...",
            error_valid_title: "Please enter a valid title.", error_select_brand: "Please select a brand.",
            error_select_wilaya: "Please select a state.", error_select_category: "Please select a category.",
            error_valid_price: "Please enter a valid price.",
            login_text: "Log in to access all features.", google_login: "Sign in with Google",
            back_to_listings: "Back to listings", add_to_cart: "Add to cart",
            cart_title: "My Cart", cart_total: "Total", checkout_btn: "Proceed to Checkout",
            no_listings: "No listings found.",
            your_cart_is_empty: "Your cart is empty.",
            remove: "Remove", quantity: "Quantity", item_total: "Item Total",
            login_required: "Please log in to use this feature.",
            show_filters: "Show Filters", price_range: "Price Range", all_categories: "All Categories",
            category_label: "Category *", select_category: "Select a category", contact_seller: "Contact Seller",
            clear_cart: "Clear Cart", ad_posted: "Your ad has been posted successfully!", ad_post_failed: "Failed to post ad.",
            item_added_to_cart: "Item added to cart!", delete_ad_confirm: "Are you sure you want to delete this ad?",
            sold_by: "Sold by:", my_listings: "My Listings", seller_listings: "Listings from this seller",
            buyer_reviews: "Buyer Reviews", reviews_soon: "(Reviews coming soon)", reviews_soon_2: "Review functionality will be available soon.",
            messages: "Messages", loading_convos: "Loading conversations...", chat_with: "Chat with", type_message_placeholder: "Type a message...",
            recently_viewed: "Recently Viewed", chat: "Chat"
        },
        ar: {
            page_title: "Piecety - سوق قطع غيار السيارات في الجزائر",
            meta_description: "بيع وشراء قطع غيار السيارات في الجزائر مع Piecety، السوق الموثوق للقطع الجديدة والمستعملة.",
            fr_short: "FR", en_short: "EN", ar_short: "AR",
            menu: "القائمة", sell: "بيع", connect: "تسجيل الدخول", language: "اللغة", logout: "تسجيل الخروج", dashboard: "لوحة التحكم",
            nav_home: "الرئيسية", nav_search: "بحث", nav_profile: "ملفي",
            hero_title: "ابحث عن قطعة الغيار المناسبة لسيارتك",
            hero_subtitle: "أكثر أسواق قطع غيار السيارات ثقة في الجزائر.",
            categories_title: "فئات القطع",
            brands_title: "اختر ماركة",
            years_title: "اختر سنة",
            filters_title: "تصفية الإعلانات", all_brands: "جميع الماركات", all_models: "جميع الموديلات",
            all_years: "جميع السنوات", all_wilayas: "جميع الولايات", all_communes: "جميع البلديات",
            condition: "الحالة", any_condition: "الكل", new: "جديد", used: "مستعمل",
            apply_filters: "تطبيق الفلاتر", reset: "إعادة تعيين",
            search_placeholder: "ابحث عن قطعة...",
            submit_ad: "إرسال إعلان", ad_title_label: "عنوان القطعة *", ad_title_placeholder: "مثال: قرص فرامل أمامي",
            brand_label: "الماركة *", select_brand: "اختر ماركة",
            model_label: "الموديل", select_model: "اختر موديل",
            year_label: "السنة", select_year: "اختر سنة",
            wilaya_label: "الولاية *", select_wilaya: "اختر ولاية",
            commune_label: "البلدية", select_commune: "اختر بلدية",
            condition_label: "الحالة", price_label: "السعر (دج) *", price_placeholder: "مثال: 15000",
            description_label: "الوصف", description_placeholder: "معلومات إضافية...",
            submit_ad_btn_text: "إرسال", loading_text: "جار الإرسال...",
            error_valid_title: "الرجاء إدخال عنوان صالح.", error_select_brand: "الرجاء اختيار ماركة.",
            error_select_wilaya: "الرجاء اختيار ولاية.", error_select_category: "الرجاء اختيار فئة.",
            error_valid_price: "الرجاء إدخال سعر صالح.",
            login_text: "تسجيل الدخول للوصول إلى جميع الميزات.", google_login: "تسجيل الدخول باستخدام Google",
            back_to_listings: "العودة إلى الإعلانات", add_to_cart: "أضف إلى السلة",
            cart_title: "سلة التسوق", cart_total: "الإجمالي", checkout_btn: "الدفع",
            no_listings: "لم يتم العثور على إعلانات.",
            your_cart_is_empty: "سلة التسوق فارغة.",
            remove: "حذف", quantity: "الكمية", item_total: "إجمالي السلعة",
            login_required: "يرجى تسجيل الدخول لاستخدام هذه الميزة.",
            show_filters: "إظهار الفلاتر", price_range: "نطاق السعر", all_categories: "جميع الفئات",
            category_label: "الفئة *", select_category: "اختر فئة", contact_seller: "اتصل بالبائع",
            clear_cart: "إفراغ السلة", ad_posted: "تم نشر إعلانك بنجاح!", ad_post_failed: "فشل نشر الإعلان.",
            item_added_to_cart: "تمت إضافة المنتج إلى السلة!", delete_ad_confirm: "هل أنت متأكد من أنك تريد حذف هذا الإعلان؟",
            sold_by: "البائع:", my_listings: "إعلاناتي", seller_listings: "إعلانات من هذا البائع",
            buyer_reviews: "تقييمات المشترين", reviews_soon: "(التقييمات قريبا)", reviews_soon_2: "ميزة التقييم ستكون متاحة قريبا.",
            messages: "الرسائل", loading_convos: "جاري تحميل المحادثات...", chat_with: "محادثة مع", type_message_placeholder: "اكتب رسالة...",
            recently_viewed: "شوهدت مؤخرا", chat: "محادثة"
        }
    };

    // Data for dynamic dropdowns
    const categories = {
        "engine": { fr: "Moteur", en: "Engine", ar: "محرك", icon: "fa-cogs" },
        "brakes": { fr: "Freins", en: "Brakes", ar: "مكابح", icon: "fa-car" },
        "fuel_system": { fr: "Système de carburant", en: "Fuel System", ar: "نظام الوقود", icon: "fa-gas-pump" },
        "cooling": { fr: "Refroidissement", en: "Cooling", ar: "التبريد", icon: "fa-fan" },
        "tires": { fr: "Pneus & Jantes", en: "Tires & Rims", ar: "الإطارات والعجلات", icon: "fa-circle" },
        "electrical": { fr: "Électrique", en: "Electrical", ar: "كهربائي", icon: "fa-bolt" },
        "body": { fr: "Carrosserie", en: "Body", ar: "هيكل", icon: "fa-car-side" },
        "tools": { fr: "Outillage", en: "Tools", ar: "أدوات", icon: "fa-wrench" },
    };
    const wilayas = {
        "Adrar": ["Adrar", "Charouine", "Tamest", "Reggane", "Aoulef", "Fenoughil", "Timimoun", "Talmine", "Bordj Badji Mokhtar", "In Salah"], 
        "Chlef": ["Chlef", "Ténès", "Ouled Farès", "El Marsa", "Abou El Hassan", "Oued Fodda", "Beni Haoua", "El Karimia", "Taougrite", "Harchoun"], 
        "Laghouat": ["Aïn Madhi", "Aflou", "El Ghicha", "El Houaita", "El Assafia", "Ksar El Hirane", "Laghouat", "Taougrite", "Sidi Makhlouf", "Ouled Farès", "Hassi R'Mel"], 
        "Oum El Bouaghi": ["Aïn Beïda", "Aïn Fekroun", "Aïn Babouche", "Aïn M'lila", "Dhalaâ", "F'kirina", "Oum El Bouaghi", "Sidi R'ghiss", "Souk Naamane", "El Fedjoudj"], 
        "Batna": ["Aïn Touta", "Arris", "Barika", "Batna", "El Madher", "Menaa", "Merouana", "Ras El Aioun", "Timgad", "Ouled Si Slimane"], 
        "Béjaïa": ["Aïn El Kebira", "Akbou", "Béjaïa", "El Kseur", "Sidi Aïch", "Tichy", "Toudja", "Aokas", "Ighil Ali", "Darguina"], 
        "Biskra": ["Biskra", "El Kantara", "Sidi Okba", "Ourlal", "Zeribet El Oued", "Tolga", "Sidi Khaled", "Djemorah", "M'chouneche", "El Outaya"], 
        "Béchar": ["Béchar", "Abadla", "Beni Ounif", "Lahmar", "Tabelbala", "Kenadsa", "Igli", "Taghit", "Mechraâ Houari Boumediene", "Ouled Khoudir"], 
        "Blida": ["Blida", "Boufarik", "Chebli", "Oued El Alleug", "Larbaâ", "Meftah", "Soumaâ", "Bougara", "Mouzaia", "Chréa"], 
        "Bouira": ["Bouira", "Lakhdaria", "Sour El Ghozlane", "Ahnif", "Bir Ghbalou", "Haïzer", "M'chedallah", "El Hachimia", "Sidi Aïssa", "Taghzout"], 
        "Tamanrasset": ["Tamanrasset", "Abalessa", "Idles", "In Amguel", "Tazrouk", "Tin Zaouatine", "In Guezzam", "Djanet", "Bordj Omar Driss", "Illizi"], 
        "Tébessa": ["Tébessa", "Bir El Ater", "Cheria", "El Aouinet", "El Kouif", "El Ma Labiod", "Morsott", "Ouenza", "Bir Mokkadem", "Hammamet"], 
        "Tlemcen": ["Tlemcen", "Ghazaouet", "Maghnia", "Remchi", "Sebdou", "Sidi Djillali", "Hennaya", "Nedroma", "Marsa Ben M'Hidi", "Beni Snous"], 
        "Tiaret": ["Tiaret", "Aïn Deheb", "Frenda", "Ksar Chellala", "Mahdia", "Rahouia", "Sougueur", "Dahmouni", "Sidi Ali Mellal", "Medroussa"], 
        "Tizi Ouzou": ["Tizi Ouzou", "Aïn El Hammam", "Azazga", "Bouzeguène", "Draâ Ben Khedda", "Ouacif", "Larbaâ Nath Irathen", "Tigzirt", "Tizi Gheniff", "Maâtkas"], 
        "Alger": ["Alger", "Bab El Oued", "Baraki", "Bir Mourad Raïs", "Birkhadem", "Bologhine", "Bordj El Kiffan", "Hussein Dey", "Hydra", "Dar El Beïda"], 
        "Djelfa": ["Djelfa", "Aïn Oussera", "Messaad", "Hassi Bahbah", "Had Sahary", "Guettara", "El Idrissia", "Dar Chioukh", "Zaccar", "Faidh El Botma"], 
        "Jijel": ["Jijel", "Taher", "El Milia", "Chekfa", "Ziamamansouria", "Texenna", "Djemaa Beni Habibi", "Sidi Maarouf", "Settara", "Kaous"], 
        "Sétif": ["Sétif", "Aïn Oulmane", "El Eulma", "Bousselam", "Beni Ouartilane", "Bougaâ", "Salah Bey", "Hammamlou", "Guenzet", "Maouaklane"], 
        "Saïda": ["Saïda", "Aïn El Hadjar", "Sidi Boubkeur", "Youb", "El Hassasna", "Tircine", "Maamora", "Ouled Brahim", "Aïn Sekhouna", "Moulay Larbi"], 
        "Skikda": ["Skikda", "Aïn Bouziane", "Azzaba", "El Harrouch", "Collo", "Filfila", "Ramdane Djamel", "Salah Bouchaour", "Zerdaza", "Beni Oulbane"], 
        "Sidi Bel Abbès": ["Sidi Bel Abbès", "Sfisef", "Telagh", "Ras El Ma", "Tessala", "Aïn El Berd", "Boukhanafis", "Ben Badis", "Sidi Chaib", "Moulay Slissen"], 
        "Annaba": ["Annaba", "El Hadjar", "Berrahal", "El Bouni", "Seraïdi", "Chetaïbi", "Oued El Aneb", "Aïn El Berda", "Trézel", "Sidi Amar"], 
        "Guelma": ["Guelma", "Héliopolis", "Oued Zenati", "Bouchegouf", "Ain Reggada", "Tamlouka", "Dkhila", "Bou Hachana", "Belkheir", "Bordj Sabath"], 
        "Constantine": ["Constantine", "El Khroub", "Hamma Bouziane", "Aïn Smara", "Didouche Mourad", "Zighoud Youcef", "Messaoud Boudjriou", "Beni Hamidane", "Ibn Ziad", "Oued El Hadjar"], 
        "Médéa": ["Médéa", "Berrouaghia", "Chahbounia", "Tablat", "Aïn Boucif", "Beni Slimane", "El Azizia", "Si Mahdjoub", "Ouzera", "Ksar Boukhari"], 
        "Mostaganem": ["Mostaganem", "Hassi Mameche", "Aïn Tédelès", "Sidi Ali", "Bouguirat", "Achaacha", "Khadra", "Oued El Kheir", "Mazagran", "Foran"], 
        "M'Sila": ["M'Sila", "Bou Saâda", "Aïn El Melh", "Sidi Aïssa", "Magra", "M'Cif", "Hammam Dhalaâ", "Ouled Derradj", "Ben Srour", "Ouanougha"], 
        "Mascara": ["Mascara", "Ghriss", "Tighennif", "Sig", "Bou Hanifia", "Oued Taria", "Hachem", "Mohammadia", "El Bordj", "Aïn Fares"], 
        "Ouargla": ["Ouargla", "Hassi Messaoud", "Rouissat", "N'Goussa", "Sidi Khouiled", "Blidet Amor", "El Borma", "Tebesbest", "Zaouia El Abidia", "Hassi Ben Abdallah"], 
        "Oran": ["Oran", "Arzew", "Bir El Djir", "Es Senia", "Boutlélis", "Hassi Bounif", "Oued Tlélat", "Sidi Chami", "Gdyel", "Aïn El Turk"], 
        "El Bayadh": ["El Bayadh", "Bougtob", "Chellala", "Breïna", "Rogassa", "Brezina", "Boussemghoun", "El Kheiter", "Kraïr", "Ghassoul"], 
        "Illizi": ["Illizi", "Djanet", "Bordj El Houasse", "Tamanrasset", "In Salah", "Abalessa", "Tazrouk", "Idles", "In Amguel", "Tin Zaouatine"], 
        "Bordj Bou Arréridj": ["Bordj Bou Arréridj", "Ras El Oued", "Mansoura", "Tassameurt", "El Achir", "Medjana", "Bordj Ghedir", "Hammam El Biban", "L'Hassaneia", "Ghassira"], 
        "Boumerdès": ["Boumerdès", "Dellys", "Boudouaou", "Isser", "Béni Amrane", "Naciria", "Corso", "Zemmouri", "Réghaïa", "Tidjelabine"], 
        "El Tarf": ["El Tarf", "Ben M'Hidi", "Besbes", "Drea", "El Kala", "Bougous", "Raml Souk", "Sidi Khelil", "Oued Zitoun", "Aïn Kerma"], 
        "Tindouf": ["Tindouf", "Oum El Assel"], "Tissemsilt": ["Tissemsilt", "Bordj Bounaama", "Lardjem", "Théniet El Had", "Ammi Moussa", "Sidi Boutouchent", "Layoune", "Lazharia", "Bougara", "Bordj Emir Khaled"], 
        "El Oued": ["El Oued", "Guemar", "Hassi Khalifa", "Robbah", "Debila", "Bayadha", "Magrane", "Nakhla", "Kouinine", "El Ogla"], 
        "Khenchela": ["Khenchela", "Aïn Touila", "Bab El Ain", "Kais", "Yabous", "Chechar", "M'Sara", "Ouled Rechache", "Taouzianat", "Remila"], 
        "Souk Ahras": ["Souk Ahras", "Heddada", "M'daourouch", "Mechrouha", "Ouled Driss", "Taoura", "Zaarouria", "Ouillen", "Sidi Fredj", "Tiffech"], 
        "Tipaza": ["Tipaza", "Cherchell", "Koléa", "Fouka", "Hadjout", "Sidi Rached", "Menaceur", "Bou Ismaïl", "Khemis Miliana", "Aïn Tagourait"], 
        "Mila": ["Mila", "Bouhatem", "Ferdjioua", "Grarem Gouga", "Tadjenanet", "Sidi Merouane", "Oued Endja", "Teleghma", "Chigara", "Rouached"], 
        "Aïn Defla": ["Aïn Defla", "Khemis Miliana", "El Attaf", "Aïn Torki", "Djelida", "Rouina", "Hammam Righa", "Miliana", "Boumedfaa", "Aïn Soltane"], 
        "Naâma": ["Naâma", "Mécheria", "Aïn Sefra", "Moghrar", "Tiout", "Sfissifa", "Makman Ben Amer", "Asla", "Kasdir", "El Biod"], 
        "Aïn Témouchent": ["Aïn Témouchent", "Hammam Bou Hadjar", "El Malah", "Béni Saf", "Aghlal", "Chaabat El Ham", "Oued Berkeche", "Aoubellil", "Bouzedjar", "Tamesna"], 
        "Ghardaïa": ["Ghardaïa", "El Guerrara", "Berriane", "Dhayet Bendhahoua", "Metlili", "Zelfana", "Bounoura", "El Atteuf", "Guerrara", "Dra' El Mizan"], 
        "Relizane": ["Relizane", "Oued Rhiou", "Zemmoura", "Sidi M'Hamed Ben Ali", "El H'madna", "Ammi Moussa", "Mazouna", "Mendes", "Ain Tarek", "Oued El Djemaa"], 
        "El M'ghair": ["El M'ghair", "Sidi Amrane", "Djamaa", "Oum Toub", "M'Rara", "Oued Allenda", "Sidi Khelil", "Oued R'hiou", "Sidi Yahia", "Bouchakroun"], 
        "El Meniaa": ["El Meniaa", "Hassi Gara", "Mansourah", "Dhiafat", "El Guerrara", "Tadjmout", "El Hachane", "El Oued", "Chabet El Ami", "Ouled Gacem"]
    };
    const car_data = {
        "Toyota": ["Yaris", "Corolla", "Camry", "Land Cruiser", "Hilux"], "Peugeot": ["208", "308", "301", "2008", "3008", "508"], "Volkswagen": ["Golf", "Polo", "Passat", "Tiguan", "Touareg", "Jetta"], "Renault": ["Clio", "Megane", "Captur", "Duster", "Symbol"], "Hyundai": ["i10", "i20", "Accent", "Tucson", "Santa Fe"], "Nissan": ["Micra", "Sentra", "Qashqai", "X-Trail", "Juke"], "Fiat": ["Panda", "500", "Tipo", "Punto"], "Citroën": ["C3", "C4", "Berlingo", "C-Elysée"], "Kia": ["Picanto", "Rio", "Sportage", "Sorento"], "Mercedes-Benz": ["A-Class", "C-Class", "E-Class", "GLA", "GLC"]
    };
     const brand_icons = {
        "Toyota": "icons/toyota.png",
        "Peugeot": "icons/peugeot.png",
        "Volkswagen": "icons/volkswagen.png",
        "Renault": "icons/renault.png",
        "Hyundai": "icons/hyundai.png",
        "Nissan": "icons/nissan.png",
        "Fiat": "icons/fiat.png",
        "Citroën": "icons/citroen.png",
        "Kia": "icons/kia.png",
        "Mercedes-Benz": "icons/mercedes.png"
    };
    const currentYear = new Date().getFullYear();
    const years = Array.from({length: currentYear - 1979}, (_, i) => (currentYear - i).toString());

    // DOM Elements
    const DOMElements = {
        html: document.documentElement,
        body: document.body,
        appContainer: document.getElementById("app-container"),
        messageBox: document.getElementById("message-box"),
        langDropdownBtn: document.getElementById("lang-dropdown-btn"),
        langDropdown: document.getElementById("lang-dropdown"),
        currentLangSpan: document.getElementById("current-lang"),
        langBtns: document.querySelectorAll(".lang-btn"),
        searchInput: document.getElementById("search-input"),
        postProductModal: document.getElementById("post-product-modal"),
        modalCloseBtn: document.getElementById("modal-close-btn"),
        postProductForm: document.getElementById("post-product-form"),
        mobileMenuBtn: document.getElementById("mobile-menu-btn"),
        mobileMenu: document.getElementById("mobile-menu"),
        mobileMenuCloseBtn: document.getElementById("mobile-menu-close-btn"),
        mobileNavLinks: document.getElementById("mobile-nav-links"),
        mobileFiltersModal: document.getElementById("mobile-filters-modal"),
        mobileFiltersContent: document.getElementById("mobile-filters-content"),
        mobileFiltersCloseBtn: document.getElementById("mobile-filters-close-btn"),
        mobileApplyFiltersBtn: document.getElementById("mobile-apply-filters-btn"),
        authModal: document.getElementById("auth-modal"),
        authModalCloseBtn: document.getElementById("auth-modal-close-btn"),
        googleLoginBtn: document.getElementById("google-login-btn"),
        cartBtn: document.getElementById("cart-btn"),
        cartCountSpan: document.getElementById("cart-count"),
        authLinksContainer: document.getElementById("auth-links"),
        homeLink: document.getElementById("home-link"),
        sellLink: document.getElementById("sell-link"),
        darkModeToggle: document.getElementById('dark-mode-toggle'),
        postProductBrandSelect: document.getElementById('product-brand'),
        postProductModelSelect: document.getElementById('product-model'),
        postProductYearSelect: document.getElementById('product-year'),
        postProductWilayaSelect: document.getElementById('product-wilaya'),
        postProductCommuneSelect: document.getElementById('product-commune'),
        postProductCategorySelect: document.getElementById('product-category'),
    };
    
    // UTILITY FUNCTIONS
    const showMessage = (msgKey, duration = 3500, type = "info") => {
        const msg = translations[currentLang][msgKey] || msgKey;
        const { messageBox } = DOMElements;
        if (!messageBox) return;
        messageBox.textContent = msg;
        messageBox.className = `fixed top-5 right-5 z-[1000] p-4 rounded-lg shadow-lg transition-all duration-500 ease-in-out max-w-sm break-words`;
        
        let colors = '';
        if (type === 'success') {
            colors = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        } else if (type === 'error') {
            colors = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        } else {
            colors = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
        }
        messageBox.classList.add(...colors.split(' '));

        requestAnimationFrame(() => {
            messageBox.classList.remove('opacity-0', 'translate-x-full');
            messageBox.classList.add('opacity-100', 'translate-x-0');
        });

        setTimeout(() => {
            messageBox.classList.remove('opacity-100', 'translate-x-0');
            messageBox.classList.add('opacity-0', 'translate-x-full');
        }, duration);
    };

    const toggleModal = (modalElement, show) => {
        if (show) {
            modalElement.classList.remove('invisible', 'opacity-0');
            modalElement.classList.add('visible', 'opacity-100');
        } else {
            modalElement.classList.remove('visible', 'opacity-100');
            modalElement.classList.add('invisible', 'opacity-0');
        }
    };
    
    const updateCartDisplay = () => {
       const { cartCountSpan } = DOMElements;
       const mobileCartCount = document.getElementById('mobile-cart-count');
       const cartItemCount = Object.values(userCart).reduce((sum, item) => sum + item.quantity, 0);

       const updateCount = (el) => {
           if (el) {
               if (cartItemCount > 0) {
                   el.textContent = cartItemCount;
                   el.classList.remove('hidden');
               } else {
                   el.classList.add('hidden');
               }
           }
       };
       updateCount(cartCountSpan);
       updateCount(mobileCartCount);
    };

    const debounce = (func, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    };

    // APP LOGIC
    const setDarkMode = (isDark) => {
        DOMElements.html.classList.toggle('dark', isDark);
        localStorage.setItem('piecety_dark_mode', isDark);
        const icon = DOMElements.darkModeToggle.querySelector('i');
        if (icon) icon.className = isDark ? 'fas fa-sun text-xl' : 'fas fa-moon text-xl';
    };

    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem("piecety_lang", lang);
        translatePage(lang);
        updateTitle(currentView); // Update title after language change
        // Re-render current view to apply language to dynamic elements
        if (currentView) {
            renderView(currentView);
        }
    };

    const updateTitle = (view, data = null) => {
        let titleKey = "page_title";
        if (view === 'cart') titleKey = "cart_title";
        else if (view === 'dashboard') titleKey = "dashboard";
        else if (view === 'inbox' || view === 'chat') titleKey = "messages";
        
        document.title = translations[currentLang][titleKey] || "Piecety";
        document.querySelector('meta[name="description"]').setAttribute("content", translations[currentLang]["meta_description"]);
    };

    const translatePage = (lang) => {
        const { html, currentLangSpan } = DOMElements;
        
        if (lang === "ar") {
            html.setAttribute("dir", "rtl");
            html.setAttribute("lang", "ar");
        } else {
            html.setAttribute("dir", "ltr");
            html.setAttribute("lang", lang);
        }

        if (currentLangSpan) currentLangSpan.textContent = translations[lang][lang + "_short"];
        
        document.querySelectorAll("[data-i18n-key]").forEach(el => {
            const key = el.dataset.i18nKey;
            if (translations[lang] && translations[lang][key]) {
                el.innerHTML = translations[lang][key];
            }
        });

        document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
            const key = el.dataset.i18nPlaceholder;
            if (translations[lang] && translations[lang][key]) {
                el.placeholder = translations[lang][key];
            }
        });
    };


    const populateSelect = (selectEl, options, defaultLabelKey, lang, valueAsKey = false) => {
        if (!selectEl) return;
        const currentValue = selectEl.value;
        selectEl.innerHTML = "";
        const defaultText = translations[lang][defaultLabelKey] || defaultLabelKey;
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = defaultText;
        selectEl.appendChild(defaultOption);
        
        const optionData = Array.isArray(options) ? options : Object.keys(options).sort();
        
        optionData.forEach(opt => {
            const option = document.createElement('option');
            if (valueAsKey) {
                option.value = opt;
                option.textContent = options[opt][lang] || options[opt]['fr'];
            } else {
                option.value = opt;
                option.textContent = opt;
            }
            selectEl.appendChild(option);
        });
        selectEl.value = currentValue;
    };
    
    const applyAndRenderFilters = () => {
        const params = {};
        const filtersContainer = document.getElementById('filters-content') || document;
        
        filtersContainer.querySelectorAll('.filter').forEach(el => {
            const key = el.id.replace('-filter', '');
            if(el.value) {
                if (el.type === 'range' && el.value === el.max) return;
                params[key] = el.value;
            }
        });
        params.search = DOMElements.searchInput.value;

        const newUrl = new URL(window.location);
        newUrl.search = '';
        Object.keys(params).forEach(key => {
            if (params[key]) {
                newUrl.searchParams.set(key, params[key]);
            }
        });
        window.history.replaceState({path: newUrl.href}, '', newUrl.href);

        renderListings();
    };


    const applyFiltersFromURL = (container = document) => {
        const params = new URLSearchParams(window.location.search);
        params.forEach((value, key) => {
            const el = container.querySelector(`#${key}-filter`);
            if (el) {
                el.value = value;
                if (key === 'brand' || key === 'wilaya') {
                     el.dispatchEvent(new Event('change'));
                     setTimeout(() => {
                        const childKey = key === 'brand' ? 'model' : 'commune';
                        const childVal = params.get(childKey);
                        if (childVal) {
                            const childEl = container.querySelector(`#${childKey}-filter`);
                            if (childEl) childEl.value = childVal;
                        }
                     }, 100);
                }
            }
        });
        DOMElements.searchInput.value = params.get('search') || '';
    };

    // VIEW RENDERING
    const renderView = (viewName, data = null) => {
        if (productsUnsubscribe) {
            productsUnsubscribe();
            productsUnsubscribe = null;
        }
        if (chatsUnsubscribe) {
            chatsUnsubscribe();
            chatsUnsubscribe = null;
        }
        DOMElements.appContainer.innerHTML = '';
        updateTitle(viewName, data);

        const route = viewName.split('/')[0];

        switch (route) {
            case 'home':
                DOMElements.appContainer.appendChild(document.getElementById('home-view-template').content.cloneNode(true));
                renderHomePage();
                break;
            case 'product':
                DOMElements.appContainer.appendChild(document.getElementById('product-detail-view-template').content.cloneNode(true));
                renderProductPage(data);
                break;
            case 'cart':
                DOMElements.appContainer.appendChild(document.getElementById('cart-view-template').content.cloneNode(true));
                renderCartPage();
                break;
            case 'dashboard':
                DOMElements.appContainer.appendChild(document.getElementById('dashboard-view-template').content.cloneNode(true));
                renderDashboardPage();
                break;
            case 'profile':
                DOMElements.appContainer.appendChild(document.getElementById('profile-view-template').content.cloneNode(true));
                renderProfilePage(data);
                break;
            case 'inbox':
                DOMElements.appContainer.appendChild(document.getElementById('inbox-view-template').content.cloneNode(true));
                renderInboxPage();
                break;
            case 'chat':
                DOMElements.appContainer.appendChild(document.getElementById('chat-view-template').content.cloneNode(true));
                renderChatPage(data);
                break;
            default:
                renderView('home');
                break;
        }
        currentView = viewName;
        window.scrollTo(0, 0);
        translatePage(currentLang);
    };

    const renderHomePage = () => {
        const params = new URLSearchParams(window.location.search);
        const category = params.get('category');
        const brand = params.get('brand');

        updateBreadcrumb();

        if (brand) {
            renderYearCategories();
        } else if (category) {
            renderBrandCategories();
        } else {
            renderPartCategories();
        }
        
        renderRecentlyViewed();

        const setupFilters = (container) => {
            container.innerHTML = document.getElementById('filters-template').content.cloneNode(true).innerHTML;
            setupFilterListeners(container);
            applyFiltersFromURL(container);
        };

        const filtersContent = document.getElementById('filters-content');
        if (filtersContent) setupFilters(filtersContent);
        
        if (DOMElements.mobileFiltersContent) setupFilters(DOMElements.mobileFiltersContent);

        document.getElementById('show-filters-btn')?.addEventListener('click', () => {
            DOMElements.mobileFiltersModal.classList.remove('translate-x-full');
        });
        
        renderListings();
    };
    
    const updateBreadcrumb = () => {
        const breadcrumbNav = document.getElementById('breadcrumb-nav');
        if (!breadcrumbNav) return;

        const params = new URLSearchParams(window.location.search);
        const category = params.get('category');
        const brand = params.get('brand');

        let html = `<a href="#" class="hover:underline home-crumb">Home</a>`;
        if (category) {
            const categoryName = categories[category] ? categories[category][currentLang] : category;
            html += ` <span class="mx-2">/</span> <a href="#" class="hover:underline category-crumb" data-category="${category}">${categoryName}</a>`;
        }
        if (brand) {
            html += ` <span class="mx-2">/</span> <span class="font-semibold">${brand}</span>`;
        }
        breadcrumbNav.innerHTML = html;

        breadcrumbNav.querySelector('.home-crumb')?.addEventListener('click', (e) => {
            e.preventDefault();
            window.history.pushState({}, '', window.location.pathname);
            renderView('home');
        });
        breadcrumbNav.querySelector('.category-crumb')?.addEventListener('click', (e) => {
            e.preventDefault();
            const newUrl = new URL(window.location);
            newUrl.searchParams.forEach((_, key) => newUrl.searchParams.delete(key));
            newUrl.searchParams.set('category', e.target.dataset.category);
            window.history.pushState({path: newUrl.href}, '', newUrl.href);
            renderHomePage();
        });
    };

    const renderPartCategories = () => {
        const grid = document.getElementById('dynamic-grid');
        const title = document.getElementById('categories-title-heading');
        if (!grid || !title) return;

        title.textContent = translations[currentLang].categories_title;
        grid.innerHTML = '';
        for (const key in categories) {
            const cat = categories[key];
            const card = document.createElement('a');
            card.href = `?category=${key}`;
            card.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 text-center category-card";
            card.innerHTML = `
                <div class="p-4 rounded-full bg-blue-50 dark:bg-gray-700 text-blue-600 dark:text-blue-400 mx-auto w-16 h-16 flex items-center justify-center mb-2 category-icon">
                    <i class="fas ${cat.icon} text-3xl"></i>
                </div>
                <h3 class="font-semibold text-sm md:text-base">${cat[currentLang]}</h3>
            `;
            card.addEventListener('click', (e) => {
                e.preventDefault();
                const newUrl = new URL(window.location);
                newUrl.searchParams.forEach((_, key) => newUrl.searchParams.delete(key));
                newUrl.searchParams.set('category', key);
                window.history.pushState({path: newUrl.href}, '', newUrl.href);
                renderHomePage();
            });
            grid.appendChild(card);
        }
    };

    const renderBrandCategories = () => {
        const grid = document.getElementById('dynamic-grid');
        const title = document.getElementById('categories-title-heading');
        if (!grid || !title) return;

        title.textContent = translations[currentLang].brands_title;
        grid.innerHTML = '';
        const params = new URLSearchParams(window.location.search);
        const category = params.get('category');

        for (const brandName in car_data) {
            const card = document.createElement('a');
            card.href = `?category=${category}&brand=${brandName}`;
            card.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 text-center category-card flex flex-col items-center justify-center";
            card.innerHTML = `
                <img src="${brand_icons[brandName] || 'icons/car-192.png'}" alt="${brandName}" class="h-16 object-contain mb-2" onerror="this.onerror=null; this.src='icons/car-192.png'">
                <h3 class="font-semibold text-sm md:text-base">${brandName}</h3>
            `;
            card.addEventListener('click', (e) => {
                e.preventDefault();
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('brand', brandName);
                window.history.pushState({path: newUrl.href}, '', newUrl.href);
                renderHomePage();
            });
            grid.appendChild(card);
        }
    };

    const renderYearCategories = () => {
        const grid = document.getElementById('dynamic-grid');
        const title = document.getElementById('categories-title-heading');
        if (!grid || !title) return;

        title.textContent = translations[currentLang].years_title;
        grid.innerHTML = '';
        
        years.forEach(year => {
            const card = document.createElement('button');
            card.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 text-center category-card font-semibold";
            card.textContent = year;
            card.addEventListener('click', () => {
                const yearFilterDesktop = document.querySelector('#filters-content #year-filter');
                const yearFilterMobile = document.querySelector('#mobile-filters-content #year-filter');
                if(yearFilterDesktop) yearFilterDesktop.value = year;
                if(yearFilterMobile) yearFilterMobile.value = year;
                
                applyAndRenderFilters();
                document.getElementById('listings-section').scrollIntoView({ behavior: 'smooth' });
            });
            grid.appendChild(card);
        });
    };

    const setupFilterListeners = (container = document) => {
        const debouncedApplyAndRender = debounce(applyAndRenderFilters, 300);

        const brandFilter = container.querySelector('#brand-filter');
        if(brandFilter) {
            brandFilter.addEventListener('change', () => {
                const modelFilterContainer = container.querySelector('#model-filter-container');
                const modelFilter = container.querySelector('#model-filter');
                const selectedBrand = brandFilter.value;
                if (selectedBrand && car_data[selectedBrand]) {
                    populateSelect(modelFilter, car_data[selectedBrand], 'all_models', currentLang);
                    modelFilterContainer.classList.remove('hidden');
                } else {
                    modelFilterContainer.classList.add('hidden');
                    if(modelFilter) modelFilter.value = '';
                }
                debouncedApplyAndRender();
            });
        }
        
        const wilayaFilter = container.querySelector('#wilaya-filter');
        if(wilayaFilter) {
            wilayaFilter.addEventListener('change', () => {
                const communeFilterContainer = container.querySelector('#commune-filter-container');
                const communeFilter = container.querySelector('#commune-filter');
                const selectedWilaya = wilayaFilter.value;
                if (selectedWilaya && wilayas[selectedWilaya]) {
                    populateSelect(communeFilter, wilayas[selectedWilaya], 'all_communes', currentLang);
                    communeFilterContainer.classList.remove('hidden');
                } else {
                    communeFilterContainer.classList.add('hidden');
                    if(communeFilter) communeFilter.value = '';
                }
                debouncedApplyAndRender();
            });
        }
        
        const priceFilter = container.querySelector('#price-range-filter');
        if (priceFilter) {
            priceFilter.addEventListener('input', () => {
                const priceValue = container.querySelector('#price-range-value');
                if(priceValue) priceValue.textContent = `${Number(priceFilter.value).toLocaleString()} DA`;
            });
            priceFilter.addEventListener('change', debouncedApplyAndRender);
        }

        container.querySelectorAll('.filter').forEach(el => {
            if (el.id !== 'brand-filter' && el.id !== 'wilaya-filter' && el.id !== 'price-range-filter') {
                el.addEventListener('change', debouncedApplyAndRender);
            }
        });
        
        const resetBtn = container.querySelector('#filter-reset-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                window.history.pushState({}, '', window.location.pathname);
                renderView('home');
            });
        }

        populateSelect(brandFilter, car_data, 'all_brands', currentLang);
        populateSelect(container.querySelector('#year-filter'), years, 'all_years', currentLang);
        populateSelect(wilayaFilter, wilayas, 'all_wilayas', currentLang);
        populateSelect(container.querySelector('#category-filter'), categories, 'all_categories', currentLang, true);
    };

    const renderListings = (loadMore = false) => {
        const listingsSection = document.getElementById('listings-section');
        const loadMoreContainer = document.getElementById('load-more-container');
        if (!listingsSection || isFetching) return;

        isFetching = true;
        if (!loadMore) {
            listingsSection.innerHTML = `<div class="col-span-full text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>`;
            lastVisibleProduct = null; 
        }
        if (loadMoreContainer) loadMoreContainer.innerHTML = '';

        const params = new URLSearchParams(window.location.search);
        const productsRef = collection(db, "products");
        
        let q = query(productsRef);

        if (params.get('category')) q = query(q, where("category", "==", params.get('category')));
        if (params.get('brand')) q = query(q, where("brand", "==", params.get('brand')));
        if (params.get('year')) q = query(q, where("year", "==", params.get('year')));
        if (params.get('wilaya')) q = query(q, where("wilaya", "==", params.get('wilaya')));
        if (params.get('condition')) q = query(q, where("condition", "==", params.get('condition')));
        
        q = query(q, orderBy("createdAt", "desc"));

        if (loadMore && lastVisibleProduct) {
            q = query(q, startAfter(lastVisibleProduct));
        }
        q = query(q, limit(12));

        getDocs(q).then(querySnapshot => {
            if (!loadMore) listingsSection.innerHTML = '';

            if (querySnapshot.empty && !loadMore) {
                listingsSection.innerHTML = `<p class="col-span-full text-center p-8 text-lg text-gray-500" data-i18n-key="no_listings"></p>`;
            } else {
                displayProducts(querySnapshot.docs, listingsSection, loadMore);
                lastVisibleProduct = querySnapshot.docs[querySnapshot.docs.length - 1];

                if (querySnapshot.docs.length === 12 && loadMoreContainer) {
                    const loadMoreBtn = document.createElement('button');
                    loadMoreBtn.className = "px-6 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors";
                    loadMoreBtn.setAttribute('data-i18n-key', 'load_more');
                    loadMoreBtn.onclick = () => renderListings(true);
                    loadMoreContainer.appendChild(loadMoreBtn);
                }
            }
            isFetching = false;
            translatePage(currentLang);
        }).catch(error => {
            console.error("Error fetching products:", error);
            listingsSection.innerHTML = `<p class="col-span-full text-center text-red-500">Error loading products.</p>`;
            isFetching = false;
        });
    };
    
    const displayProducts = (docs, container, append = false) => {
        if (!container) return;
        if (!append) container.innerHTML = '';
        if (docs.length === 0 && !append) {
            container.innerHTML = `<p class="col-span-full text-center p-8 text-lg text-gray-500" data-i18n-key="no_listings"></p>`;
            return;
        }
        docs.forEach(doc => {
            const product = { id: doc.id, ...doc.data() };
            const card = document.createElement('div');
            card.className = "listing-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden flex flex-col";
            const isMyProduct = currentUser && currentUser.uid === product.sellerId;
            card.innerHTML = `
                <div class="relative">
                    <img src="${product.imageUrl || 'https://via.placeholder.com/300x200.png?text=Piecety'}" alt="${product.title}" class="w-full h-40 object-cover cursor-pointer product-image">
                </div>
                <div class="p-4 flex flex-col flex-grow">
                    <h3 class="font-bold text-lg truncate product-title cursor-pointer">${product.title}</h3>
                    <p class="text-blue-600 dark:text-blue-400 font-semibold text-xl my-2">${product.price.toLocaleString()} DA</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4"><i class="fas fa-map-marker-alt mr-1"></i> ${product.wilaya}${product.commune ? `, ${product.commune}` : ''}</p>
                    <div class="mt-auto">
                        ${!isMyProduct ? `<button class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-sm rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 chat-btn"><i class="fas fa-comments"></i> <span data-i18n-key="chat"></span></button>` : ''}
                    </div>
                </div>
            `;
            card.querySelector('.product-image').addEventListener('click', () => renderView('product', product));
            card.querySelector('.product-title').addEventListener('click', () => renderView('product', product));
            if (!isMyProduct) {
                card.querySelector('.chat-btn').addEventListener('click', () => startOrOpenChat(product.sellerId, product.sellerName));
            }
            container.appendChild(card);
        });
    };

    const renderProductPage = async (product) => {
        if (!product) { renderView('home'); return; }

        let updatedRecentlyViewed = recentlyViewed.filter(id => id !== product.id);
        updatedRecentlyViewed.unshift(product.id);
        if (updatedRecentlyViewed.length > 4) {
            updatedRecentlyViewed.pop();
        }
        recentlyViewed = updatedRecentlyViewed;
        localStorage.setItem('piecety_recently_viewed', JSON.stringify(recentlyViewed));
        
        document.getElementById('product-title-detail').textContent = product.title;
        document.getElementById('product-price-detail').textContent = `${product.price.toLocaleString()} DA`;
        document.getElementById('product-image-detail').src = product.imageUrl || 'https://via.placeholder.com/600x400.png?text=Piecety';
        document.getElementById('product-image-detail').alt = product.title;
        document.getElementById('product-brand-detail').textContent = product.brand;
        document.getElementById('product-model-detail').textContent = product.model || 'N/A';
        document.getElementById('product-year-detail').textContent = product.year || 'N/A';
        document.getElementById('product-wilaya-detail').textContent = product.wilaya;
        document.getElementById('product-commune-detail').textContent = product.commune || 'N/A';
        document.getElementById('product-description-detail').textContent = product.description || 'No description available.';

        const sellerLink = document.getElementById('seller-profile-link');
        sellerLink.textContent = product.sellerName || 'Anonymous';
        sellerLink.addEventListener('click', (e) => {
            e.preventDefault();
            renderView('profile', { userId: product.sellerId, userName: product.sellerName });
        });

        document.getElementById('back-to-listings-btn').addEventListener('click', () => {
            window.history.back();
        });
        document.getElementById('add-to-cart-btn').addEventListener('click', () => addToCart(product));
        document.getElementById('contact-seller-btn').addEventListener('click', () => {
            startOrOpenChat(product.sellerId, product.sellerName);
        });
    };

    const renderRecentlyViewed = async () => {
        const section = document.getElementById('recently-viewed-section');
        const grid = document.getElementById('recently-viewed-grid');
        if (!section || !grid || recentlyViewed.length === 0) return;

        section.classList.remove('hidden');
        grid.innerHTML = '';
        
        const productsRef = collection(db, "products");
        const q = query(productsRef, where("__name__", "in", recentlyViewed));
        const querySnapshot = await getDocs(q);
        
        const viewedProducts = [];
        querySnapshot.forEach(doc => {
            viewedProducts.push({ id: doc.id, ...doc.data() });
        });

        const sorted = recentlyViewed.map(id => viewedProducts.find(p => p.id === id)).filter(Boolean);
        displayProducts(sorted.map(p => ({ ...p, data: () => p })), grid);
    };

    const renderCartPage = async () => {
        if (!currentUser) {
            showMessage('login_required', 3000, 'error');
            renderView('home');
            return;
        }
        const container = document.getElementById('cart-items-container');
        const summary = document.getElementById('cart-summary');
        container.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>`;

        const cartItems = Object.values(userCart);

        if (cartItems.length === 0) {
            container.innerHTML = `<p class="text-center p-8 text-lg text-gray-500" data-i18n-key="your_cart_is_empty"></p>`;
            summary.classList.add('hidden');
            translatePage(currentLang);
            return;
        } 
        
        summary.classList.remove('hidden');
        const productIds = cartItems.map(item => item.productId);
        const productsRef = collection(db, "products");
        const q = query(productsRef, where("__name__", "in", productIds));
        const querySnapshot = await getDocs(q);

        const productsById = {};
        querySnapshot.forEach(doc => {
            productsById[doc.id] = { id: doc.id, ...doc.data() };
        });

        let totalPrice = 0;
        container.innerHTML = '';
        cartItems.forEach(item => {
            const product = productsById[item.productId];
            if (product) {
                totalPrice += product.price * item.quantity;
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg';
                itemEl.innerHTML = `
                    <div class="flex items-center">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/100'}" alt="${product.title}" class="w-16 h-16 object-cover rounded-md mr-4">
                        <div>
                            <h4 class="font-semibold">${product.title}</h4>
                            <p class="text-sm text-gray-500">${product.price.toLocaleString()} DA</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <input type="number" min="1" value="${item.quantity}" class="w-16 p-1 border rounded-md dark:bg-gray-600 quantity-input" data-id="${product.id}">
                        <button class="text-red-500 hover:text-red-700 remove-btn" data-id="${product.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(itemEl);
            }
        });
        document.getElementById('cart-total-price').textContent = `${totalPrice.toLocaleString()} DA`;

        container.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', (e) => updateCartItem(e.target.dataset.id, parseInt(e.target.value)));
        });
        container.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', (e) => removeFromCart(e.currentTarget.dataset.id));
        });
        document.getElementById('back-from-cart-btn').addEventListener('click', () => renderView('home'));
        document.getElementById('clear-cart-btn').addEventListener('click', clearCart);
    };
    
    const renderDashboardPage = async () => {
         if (!currentUser) { renderView('home'); return; }
        const grid = document.getElementById('my-listings-grid');
        grid.innerHTML = `<div class="col-span-full text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>`;

        const q = query(collection(db, "products"), where("sellerId", "==", currentUser.uid));
        const querySnapshot = await getDocs(q);
        const userProducts = [];
        querySnapshot.forEach(doc => userProducts.push({ id: doc.id, ...doc.data() }));

        grid.innerHTML = '';
        if (userProducts.length === 0) {
            grid.innerHTML = `<p class="col-span-full text-center p-8 text-lg text-gray-500">You have no active listings.</p>`;
        } else {
            userProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = "relative bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden";
                card.innerHTML = `
                    <img src="${product.imageUrl || 'https://via.placeholder.com/300x200.png?text=Piecety'}" alt="${product.title}" class="w-full h-40 object-cover">
                    <div class="p-4">
                        <h3 class="font-bold text-lg truncate">${product.title}</h3>
                        <p class="text-blue-600 dark:text-blue-400 font-semibold text-xl my-2">${product.price.toLocaleString()} DA</p>
                    </div>
                    <div class="absolute top-2 right-2 flex gap-2">
                        <button class="delete-ad-btn bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                card.querySelector('.delete-ad-btn').addEventListener('click', async () => {
                    if (confirm(translations[currentLang].delete_ad_confirm)) {
                        await deleteDoc(doc(db, "products", product.id));
                        renderDashboardPage();
                    }
                });
                grid.appendChild(card);
            });
        }
    };
    
    const renderProfilePage = async (data) => {
        if (!data || !data.userId) { renderView('home'); return; }
        document.getElementById('profile-name').textContent = data.userName || 'Seller Profile';
        
        const grid = document.getElementById('user-products-grid');
        grid.innerHTML = `<div class="col-span-full text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>`;
        
        const q = query(collection(db, "products"), where("sellerId", "==", data.userId));
        const querySnapshot = await getDocs(q);
        const userProducts = [];
        querySnapshot.forEach(doc => userProducts.push({ id: doc.id, ...doc.data() }));
        
        displayProducts(userProducts.map(p => ({ ...p, data: () => p })), grid);
    };

    const startOrOpenChat = async (sellerId, sellerName) => {
        if (!currentUser) {
            showMessage('login_required', 3000, 'error');
            return;
        }
        if (currentUser.uid === sellerId) {
            showMessage("You cannot message yourself.", 3000, 'error');
            return;
        }

        const chatId = [currentUser.uid, sellerId].sort().join('_');
        const chatRef = doc(db, "chats", chatId);
        
        try {
            const chatSnap = await getDoc(chatRef);
            if (!chatSnap.exists()) {
                await setDoc(chatRef, {
                    participants: [currentUser.uid, sellerId],
                    participantNames: [currentUser.displayName, sellerName],
                    lastMessage: "Chat started.",
                    lastMessageTimestamp: serverTimestamp(),
                    unreadCount: { [currentUser.uid]: 0, [sellerId]: 0 }
                });
            }
            renderView('chat', { chatId, otherUserName: sellerName });
        } catch (error) {
            console.error("Error starting chat:", error);
            showMessage("Could not open chat.", 3000, 'error');
        }
    };

    const renderInboxPage = () => {
        if (!currentUser) {
            renderView('home');
            return;
        }
        const listContainer = document.getElementById('conversations-list');
        const q = query(
            collection(db, "chats"), 
            where("participants", "array-contains", currentUser.uid),
            orderBy("lastMessageTimestamp", "desc")
        );

        chatsUnsubscribe = onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                listContainer.innerHTML = `<p class="text-center text-gray-500">You have no messages.</p>`;
                return;
            }
            listContainer.innerHTML = '';
            snapshot.forEach(doc => {
                const chat = doc.data();
                const otherUserIndex = chat.participants.indexOf(currentUser.uid) === 0 ? 1 : 0;
                const otherUserName = chat.participantNames[otherUserIndex];
                
                const convoEl = document.createElement('div');
                convoEl.className = 'p-4 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 flex justify-between items-center';
                convoEl.innerHTML = `
                    <div>
                        <h4 class="font-bold">${otherUserName}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${chat.lastMessage}</p>
                    </div>
                    ${chat.unreadCount && chat.unreadCount[currentUser.uid] > 0 ? 
                        `<span class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${chat.unreadCount[currentUser.uid]}</span>` : ''
                    }
                `;
                convoEl.addEventListener('click', () => renderView('chat', { chatId: doc.id, otherUserName }));
                listContainer.appendChild(convoEl);
            });
        });
    };

    let messagesListener = null;

    const renderChatPage = async (chatData) => {
        if (!currentUser || !chatData) {
            renderView('home');
            return;
        }
        
        const { chatId, otherUserName } = chatData;
        
        const chatRef = doc(db, "chats", chatId);
        await updateDoc(chatRef, { [`unreadCount.${currentUser.uid}`]: 0 });

        document.getElementById('chat-with-name').textContent = `${translations[currentLang].chat_with} ${otherUserName}`;
        document.getElementById('back-to-inbox-btn').addEventListener('click', () => renderView('inbox'));

        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('send-message-form');
        const messageInput = document.getElementById('message-input');
        
        const messagesRef = collection(db, "chats", chatId, "messages");
        const q = query(messagesRef, orderBy("timestamp", "desc"), limit(25));

        if(messagesListener) messagesListener();

        messagesListener = onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                messagesContainer.innerHTML = '<p class="text-center text-gray-500">No messages yet. Say hi!</p>';
                return;
            }
            
            messagesContainer.innerHTML = '';
            snapshot.docs.reverse().forEach(doc => {
                const msg = doc.data();
                const msgEl = document.createElement('div');
                const isMe = msg.senderId === currentUser.uid;
                
                msgEl.className = `p-3 rounded-lg max-w-xs ${isMe ? 'bg-blue-500 text-white self-end' : 'bg-gray-200 dark:bg-gray-600 self-start'}`;
                msgEl.textContent = msg.text;
                messagesContainer.appendChild(msgEl);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        messageForm.onsubmit = async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text) {
                messageInput.value = '';
                await addDoc(messagesRef, {
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: serverTimestamp()
                });

                const otherUserId = chatId.replace(currentUser.uid, '').replace('_', '');
                await updateDoc(chatRef, { 
                    lastMessage: text, 
                    lastMessageTimestamp: serverTimestamp(),
                    [`unreadCount.${otherUserId}`]: increment(1)
                });
            }
        };
    };


    // USER ACTIONS
    const handleSignOut = () => {
        signOut(auth).catch(error => console.error("Sign out error", error));
    };
    
    const clearCart = async () => {
        if (!currentUser) return;
        const cartRef = doc(db, "carts", currentUser.uid);
        await setDoc(cartRef, {});
        userCart = {};
        updateCartDisplay();
        if(currentView === 'cart') renderCartPage();
    };

    const addToCart = async (product) => {
        if (!currentUser) { showMessage('login_required', 3000, 'error'); return; }
        const cartRef = doc(db, "carts", currentUser.uid);
        
        const currentQuantity = userCart[product.id] ? userCart[product.id].quantity : 0;
        
        userCart[product.id] = { productId: product.id, quantity: currentQuantity + 1 };
        
        await setDoc(cartRef, userCart);
        updateCartDisplay();
        showMessage('item_added_to_cart', 2000, 'success');
    };
    
    const updateCartItem = async (productId, quantity) => {
        if (!currentUser || !userCart[productId]) return;
        if (quantity <= 0) {
            removeFromCart(productId);
            return;
        }
        userCart[productId].quantity = quantity;
        const cartRef = doc(db, "carts", currentUser.uid);
        await setDoc(cartRef, userCart);
        updateCartDisplay();
        if (currentView === 'cart') renderCartPage();
    };
    
    const removeFromCart = async (productId) => {
        if (!currentUser || !userCart[productId]) return;
        delete userCart[productId];
        const cartRef = doc(db, "carts", currentUser.uid);
        await setDoc(cartRef, userCart);
        updateCartDisplay();
        if (currentView === 'cart') renderCartPage();
    };

    const validatePostForm = (form) => {
        let isValid = true;
        const requiredFields = ['title', 'brand', 'wilaya', 'category', 'price'];
        requiredFields.forEach(fieldName => {
            const input = form.elements[fieldName];
            const errorEl = document.getElementById(`${fieldName}-error`);
            if (!input.value) {
                input.classList.add('border-red-500');
                if (errorEl) errorEl.classList.remove('hidden');
                isValid = false;
            } else {
                input.classList.remove('border-red-500');
                if (errorEl) errorEl.classList.add('hidden');
            }
        });
        return isValid;
    };
    
    const updateAuthUI = (user) => {
        const { authLinksContainer, mobileNavLinks } = DOMElements;
        authLinksContainer.innerHTML = '';
        mobileNavLinks.innerHTML = '';
        
        mobileNavLinks.innerHTML += `<a href="#" id="mobile-sell-link" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 text-lg" data-i18n-key="sell"></a>`;
        mobileNavLinks.innerHTML += `<a href="#" id="mobile-cart-link" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 text-lg relative">
            <span data-i18n-key="cart_title"></span>
            <span id="mobile-cart-count" class="absolute top-0 ml-2 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full hidden">0</span>
        </a>`;

        document.getElementById('mobile-sell-link').addEventListener('click', (e) => {
            e.preventDefault();
            DOMElements.mobileMenu.classList.add('hidden');
            DOMElements.sellLink.click();
        });
        document.getElementById('mobile-cart-link').addEventListener('click', (e) => {
            e.preventDefault();
            DOMElements.mobileMenu.classList.add('hidden');
            DOMElements.cartBtn.click();
        });

        if (user) {
            const userMenuHTML = `
                <div class="relative" id="user-menu">
                    <button id="user-menu-btn" class="flex items-center">
                        <img src="${user.photoURL}" alt="User" class="w-8 h-8 rounded-full">
                    </button>
                    <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-lg shadow-lg py-1 hidden z-20">
                        <a href="#" id="dashboard-link" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600" data-i18n-key="dashboard"></a>
                        <a href="#" id="messages-link" class="relative block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600" data-i18n-key="messages"><span id="unread-badge" class="hidden absolute right-2 top-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center"></span></a>
                        <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600" data-i18n-key="logout"></button>
                    </div>
                </div>`;
            authLinksContainer.innerHTML = userMenuHTML;

            mobileNavLinks.innerHTML += `<a href="#" id="mobile-dashboard-link" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 text-lg" data-i18n-key="dashboard"></a>`;
            mobileNavLinks.innerHTML += `<a href="#" id="mobile-messages-link" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 text-lg relative"><span data-i18n-key="messages"></span> <span id="mobile-unread-badge" class="hidden absolute top-0 ml-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center"></span></a>`;
            mobileNavLinks.innerHTML += `<button id="mobile-logout-btn" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 text-lg text-left" data-i18n-key="logout"></button>`;

            document.getElementById('user-menu-btn').addEventListener('click', () => {
                document.getElementById('user-menu-dropdown').classList.toggle('hidden');
            });
            document.getElementById('logout-btn').addEventListener('click', handleSignOut);
            document.getElementById('dashboard-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('user-menu-dropdown').classList.add('hidden');
                renderView('dashboard');
            });
            document.getElementById('messages-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('user-menu-dropdown').classList.add('hidden');
                renderView('inbox');
            });
            document.getElementById('mobile-logout-btn').addEventListener('click', handleSignOut);
            document.getElementById('mobile-dashboard-link').addEventListener('click', (e) => {
                e.preventDefault();
                DOMElements.mobileMenu.classList.add('hidden');
                renderView('dashboard');
            });
            document.getElementById('mobile-messages-link').addEventListener('click', (e) => {
                e.preventDefault();
                DOMElements.mobileMenu.classList.add('hidden');
                renderView('inbox');
            });

        } else {
            authLinksContainer.innerHTML = `<button id="login-btn" class="px-4 py-2 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors" data-i18n-key="connect"></button>`;
            
            mobileNavLinks.innerHTML += `<button id="mobile-login-btn" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 text-lg text-left" data-i18n-key="connect"></button>`;
            
            document.getElementById('login-btn').addEventListener('click', () => toggleModal(DOMElements.authModal, true));
            document.getElementById('mobile-login-btn').addEventListener('click', () => {
                 DOMElements.mobileMenu.classList.add('hidden');
                 toggleModal(DOMElements.authModal, true)
            });
        }
        updateCartDisplay();
        translatePage(currentLang);
    };

    const listenForUnreadMessages = (user) => {
        if (chatsUnsubscribe) chatsUnsubscribe();
        if (!user) {
            updateUnreadBadge(0);
            return;
        }

        const q = query(
            collection(db, "chats"),
            where("participants", "array-contains", user.uid)
        );

        chatsUnsubscribe = onSnapshot(q, (snapshot) => {
            let totalUnread = 0;
            snapshot.forEach(doc => {
                const chat = doc.data();
                if (chat.unreadCount && chat.unreadCount[user.uid]) {
                    totalUnread += chat.unreadCount[user.uid];
                }
            });
            updateUnreadBadge(totalUnread);
        });
    };

    const updateUnreadBadge = (count) => {
        const badge = document.getElementById('unread-badge');
        const mobileBadge = document.getElementById('mobile-unread-badge');
        const navBadge = document.getElementById('nav-unread-badge');

        const update = (el) => {
            if(el) {
                if (count > 0) {
                    el.textContent = count > 9 ? '9+' : count;
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            }
        };
        update(badge);
        update(mobileBadge);
        update(navBadge);
    };


    // SETUP & INITIALIZATION
    const setupEventListeners = () => {
        const { darkModeToggle, langDropdownBtn, langDropdown, langBtns, sellLink, authModal, cartBtn, homeLink, mobileMenuBtn, mobileMenu, mobileMenuCloseBtn, authModalCloseBtn, googleLoginBtn, postProductModal, modalCloseBtn, searchInput, mobileFiltersModal, mobileFiltersCloseBtn, mobileApplyFiltersBtn } = DOMElements;

        darkModeToggle.addEventListener('click', () => {
            setDarkMode(!DOMElements.html.classList.contains('dark'));
        });

        langDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            langDropdown.classList.toggle('hidden');
        });

        langBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                setLanguage(btn.getAttribute('data-lang'));
                langDropdown.classList.add('hidden');
                mobileMenu.classList.add('hidden');
            });
        });

        sellLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUser) {
                toggleModal(postProductModal, true);
            } else {
                toggleModal(authModal, true);
            }
        });

        cartBtn.addEventListener('click', () => renderView('cart'));
        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            window.history.pushState({}, '', window.location.pathname);
            renderView('home');
        });

        mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
        mobileMenuCloseBtn.addEventListener('click', () => mobileMenu.classList.add('hidden'));

        authModalCloseBtn.addEventListener('click', () => toggleModal(authModal, false));
        modalCloseBtn.addEventListener('click', () => toggleModal(postProductModal, false));

        googleLoginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => console.error("Login error", error));
        });

        DOMElements.postProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validatePostForm(e.target) || !currentUser) return;
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.querySelector('.btn-text').textContent = translations[currentLang].loading_text;
            btn.querySelector('.btn-spinner').classList.remove('hidden');

            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData.entries());
            productData.price = Number(productData.price);
            productData.sellerId = currentUser.uid;
            productData.sellerName = currentUser.displayName;
            productData.createdAt = serverTimestamp();

            try {
                await addDoc(collection(db, "products"), productData);
                showMessage('ad_posted', 3000, 'success');
                e.target.reset();
                toggleModal(postProductModal, false);
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage('ad_post_failed', 3000, 'error');
            } finally {
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = translations[currentLang].submit_ad_btn_text;
                btn.querySelector('.btn-spinner').classList.add('hidden');
            }
        });

        searchInput.addEventListener('input', debounce(applyAndRenderFilters, 500));
        
        mobileFiltersCloseBtn.addEventListener('click', () => mobileFiltersModal.classList.add('translate-x-full'));
        mobileApplyFiltersBtn.addEventListener('click', () => {
            applyAndRenderFilters();
            mobileFiltersModal.classList.add('translate-x-full');
        });

        document.addEventListener('click', (e) => {
            if (!langDropdownBtn.contains(e.target)) {
                langDropdown.classList.add('hidden');
            }
            const userMenu = document.getElementById('user-menu');
            if(userMenu && !userMenu.contains(e.target)) {
                document.getElementById('user-menu-dropdown').classList.add('hidden');
            }
        });
        
        populateSelect(DOMElements.postProductBrandSelect, car_data, 'select_brand', currentLang);
        populateSelect(DOMElements.postProductYearSelect, years, 'select_year', currentLang);
        populateSelect(DOMElements.postProductWilayaSelect, wilayas, 'select_wilaya', currentLang);
        populateSelect(DOMElements.postProductCategorySelect, categories, 'select_category', currentLang, true);
        DOMElements.postProductBrandSelect.addEventListener('change', (e) => {
             const brand = e.target.value;
             if (brand && car_data[brand]) {
                populateSelect(DOMElements.postProductModelSelect, car_data[brand], 'select_model', currentLang);
                DOMElements.postProductModelSelect.disabled = false;
             } else {
                DOMElements.postProductModelSelect.disabled = true;
             }
        });
         DOMElements.postProductWilayaSelect.addEventListener('change', (e) => {
             const wilaya = e.target.value;
             if (wilaya && wilayas[wilaya]) {
                populateSelect(DOMElements.postProductCommuneSelect, wilayas[wilaya], 'select_commune', currentLang);
                DOMElements.postProductCommuneSelect.disabled = false;
             } else {
                DOMElements.postProductCommuneSelect.disabled = true;
             }
        });

        // Bottom Nav Listeners
        document.getElementById('nav-home').addEventListener('click', (e) => { e.preventDefault(); renderView('home'); });
        document.getElementById('nav-search').addEventListener('click', (e) => { e.preventDefault(); DOMElements.searchInput.focus(); });
        document.getElementById('nav-sell').addEventListener('click', (e) => { e.preventDefault(); DOMElements.sellLink.click(); });
        document.getElementById('nav-messages').addEventListener('click', (e) => { e.preventDefault(); renderView('inbox'); });
        document.getElementById('nav-profile').addEventListener('click', (e) => { e.preventDefault(); if(currentUser) { renderView('dashboard'); } else { toggleModal(DOMElements.authModal, true); } });
    };

    const bootApp = () => {
        setDarkMode(localStorage.getItem('piecety_dark_mode') === 'true');
        document.getElementById('current-year').textContent = new Date().getFullYear();
        setupEventListeners();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service worker registered successfully.'))
            .catch(err => console.error('Service worker registration failed:', err));
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            updateAuthUI(user);
            listenForUnreadMessages(user);

            if (user) {
                toggleModal(DOMElements.authModal, false);
                const cartRef = doc(db, "carts", user.uid);
                const cartSnap = await getDoc(cartRef);
                if (cartSnap.exists()) {
                    userCart = cartSnap.data();
                } else {
                    userCart = {};
                }
            } else {
                userCart = {};
            }
            updateCartDisplay();
        });
        
        window.addEventListener('popstate', () => {
            renderView('home'); 
        });
        renderView('home');
    };

    bootApp();
</script>
</body>
</html>
